const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/AddFriendDialog-B3U3Vxp1.js","assets/index-DAJwJefL.js","assets/index-BPjlgROr.css","assets/QItem-CUYqEEm-.js","assets/QList-DEJqbsUR.js"])))=>i.map(i=>d[i]);
import{a as x,y as q,o as i,Q as ee,h as b,f as u,l as se,g as h,ay as te,e as c,t as y,ax as w,j as ye,_ as ne,aG as he,p as C,F as G,D as I,z as T,ab as $e,aH as _e,C as F,v as be,az as qe,A as re,r as P,w as E,u as ke,x as Z,S as Ae,q as f,m as Ce,aI as we,k as Fe,aJ as Ge}from"./index-DAJwJefL.js";import{a as K,Q as xe}from"./QTabs-BCYOsE7G.js";import{a as X,Q as Se}from"./QTabPanels-Dxf0WCW3.js";import{Q as Pe}from"./QPage-CFkC8b5M.js";import{u as Qe}from"./auth-store-DgD84Utc.js";import{u as Re}from"./useFriends-CA-dfWHc.js";import{Q as Be}from"./QBadge-0NOA8KjT.js";import{Q as De}from"./QSlideTransition-DT7b1oa2.js";import{u as Ie}from"./useGroups-B8XyLYyZ.js";import"./QResizeObserver-BB1nRIh9.js";import"./rtl-DFPa-2ov.js";import"./touch-BjYP5sR0.js";import"./selection-kbekTKEE.js";import"./supabase-C5qut0hh.js";const Ee={class:"row items-center q-gutter-md"},Te=["src"],Ve={key:1},ze={class:"friend-info flex-1"},Oe={class:"row items-center q-gutter-sm"},Ne={class:"text-h6 friend-name"},Le={key:0,class:"text-subtitle2 text-grey-6"},Ue=x({__name:"FriendCard",props:{friend:{},friendshipId:{}},setup($){const n=$,o=ye(),t=()=>{o.push(`/app/friend/${n.friend.id}`)},l=e=>e.name&&e.surname?`${e.name} ${e.surname}`:e.username||e.email,A=e=>e.name&&e.surname?`${e.name.charAt(0)}${e.surname.charAt(0)}`:e.username?e.username.charAt(0).toUpperCase():e.email.charAt(0).toUpperCase();return(e,d)=>(i(),q(ee,{class:"friend-card",onClick:t},{default:b(()=>[u(se,{class:"friend-card-content"},{default:b(()=>[h("div",Ee,[u(te,{size:"50px",color:"primary","text-color":"white"},{default:b(()=>[e.friend.avatar_url?(i(),c("img",{key:0,src:e.friend.avatar_url},null,8,Te)):(i(),c("span",Ve,y(A(e.friend)),1))]),_:1}),h("div",ze,[h("div",Oe,[h("div",Ne,y(l(e.friend)),1),e.friend.is_dummy?(i(),q(Be,{key:0,color:"orange",label:e.$t("dummyProfiles.dummy"),rounded:""},null,8,["label"])):w("",!0)]),e.friend.username?(i(),c("div",Le," @"+y(e.friend.username),1)):w("",!0)])])]),_:1})]),_:1}))}}),ae=ne(Ue,[["__scopeId","data-v-6bd1fc51"]]),je={class:"row items-center q-gutter-sm q-mb-md"},Je={class:"col-grow text-h6"},Me=x({__name:"FriendsToolbar",props:{title:{},groupByGroups:{type:Boolean},hasGroups:{type:Boolean}},emits:["update:group-by-groups","add-friend","collapse-all","expand-all"],setup($){return(n,o)=>(i(),c("div",je,[h("div",Je,y(n.title),1),n.hasGroups?(i(),q(he,{key:0,size:"sm","model-value":n.groupByGroups,label:n.$t("friends.groupByGroups"),"onUpdate:modelValue":o[0]||(o[0]=t=>n.$emit("update:group-by-groups",t))},null,8,["model-value","label"])):w("",!0),n.groupByGroups?(i(),q(C,{key:1,size:"sm",flat:"",dense:"",icon:"unfold_less",label:n.$t("friends.collapseAll"),onClick:o[1]||(o[1]=t=>n.$emit("collapse-all"))},null,8,["label"])):w("",!0),n.groupByGroups?(i(),q(C,{key:2,size:"sm",flat:"",dense:"",icon:"unfold_more",label:n.$t("friends.expandAll"),onClick:o[2]||(o[2]=t=>n.$emit("expand-all"))},null,8,["label"])):w("",!0),u(C,{color:"primary",dense:"",unelevated:"",icon:"person_add",label:n.$t("friends.addFriend"),onClick:o[3]||(o[3]=t=>n.$emit("add-friend"))},null,8,["label"])]))}}),He=["onClick"],Ye={class:"text-subtitle2"},Ze={class:"row q-gutter-sm"},Ke=x({__name:"GroupedFriendsList",props:{groups:{},expanded:{},friendshipIdByUserId:{}},emits:["toggle-group"],setup($){return(n,o)=>(i(),c("div",null,[(i(!0),c(G,null,I(n.groups,t=>(i(),c("div",{key:t.id||"ungrouped",class:"q-mb-md"},[h("div",{class:"row items-center cursor-pointer q-mb-xs",onClick:l=>n.$emit("toggle-group",t.id)},[u(T,{size:"sm",name:n.expanded[t.id||"ungrouped"]?"expand_more":"chevron_right",class:"q-mr-xs"},null,8,["name"]),h("div",Ye,y(t.name)+" ("+y(t.items.length)+")",1)],8,He),u(De,null,{default:b(()=>[$e(h("div",Ze,[(i(!0),c(G,null,I(t.items,l=>(i(),q(ae,{key:l.id,friend:l,"friendship-id":n.friendshipIdByUserId[l.id]||""},null,8,["friend","friendship-id"]))),128))],512),[[_e,n.expanded[t.id||"ungrouped"]]])]),_:2},1024)]))),128))]))}}),Xe=["src"],We={key:1},es={class:"text-h6 q-mt-md"},ss={key:0,class:"text-subtitle2 text-grey-6"},ts={class:"text-body2 text-grey-7 q-mt-sm"},ns={class:"text-caption text-grey-6 q-mt-xs"},rs=x({__name:"PendingRequestCard",props:{request:{}},emits:["accept","decline","cancel"],setup($){const n=$,o=F(()=>n.request.type==="incoming"?n.request.user:n.request.friend),t=e=>e.name&&e.surname?`${e.name} ${e.surname}`:e.username||e.email,l=e=>e.name&&e.surname?`${e.name.charAt(0)}${e.surname.charAt(0)}`:e.username?e.username.charAt(0).toUpperCase():e.email.charAt(0).toUpperCase(),A=e=>{const d=new Date(e),_=Math.abs(new Date().getTime()-d.getTime()),m=Math.ceil(_/(1e3*60*60*24));return m===1?"Dnes":m===2?"Včera":m<7?`Před ${m} dny`:d.toLocaleDateString("cs-CZ")};return(e,d)=>(i(),q(ee,{class:"pending-card",style:{width:"100%","max-width":"300px"}},{default:b(()=>[u(se,{class:"text-center"},{default:b(()=>[u(te,{size:"60px",color:"primary","text-color":"white"},{default:b(()=>[o.value.avatar_url?(i(),c("img",{key:0,src:o.value.avatar_url},null,8,Xe)):(i(),c("span",We,y(l(o.value)),1))]),_:1}),h("div",es,y(t(o.value)),1),o.value.username?(i(),c("div",ss," @"+y(o.value.username),1)):w("",!0),h("div",ts,[u(T,{name:"schedule",size:"16px",class:"q-mr-xs"}),be(" "+y(e.request.created_at?A(e.request.created_at):"N/A"),1)]),h("div",ns,y(e.request.type==="incoming"?"Požadavek od uživatele":"Odeslaný požadavek"),1)]),_:1}),u(qe,{align:"center"},{default:b(()=>[e.request.type==="incoming"?(i(),c(G,{key:0},[u(C,{color:"positive",flat:"",icon:"check",label:"Přijmout",onClick:d[0]||(d[0]=g=>e.$emit("accept",e.request.id))}),u(C,{color:"negative",flat:"",icon:"close",label:"Odmítnout",onClick:d[1]||(d[1]=g=>e.$emit("decline",e.request.id))})],64)):(i(),c(G,{key:1},[u(C,{color:"grey",flat:"",icon:"schedule",label:"Čeká na odpověď",disabled:""}),u(C,{color:"negative",flat:"",icon:"close",label:"Zrušit",onClick:d[2]||(d[2]=g=>e.$emit("cancel",e.request.id))})],64))]),_:1})]),_:1}))}}),as=ne(rs,[["__scopeId","data-v-dba6884f"]]),is={key:0,class:"flex flex-center q-pa-lg"},os={key:1,class:"text-center text-grey-6 q-py-lg"},ls={class:"text-h6 q-mt-md"},ds={key:2,class:"row q-gutter-md"},us=x({__name:"PendingRequestsPanel",props:{loading:{type:Boolean},requests:{}},emits:["accept","decline","cancel"],setup($){return(n,o)=>(i(),c("div",null,[n.loading?(i(),c("div",is,[u(re,{size:"lg"})])):n.requests.length===0?(i(),c("div",os,[u(T,{name:"hourglass_empty",size:"4rem"}),h("div",ls,y(n.$t("friends.noPendingRequests")),1)])):(i(),c("div",ds,[(i(!0),c(G,null,I(n.requests,t=>(i(),q(as,{key:t.id,request:t,onAccept:l=>n.$emit("accept",t.id),onDecline:l=>n.$emit("decline",t.id),onCancel:l=>n.$emit("cancel",t.id)},null,8,["request","onAccept","onDecline","onCancel"]))),128))]))]))}});function cs($,n,o,t){const l=F(()=>{const e={};for(const m of n.value){const k=o.value[m.id]||[],Q=$.value.filter(V=>k.some(R=>R.user_id===V.id));Q.length>0&&(e[m.id]={id:m.id,name:m.name,items:Q})}const d=new Set(Object.values(e).flatMap(m=>m.items.map(k=>k.id))),g=$.value.filter(m=>!d.has(m.id)),_=Object.values(e).sort((m,k)=>m.name.localeCompare(k.name,void 0,{sensitivity:"base"}));return g.length&&_.push({id:null,name:t("friends.other"),items:g}),_}),A=F(()=>n.value.length>0);return{groupedFriends:l,hasGroups:A}}function ms($,n){const o=(()=>{try{const d=localStorage.getItem($);return d?JSON.parse(d):{}}catch{return{}}})(),t=P(o);return E(n,d=>{const g={...t.value};for(const _ of d){const m=_.id||"ungrouped";m in g||(g[m]=!0)}t.value=g},{immediate:!0}),E(t,d=>{try{localStorage.setItem($,JSON.stringify(d))}catch{}},{deep:!0}),{expanded:t,toggle:d=>{const g=d||"ungrouped";t.value[g]=!t.value[g]},collapseAll:()=>{for(const d of Object.keys(t.value))t.value[d]=!1},expandAll:()=>{for(const d of Object.keys(t.value))t.value[d]=!0}}}const ps={key:0,class:"flex justify-center"},fs={key:1,class:"text-center text-grey-6 q-py-lg"},gs={class:"text-h6 q-mt-md"},vs={key:2},ys={key:1,class:"row q-gutter-md"},W="friends.groupByGroups",hs="friends.expandedGroups",Rs=x({__name:"FriendsPage",setup($){const n=we(()=>Ge(()=>import("./AddFriendDialog-B3U3Vxp1.js"),__vite__mapDeps([0,1,2,3,4]))),o=Fe(),{t}=ke(),l=Qe(),{groups:A,fetchGroups:e,fetchGroupMembers:d,membersByGroup:g}=Ie(),{friends:_,friendships:m,isLoading:k,sendFriendRequest:Q,acceptFriendRequest:V,declineFriendRequest:R,fetchFriends:z,fetchPendingRequests:ie,searchUsers:oe,resetLoadingState:O,subscribeToPendingRequests:L,unsubscribeFromFriendships:U}=Re(),B=P("friends"),N=P(!1),p=P([]),D=P(localStorage.getItem(W)==="1");E(()=>D.value,r=>localStorage.setItem(W,r?"1":"0"));const{groupedFriends:j,hasGroups:le}=cs(_,F(()=>A.value),F(()=>g.value),t),{expanded:de,toggle:ue,collapseAll:ce,expandAll:me}=ms(hs,j),pe=()=>{},J=F(()=>{const r={},s=l.user?.id;if(!s)return r;for(const a of m.value)a.user_id===s?r[a.friend_id]=a.id:a.friend_id===s&&(r[a.user_id]=a.id);return r}),fe=async r=>{if(!l.user)return;const s=p.value.findIndex(S=>S.id===r),a=s!==-1?p.value[s]:null;s!==-1&&p.value.splice(s,1);const v=await V(r,l.user.id);v.error?(a&&p.value.splice(s,0,a),o.notify({type:"negative",message:t("friends.acceptRequestError")+": "+(v.error instanceof Error?v.error.message:JSON.stringify(v.error))})):(o.notify({type:"positive",message:t("friends.acceptRequestSuccess")}),z(l.user.id,!0))},ge=async r=>{const s=p.value.findIndex(S=>S.id===r),a=s!==-1?p.value[s]:null;s!==-1&&p.value.splice(s,1);const v=await R(r);v.error?(a&&p.value.splice(s,0,a),o.notify({type:"negative",message:t("friends.declineRequestError")+": "+(v.error instanceof Error?v.error.message:JSON.stringify(v.error))})):o.notify({type:"positive",message:t("friends.declineRequestSuccess")})},ve=async r=>{const s=p.value.findIndex(S=>S.id===r),a=s!==-1?p.value[s]:null;s!==-1&&p.value.splice(s,1);const v=await R(r);v.error?(a&&p.value.splice(s,0,a),o.notify({type:"negative",message:"Chyba při rušení požadavku: "+(v.error instanceof Error?v.error.message:JSON.stringify(v.error))})):o.notify({type:"positive",message:"Požadavek byl zrušen."})},M=async()=>{if(l.user)try{const r=await ie(l.user.id);r?.data&&(p.value=r.data)}catch(r){console.error("Error loading pending requests:",r),p.value=[]}},H=async r=>{if(r){console.log("Loading user data for:",r.id);try{const s=_.value.length>0;console.log("Has existing data:",s),await Promise.all([z(r.id,s),M()]),console.log("Data loaded successfully"),L(r.id,a=>{p.value=a})}catch(s){console.error("Error loading user data:",s),O()}}};Z(async()=>{l.user&&_.value.length===0&&await H(l.user),await e();for(const r of A.value)await d(r.id);setTimeout(()=>{k.value&&(console.warn("Loading timeout reached, forcing reset"),O())},1e4)}),E(()=>l.user,async(r,s)=>{r&&!s?await H(r):r&&s&&r.id!==s.id&&(U(),await z(r.id,!0),await M(),L(r.id,a=>{p.value=a}))});const Y=()=>{!document.hidden&&l.user&&k.value&&O(l.user.id)};return Z(()=>{document.addEventListener("visibilitychange",Y)}),Ae(()=>{document.removeEventListener("visibilitychange",Y),U()}),(r,s)=>(i(),q(Pe,{class:"q-pa-md"},{default:b(()=>[u(Me,{title:r.$t("friends.title"),"group-by-groups":D.value,"has-groups":f(le),"onUpdate:groupByGroups":s[0]||(s[0]=a=>D.value=a),onAddFriend:s[1]||(s[1]=a=>N.value=!0),onCollapseAll:s[2]||(s[2]=a=>f(ce)()),onExpandAll:s[3]||(s[3]=a=>f(me)())},null,8,["title","group-by-groups","has-groups"]),u(xe,{modelValue:B.value,"onUpdate:modelValue":s[4]||(s[4]=a=>B.value=a),class:"text-primary q-mb-md"},{default:b(()=>[u(K,{name:"friends",label:r.$t("friends.myFriends")},null,8,["label"]),u(K,{name:"pending",label:r.$t("friends.requests")},null,8,["label"])]),_:1},8,["modelValue"]),u(Ce),u(Se,{modelValue:B.value,"onUpdate:modelValue":s[5]||(s[5]=a=>B.value=a),animated:""},{default:b(()=>[u(X,{name:"friends"},{default:b(()=>[f(k)?(i(),c("div",ps,[u(re,{size:"lg"})])):f(_).length===0?(i(),c("div",fs,[u(T,{name:"people",size:"4rem"}),h("div",gs,y(r.$t("friends.noFriends")),1),h("div",null,y(r.$t("friends.addFirstFriend")),1)])):(i(),c("div",vs,[D.value?(i(),q(Ke,{key:0,groups:f(j),expanded:f(de),"friendship-id-by-user-id":J.value,onToggleGroup:f(ue)},null,8,["groups","expanded","friendship-id-by-user-id","onToggleGroup"])):(i(),c("div",ys,[(i(!0),c(G,null,I(f(_),a=>(i(),q(ae,{key:a.id,friend:a,"friendship-id":J.value[a.id]||""},null,8,["friend","friendship-id"]))),128))]))]))]),_:1}),u(X,{name:"pending"},{default:b(()=>[u(us,{loading:f(k),requests:p.value,onAccept:fe,onDecline:ge,onCancel:ve},null,8,["loading","requests"])]),_:1})]),_:1},8,["modelValue"]),u(f(n),{modelValue:N.value,"onUpdate:modelValue":s[6]||(s[6]=a=>N.value=a),"current-user":f(l).user?{id:f(l).user.id}:null,"existing-friend-ids":f(_).map(a=>a.id),"search-users-fn":f(oe),"send-friend-request-fn":f(Q),onFriendRequestSent:pe},null,8,["modelValue","current-user","existing-friend-ids","search-users-fn","send-friend-request-fn"])]),_:1}))}});export{Rs as default};
