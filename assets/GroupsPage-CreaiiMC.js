import{a as le,r as g,b as ne,z as ie,n as re,p as M,f as a,o as m,h as l,c as p,e as o,t as r,k as c,l as y,s as ue,q as de,ar as U,as as A,Q,g as h,j as B,at as F,a4 as S,aA as j,i as me,aq as ce,x as pe}from"./index-B3spGy88.js";import{Q as fe,a as z}from"./QItem-f-kqPoHc.js";import{Q as ve,a as ge}from"./QSelect-j2j_KoaU.js";import{Q as ye}from"./QPage-693sF3lM.js";import{C as I}from"./ClosePopup-BS4tcVg3.js";import{u as be}from"./useGroups-Dd1QCz73.js";import{u as he}from"./useFriends-BnGHCqY5.js";import{u as we}from"./auth-store-MnmwA6R3.js";import{u as _e}from"./use-quasar-BAGBkhZd.js";import{u as $e}from"./vue-i18n.runtime-DwBerXon.js";import"./format-geZld8GE.js";import"./position-engine-DOqoRyaA.js";import"./selection-DaOyP1qb.js";import"./rtl-DFPa-2ov.js";import"./supabase-CPQ3eL74.js";const Ce={class:"row items-center justify-between q-mb-md"},ke={class:"text-h4"},Ge={key:0,class:"flex justify-center q-my-lg"},Qe={key:1,class:"text-center q-py-lg"},Ve={class:"text-h6 q-mt-md"},qe={class:"text-body2"},xe={key:2,class:"q-gutter-md q-mt-md"},De={class:"text-h6"},Me={class:"text-body2 text-grey-7"},Ue={class:"text-caption text-grey-7 q-mt-xs"},Ae={class:"row items-center no-wrap q-gutter-xs"},Be={class:"row items-center justify-between q-mb-sm"},Fe={class:"text-subtitle2"},Se={class:"row q-col-gutter-sm"},je={key:0,class:"text-grey-6"},ze={class:"text-h6"},Ie={class:"text-h6"},ts=le({__name:"GroupsPage",setup(Ne){const i=_e(),{t:u}=$e(),w=we(),{groups:k,isLoading:N,fetchGroups:R,createGroup:T,updateGroup:P,deleteGroup:E,fetchGroupMembers:L,addMemberToGroup:O,removeMemberFromGroup:W,membersByGroup:G,countGroupUsage:V}=be(),{friends:q,fetchFriends:H}=he(),b=g(!1),_=g(!1),f=g(null),$=g(null),n=ne({name:"",description:""}),v=g([]),C=g({}),J=async e=>{const t=await V(e);!t.error&&t.data&&(C.value[e]=t.data)},K=ie(()=>(q.value||[]).map(e=>({label:e.name||e.username||e.email,value:e.id}))),X=e=>{const t=q.value.find(s=>s.id===e);return t?t.name||t.username||t.email:e};re(async()=>{if(w.user?.id){await R(),await H(w.user.id);for(const e of k.value)await L(e.id),J(e.id)}});const Y=e=>{f.value=e.id,n.name=e.name,n.description=e.description||"",b.value=!0},Z=async e=>{const t=await V(e.id),s=t.data?.wishesCount||0,d=t.data?.includesCount||0,x=t.data?.excludesCount||0,ae=s>0?`

${u("groups.confirmDelete.usageWarning",{wishes:s,includes:d,excludes:x})}`:"";i.dialog({title:u("groups.confirmDelete.title"),message:`${u("groups.confirmDelete.message",{name:e.name})}${ae}`,cancel:!0,persistent:!0}).onOk(()=>{(async()=>{const D=await E(e.id);D.error?i.notify({type:"negative",message:D.error.message}):i.notify({type:"positive",message:u("groups.messages.deleted")})})()})},ee=async()=>{if(w.user?.id){if(!n.name.trim()){i.notify({type:"warning",message:u("groups.validation.nameRequired")});return}if(f.value){const e=await P(f.value,{name:n.name.trim(),description:n.description||null});e.error?i.notify({type:"negative",message:e.error.message}):i.notify({type:"positive",message:u("groups.messages.updated")})}else{const e=await T({name:n.name.trim(),description:n.description||""},w.user.id);e.error?i.notify({type:"negative",message:e.error.message}):i.notify({type:"positive",message:u("groups.messages.created")})}n.name="",n.description="",f.value=null,b.value=!1}},se=e=>{$.value=e,v.value=[],_.value=!0},te=async()=>{if(!$.value||v.value.length===0)return;let e=0,t=0;for(const s of v.value)(await O($.value.id,s)).error?t++:e++;e>0&&i.notify({type:"positive",message:u("groups.messages.memberAdded")+` (${e})`}),t>0&&i.notify({type:"warning",message:u("common.error")+`: ${t}`}),_.value=!1},oe=async(e,t)=>{const s=await W(e,t);s.error?i.notify({type:"negative",message:s.error.message}):i.notify({type:"positive",message:u("groups.messages.memberRemoved")})};return(e,t)=>(m(),M(ye,{class:"q-pa-md"},{default:a(()=>[l("div",Ce,[l("div",ke,r(e.$t("groups.title")),1),o(c,{color:"primary",icon:"add",label:e.$t("groups.newGroup"),onClick:t[0]||(t[0]=s=>b.value=!0)},null,8,["label"])]),y(N)?(m(),p("div",Ge,[o(ue,{size:"lg"})])):y(k).length===0?(m(),p("div",Qe,[o(de,{name:"groups",size:"4rem",class:"text-grey-6"}),l("div",Ve,r(e.$t("groups.emptyTitle")),1),l("div",qe,r(e.$t("groups.emptyDescription")),1)])):(m(),p("div",xe,[(m(!0),p(U,null,A(y(k),s=>(m(),M(Q,{key:s.id},{default:a(()=>[o(fe,null,{default:a(()=>[o(z,null,{default:a(()=>[l("div",De,r(s.name),1),l("div",Me,r(s.description),1),l("div",Ue,r(e.$t("groups.usage",{wishes:C.value[s.id]?.wishesCount??0,includes:C.value[s.id]?.includesCount??0,excludes:C.value[s.id]?.excludesCount??0})),1)]),_:2},1024),o(z,{side:""},{default:a(()=>[l("div",Ae,[o(c,{flat:"",round:"",icon:"edit",onClick:d=>Y(s)},null,8,["onClick"]),o(c,{flat:"",round:"",icon:"delete",color:"negative",onClick:d=>Z(s)},null,8,["onClick"])])]),_:2},1024)]),_:2},1024),o(me),o(h,null,{default:a(()=>[l("div",Be,[l("div",Fe,r(e.$t("groups.members")),1),l("div",null,[o(c,{size:"sm",flat:"",icon:"person_add",label:e.$t("common.add"),onClick:d=>se(s)},null,8,["label","onClick"])])]),l("div",Se,[(m(!0),p(U,null,A(y(G)[s.id]||[],d=>(m(),p("div",{key:d.id,class:"col-auto"},[o(ge,{removable:"",onRemove:x=>oe(s.id,d.user_id)},{default:a(()=>[pe(r(X(d.user_id)),1)]),_:2},1032,["onRemove"])]))),128)),y(G)[s.id]&&y(G)[s.id].length>0?ce("",!0):(m(),p("div",je,r(e.$t("groups.noMembers")),1))])]),_:2},1024)]),_:2},1024))),128))])),o(j,{modelValue:b.value,"onUpdate:modelValue":t[3]||(t[3]=s=>b.value=s)},{default:a(()=>[o(Q,{style:{"max-width":"500px",width:"100%"}},{default:a(()=>[o(h,null,{default:a(()=>[l("div",ze,r(f.value?e.$t("groups.editGroup"):e.$t("groups.newGroup")),1)]),_:1}),o(h,{class:"q-gutter-md"},{default:a(()=>[o(B,{modelValue:n.name,"onUpdate:modelValue":t[1]||(t[1]=s=>n.name=s),label:e.$t("groups.form.name"),outlined:""},null,8,["modelValue","label"]),o(B,{modelValue:n.description,"onUpdate:modelValue":t[2]||(t[2]=s=>n.description=s),label:e.$t("groups.form.description"),type:"textarea",outlined:""},null,8,["modelValue","label"])]),_:1}),o(F,{align:"right"},{default:a(()=>[S(o(c,{flat:"",label:e.$t("common.cancel")},null,8,["label"]),[[I]]),o(c,{color:"primary",label:f.value?e.$t("common.save"):e.$t("common.create"),onClick:ee},null,8,["label"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(j,{modelValue:_.value,"onUpdate:modelValue":t[5]||(t[5]=s=>_.value=s)},{default:a(()=>[o(Q,{style:{"max-width":"520px",width:"100%"}},{default:a(()=>[o(h,null,{default:a(()=>[l("div",Ie,r(e.$t("groups.addMemberTitle",{name:$.value?.name||""})),1)]),_:1}),o(h,null,{default:a(()=>[o(ve,{modelValue:v.value,"onUpdate:modelValue":t[4]||(t[4]=s=>v.value=s),options:K.value,label:e.$t("groups.selectFriends"),outlined:"","use-chips":"",multiple:"","emit-value":"","map-options":""},null,8,["modelValue","options","label"])]),_:1}),o(F,{align:"right"},{default:a(()=>[S(o(c,{flat:"",label:e.$t("common.close")},null,8,["label"]),[[I]]),o(c,{color:"primary",label:e.$t("common.add"),disable:!v.value.length,onClick:te},null,8,["label","disable"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});export{ts as default};
