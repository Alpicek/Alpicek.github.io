import{a as P}from"./QSelect-CC7M6R9u.js";import{E as de,I as ce,a4 as me,a6 as he,K as pe,aO as ve,C as u,G as K,aK as fe,A as we,r as M,a as ie,u as oe,x as Y,w as O,e as _,o as a,aP as m,ax as S,g as y,f as p,h as L,v as H,t as T,q as A,F as J,D as X,ao as re,n as ge,aQ as be,p as z,B as ye,_ as ne,y as R,Q as _e,l as te,ab as ke,aH as Ce,az as Ie,m as $e,k as Se,aE as qe}from"./index-BR5I7U9B.js";import{Q as Te}from"./QSlideTransition-BeC8BwHB.js";import{u as Ee}from"./useGroups-BniwYyCy.js";import{supabase as W}from"./supabase-C7Q3J7Aw.js";import{Q as Z}from"./QBadge-DErxSnF2.js";import{Q as Qe,a as se}from"./QTabs-ko1bx41e.js";import{u as xe}from"./auth-store-CLpI6O-q.js";function Be(l){if(!l)return null;let t=l.trim();/^https?:\/\//i.test(t)||(t="https://"+t);try{const C=new URL(t).hostname.toLowerCase().replace(/^www\./,""),I=C.split(".");return I.length>=2?I.slice(-2).join("."):C}catch{return null}}function Re(){async function l(t,s="_blank"){if(!t)return;const C=W.rpc("track_link_click",{target_url:t});try{s==="_blank"?window.open(t,"_blank","noopener"):window.location.href=t}catch{}try{await C}catch{}}return{trackClickAndOpen:l,extractBaseDomain:Be}}const Le=de({name:"QInnerLoading",props:{...me,...ce,showing:Boolean,color:String,size:{type:[String,Number],default:"42px"},label:String,labelClass:String,labelStyle:[String,Array,Object]},setup(l,{slots:t}){const s=pe(),C=he(l,s.proxy.$q),{transitionProps:I,transitionStyle:v}=ve(l),N=u(()=>"q-inner-loading q--avoid-card-border absolute-full column flex-center"+(C.value===!0?" q-inner-loading--dark":"")),D=u(()=>"q-inner-loading__label"+(l.labelClass!==void 0?` ${l.labelClass}`:""));function V(){const c=[K(we,{size:l.size,color:l.color})];return l.label!==void 0&&c.push(K("div",{class:D.value,style:l.labelStyle},[l.label])),c}function k(){return l.showing===!0?K("div",{class:N.value,style:v.value},t.default!==void 0?t.default():V()):null}return()=>K(fe,I.value,k)}});function Ne(){const l=xe(),t=M([]),s=M(!1),C=new Set,I=new Map,v=new Map,N=r=>t.value.filter(o=>o.wish_id===r),D=r=>N(r).filter(o=>o.thread_type==="recipient"),V=r=>N(r).filter(o=>o.thread_type==="secret"),k=r=>l.user?.id===r.created_for_user_id,c=async r=>{s.value=!0;try{const{data:o,error:$}=await W.from("wish_comments").select("*").eq("wish_id",r).order("created_at",{ascending:!0});if($)throw $;if(!o)return{data:[],error:null};const f=Array.from(new Set(o.map(n=>n.author_id))),{data:d,error:w}=await W.from("profiles_public").select("*").in("id",f);if(w)throw w;const g=new Map((d||[]).map(n=>[n.id,n]));g.forEach((n,G)=>v.set(G,n));const h=new Set(t.value.map(n=>n.id)),i=o.filter(n=>!h.has(n.id)).map(n=>({...n,author:g.get(n.author_id)||null}));return t.value=t.value.concat(i),C.add(r),{data:i,error:null}}catch(o){return{data:[],error:o instanceof Error?o:new Error(String(o))}}finally{s.value=!1}},E=async(r,o,$)=>{const f=l.user?.id;if(!f)return{error:new Error("Not authenticated")};if(!o.trim())return{error:new Error("Empty comment")};try{const{data:d,error:w}=await W.from("wish_comments").insert([{wish_id:r,body:o.trim(),thread_type:$,author_id:f}]).select("*").single();if(w)throw w;const g={...d,author:l.profile};return v.set(g.author_id,g.author||null),t.value.push(g),{data:d,error:null}}catch(d){const w=d;return w&&w.code==="23514"&&typeof w.message=="string"&&/notifications_type_check/i.test(w.message)?{error:new Error("Notification type constraint blocked comment – apply latest migration.")}:{error:d instanceof Error?d:new Error(String(d))}}},Q=r=>{if(I.has(r))return;const o=W.channel(`wish_comments:wish_id=${r}`);o.on("postgres_changes",{event:"INSERT",schema:"public",table:"wish_comments",filter:`wish_id=eq.${r}`},$=>{const f=$.new;if(!t.value.find(d=>d.id===f.id)){const d=v.get(f.author_id)??null,w={...f,author:d};t.value.push(w),d||W.from("profiles_public").select("*").eq("id",f.author_id).single().then(({data:g})=>{if(g){v.set(f.author_id,g);const h=t.value.findIndex(i=>i.id===f.id);h!==-1&&t.value[h]&&(t.value[h].author=g)}})}}),o.on("postgres_changes",{event:"DELETE",schema:"public",table:"wish_comments",filter:`wish_id=eq.${r}`},$=>{const f=$.old.id;t.value=t.value.filter(d=>d.id!==f)}),o.subscribe(),I.set(r,o)},x=r=>{const o=I.get(r);o&&(W.removeChannel(o),I.delete(r))},U=r=>{t.value=t.value.filter(o=>o.wish_id!==r),C.delete(r)};return{comments:u(()=>t.value),loading:u(()=>s.value),fetchComments:c,addComment:E,ensureSubscribed:Q,unsubscribe:x,resetWish:U,getRecipientComments:D,getSecretComments:V,isRecipient:k}}const De={key:0,class:"row items-center q-mb-sm"},Ae={key:2,class:"q-mb-sm"},Me={key:3,class:"q-mb-sm"},Ve={key:0,class:"text-caption text-grey-6 q-pa-sm"},ze=["data-comment-id"],We={class:"text-caption text-grey-6"},Ue={class:"author"},Ge={class:"time"},Pe={class:"text-body2"},Ke=ie({__name:"WishComments",props:{wishId:{},wish:{},focusThread:{},focusCommentId:{}},setup(l){const t=l,{t:s}=oe(),{fetchComments:C,ensureSubscribed:I,getRecipientComments:v,getSecretComments:N,addComment:D,isRecipient:V}=Ne(),k=M("recipient"),c=M(""),E=M(!1),Q=u(()=>t.wish.created_by_user_id!==t.wish.created_for_user_id),x=u(()=>V(t.wish));Y(()=>{t.focusThread?k.value=t.focusThread:Q.value?k.value="secret":x.value?k.value="recipient":k.value="secret"});const U=u(()=>v(t.wishId)),r=u(()=>N(t.wishId)),o=u(()=>k.value==="recipient"?U.value:r.value),$=u(()=>!Q.value),f=u(()=>!x.value||!$.value),d=u(()=>!!c.value.trim()),w=async()=>{if(!d.value)return;const h=k.value;await D(t.wishId,c.value,h),c.value=""},g=async()=>{if(E.value=!0,await C(t.wishId),I(t.wishId),t.focusCommentId){await ye();const h=document.querySelector(`[data-comment-id="${t.focusCommentId}"]`);h&&(h.classList.add("flash"),h.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>h.classList.remove("flash"),2e3))}E.value=!1};return O(()=>t.wishId,()=>{g()},{immediate:!0}),(h,i)=>(a(),_("div",{class:"wish-comments",onClick:i[12]||(i[12]=m(()=>{},["stop"])),onMousedown:i[13]||(i[13]=m(()=>{},["stop"]))},[!Q.value&&!x.value?(a(),_("div",De,[p(Z,{color:"grey-7",outline:""},{default:L(()=>[H(T(A(s)("wishes.comments.infoHelping")),1)]),_:1})])):S("",!0),!Q.value&&!x.value?(a(),_("div",{key:1,class:"q-mb-sm",onClick:i[1]||(i[1]=m(()=>{},["stop"])),onMousedown:i[2]||(i[2]=m(()=>{},["stop"]))},[p(Qe,{modelValue:k.value,"onUpdate:modelValue":i[0]||(i[0]=n=>k.value=n),dense:"",class:"text-grey-7","active-color":"primary","indicator-color":"primary"},{default:L(()=>[p(se,{name:"recipient",label:A(s)("wishes.comments.tabRecipient"),disable:!$.value,count:U.value.length},null,8,["label","disable","count"]),p(se,{name:"secret",label:A(s)("wishes.comments.tabSecret"),disable:!f.value,count:r.value.length},null,8,["label","disable","count"])]),_:1},8,["modelValue"])],32)):x.value?(a(),_("div",Ae,[p(Z,{color:"primary",outline:""},{default:L(()=>[H(T(A(s)("wishes.comments.visibleToYou")),1)]),_:1})])):(a(),_("div",Me,[p(Z,{color:"purple",outline:""},{default:L(()=>[H(T(A(s)("wishes.comments.secretThread")),1)]),_:1})])),y("div",{class:"comments-list q-mb-sm",onClick:i[3]||(i[3]=m(()=>{},["stop"])),onMousedown:i[4]||(i[4]=m(()=>{},["stop"])),onTouchstart:i[5]||(i[5]=m(()=>{},["stop"]))},[p(Le,{showing:E.value},null,8,["showing"]),o.value.length===0&&!E.value?(a(),_("div",Ve,T(A(s)("wishes.comments.empty")),1)):S("",!0),(a(!0),_(J,null,X(o.value,n=>(a(),_("div",{key:n.id,class:re(["comment-item q-pa-xs",{highlight:n.id===h.focusCommentId}]),"data-comment-id":n.id},[y("div",We,[y("span",Ue,T(n.author?.username||n.author_id.substring(0,6)),1),y("span",Ge," • "+T(new Date(n.created_at||"").toLocaleString("cs-CZ")),1)]),y("div",Pe,T(n.body),1)],10,ze))),128))],32),y("div",{class:"row items-end q-gutter-sm",onClick:i[9]||(i[9]=m(()=>{},["stop"])),onMousedown:i[10]||(i[10]=m(()=>{},["stop"])),onTouchstart:i[11]||(i[11]=m(()=>{},["stop"]))},[p(ge,{modelValue:c.value,"onUpdate:modelValue":i[6]||(i[6]=n=>c.value=n),dense:"",autogrow:"",filled:"",class:"col",placeholder:A(s)("wishes.comments.placeholder"),onKeyup:be(m(w,["exact","prevent"]),["enter"]),onClick:i[7]||(i[7]=m(()=>{},["stop"])),onMousedown:i[8]||(i[8]=m(()=>{},["stop"]))},null,8,["modelValue","placeholder","onKeyup"]),p(z,{color:"primary",disable:!d.value,icon:"send",round:"",dense:"",onClick:m(w,["stop"])},null,8,["disable"])],32)],32))}}),Oe=ne(Ke,[["__scopeId","data-v-d0364f48"]]),Fe={class:"row items-center justify-between"},je={class:"text-h6 wish-title"},He={class:"row items-center q-gutter-xs"},Ze={key:0,class:"text-body2 text-grey-7 q-mt-xs preview-text"},Ye={key:0,class:"row q-gutter-xs q-mb-md items-center"},Je={key:1,class:"wish-description q-mb-md"},Xe={class:"text-body2 text-grey-7"},et={key:2,class:"wish-url q-mb-md"},tt={class:"wish-meta"},st={class:"text-caption text-grey-6"},it={key:0},ot={class:"q-px-md q-pb-md"},rt=ie({__name:"WishCard",props:{wish:{},currentUserId:{},expanded:{type:Boolean},highlight:{type:Boolean},refreshKey:{}},emits:["edit","delete","toggleBought","toggleReceived"],setup(l,{emit:t}){const s=l,C=t,I=Se(),{t:v}=oe(),{trackClickAndOpen:N}=Re(),D=qe(),V=u(()=>D.query.thread),k=u(()=>D.query.comment),c=M(!1),E=()=>{typeof s.expanded=="boolean"&&(c.value=s.expanded)};Y(E),O(()=>s.expanded,()=>E());const Q=()=>{c.value=!c.value},x=u(()=>{switch(s.wish.visibility){case"public":return"green";case"friends":return"blue";case"private":return"grey";default:return"grey"}}),U=u(()=>{switch(s.wish.visibility){case"public":return v("wishes.visibilityPublic");case"friends":return ae.value?v("wishes.form.visibilityFriendsGroups"):v("wishes.visibilityFriends");case"private":return v("wishes.visibilityPrivate");default:return v("common.unknown")}}),r=u(()=>s.wish.created_by_user_id!==s.wish.created_for_user_id&&s.currentUserId!==s.wish.created_for_user_id),o=()=>{const e=s.wish.created_by_user;return e.name&&e.surname?`${e.name} ${e.surname}`:e.name?e.name:e.username?e.username:v("common.unknown")},$=u(()=>s.currentUserId===s.wish.created_by_user_id),f=u(()=>s.currentUserId===s.wish.created_by_user_id),d=u(()=>s.currentUserId!==s.wish.created_for_user_id&&s.currentUserId!==void 0),w=u(()=>s.currentUserId===s.wish.created_for_user_id&&s.currentUserId!==void 0),g=u(()=>s.currentUserId===s.wish.created_by_user_id),{groups:h,fetchGroups:i,fetchWishRules:n}=Ee(),G=M([]),F=M([]),ae=u(()=>G.value.length>0||F.value.length>0),ee=e=>{const q=h.value||[];return e.map(b=>q.find(B=>B.id===b)?.name).filter(b=>!!b)},j=async()=>{if(!g.value||s.wish.visibility!=="friends")return;(!h.value||h.value.length===0)&&await i();const e=await n(s.wish.id);if(!e.error&&e.data){const q=e.data.filter(B=>B.rule_type==="include").map(B=>B.group_id),b=e.data.filter(B=>B.rule_type==="exclude").map(B=>B.group_id);G.value=ee(q),F.value=ee(b)}};O(()=>c.value,e=>{e&&j()}),O(()=>s.refreshKey,()=>{c.value&&j()}),Y(()=>{c.value&&j()});const le=e=>new Date(e).toLocaleDateString("cs-CZ"),ue=()=>{I.dialog({title:v("wishes.deleteWish"),message:v("wishes.deleteConfirm"),cancel:!0,persistent:!0}).onOk(()=>{C("delete",s.wish.id)})};return(e,q)=>(a(),R(_e,{class:re(["wish-card self-start",{"wish-highlight":e.highlight}])},{default:L(()=>[p(te,{class:"wish-card-header",onClick:Q},{default:L(()=>[y("div",Fe,[y("div",je,T(e.wish.name),1),y("div",He,[e.wish.is_bought?(a(),R(P,{key:0,color:"green","text-color":"white",label:e.$t("wishes.bought"),size:"sm"},null,8,["label"])):S("",!0),e.wish.is_received?(a(),R(P,{key:1,color:"purple","text-color":"white",label:e.$t("wishes.received"),size:"sm"},null,8,["label"])):S("",!0),p(z,{flat:"",round:"",dense:"",icon:c.value?"expand_less":"expand_more",onClick:m(Q,["stop"])},null,8,["icon"])])]),!c.value&&e.wish.description?(a(),_("div",Ze,T(e.wish.description),1)):S("",!0)]),_:1}),p(Te,null,{default:L(()=>[ke(y("div",null,[p(te,{class:"wish-card-details"},{default:L(()=>[g.value?(a(),_("div",Ye,[p(P,{color:x.value,"text-color":"white",label:U.value,size:"sm"},null,8,["color","label"]),(a(!0),_(J,null,X(G.value,b=>(a(),R(P,{key:`inc-${b}`,color:"green","text-color":"white",label:b,size:"sm"},null,8,["label"]))),128)),(a(!0),_(J,null,X(F.value,b=>(a(),R(P,{key:`exc-${b}`,color:"red","text-color":"white",label:b,size:"sm"},null,8,["label"]))),128))])):S("",!0),e.wish.description?(a(),_("div",Je,[y("div",Xe,T(e.wish.description),1)])):S("",!0),e.wish.url?(a(),_("div",et,[p(z,{flat:"",color:"primary",icon:"open_in_new",label:e.$t("wishes.openLink"),size:"sm",onClick:q[0]||(q[0]=m(b=>A(N)(e.wish.url),["stop"]))},null,8,["label"])])):S("",!0),y("div",tt,[y("div",st,[r.value?(a(),_("div",it,T(e.$t("wishes.createdBy",{name:o()})),1)):S("",!0),y("div",null,T(e.wish.created_at?le(e.wish.created_at):"N/A"),1)])])]),_:1}),p(Ie,{align:"right"},{default:L(()=>[d.value?(a(),R(z,{key:0,color:e.wish.is_bought?"grey":"green",icon:e.wish.is_bought?"shopping_cart":"add_shopping_cart",label:e.wish.is_bought?e.$t("wishes.markAsNotBought"):e.$t("wishes.markAsBought"),flat:"",onClick:q[1]||(q[1]=m(b=>e.$emit("toggleBought",e.wish.id),["stop"]))},null,8,["color","icon","label"])):S("",!0),w.value?(a(),R(z,{key:1,color:e.wish.is_received?"orange":"purple",icon:e.wish.is_received?"undo":"check_circle",label:e.wish.is_received?e.$t("wishes.markAsNotReceived"):e.$t("wishes.markAsReceived"),flat:"",onClick:q[2]||(q[2]=m(b=>e.$emit("toggleReceived",e.wish.id),["stop"]))},null,8,["color","icon","label"])):S("",!0),$.value?(a(),R(z,{key:2,color:"primary",icon:"edit",flat:"",onClick:q[3]||(q[3]=m(b=>e.$emit("edit",e.wish),["stop"]))})):S("",!0),f.value?(a(),R(z,{key:3,color:"negative",icon:"delete",flat:"",onClick:m(ue,["stop"])})):S("",!0)]),_:1}),p($e,{class:"q-mx-md q-mt-sm"}),y("div",ot,[p(Oe,{"wish-id":e.wish.id,wish:{id:e.wish.id,created_for_user_id:e.wish.created_for_user_id,created_by_user_id:e.wish.created_by_user_id},"focus-thread":V.value,"focus-comment-id":k.value},null,8,["wish-id","wish","focus-thread","focus-comment-id"])])],512),[[Ce,c.value]])]),_:1})]),_:1},8,["class"]))}}),pt=ne(rt,[["__scopeId","data-v-3d3f695b"]]);export{pt as W};
