import{v as K,x as c,y as j,z as I,r as f}from"./index-dYzdyrNV.js";import{u as Q}from"./use-quasar-ItPRXWbW.js";import{u as R}from"./auth-store-BrgRVf0O.js";import{supabase as b}from"./supabase-BFO1p7NK.js";import{u as U}from"./vue-i18n.runtime-CmbyI-ZB.js";const L=K({name:"QBtnGroup",props:{unelevated:Boolean,outline:Boolean,flat:Boolean,rounded:Boolean,square:Boolean,push:Boolean,stretch:Boolean,glossy:Boolean,spread:Boolean},setup(a,{slots:o}){const u=c(()=>{const n=["unelevated","outline","flat","rounded","square","push","stretch","glossy"].filter(s=>a[s]===!0).map(s=>`q-btn-group--${s}`).join(" ");return`q-btn-group row no-wrap${n.length!==0?" "+n:""}`+(a.spread===!0?" q-btn-group--spread":" inline")});return()=>j("div",{class:u.value},I(o.default))}}),_="https://pushserver-production.up.railway.app";function M(){const a=Q(),{t:o}=U(),u=R(),n=f(!1),s=f("default"),r=f(null),v=f(""),p=f(!1),d=()=>(n.value="serviceWorker"in navigator&&"PushManager"in window,n.value&&(s.value=Notification.permission),n.value),k=t=>{const e="=".repeat((4-t.length%4)%4),i=(t+e).replace(/-/g,"+").replace(/_/g,"/"),y=window.atob(i),h=new Uint8Array(y.length);for(let l=0;l<y.length;++l)h[l]=y.charCodeAt(l);return h},g=async()=>{const t=await fetch(`${_}/vapid-public-key`);if(!t.ok)throw new Error(`Failed to get VAPID key: ${t.statusText}`);const e=await t.text();return v.value=e,e},m=async()=>{if(!d())throw new Error("Push notifications are not supported");const t=await Notification.requestPermission();return s.value=t,t},B=async()=>{if(!d())throw new Error("Push notifications are not supported");if(s.value!=="granted"&&await m()!=="granted")throw new Error("Notification permission denied");p.value=!0;try{const t=await navigator.serviceWorker.ready;let e=v.value;e||(e=await g());const i=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:k(e)});return r.value=i,await E(i),a.notify({type:"positive",message:o("notifications.subscribedSuccess"),timeout:3e3}),i}catch(t){throw a.notify({type:"negative",message:o("notifications.subscribeError"),timeout:5e3}),t}finally{p.value=!1}},N=async()=>{if(!r.value)throw new Error("No active subscription");p.value=!0;try{await r.value.unsubscribe(),r.value=null,await q(),a.notify({type:"positive",message:o("notifications.unsubscribedSuccess"),timeout:3e3})}catch(t){throw a.notify({type:"negative",message:o("notifications.unsubscribeError"),timeout:5e3}),t}finally{p.value=!1}},q=async()=>{if(u.user?.id)try{const{error:t}=await b.from("push_subscriptions").delete().eq("user_id",u.user.id);if(t)throw t}catch{}},E=async t=>{if(u.user?.id)try{const e=t.toJSON(),{error:i}=await b.from("push_subscriptions").upsert({user_id:u.user.id,endpoint:e.endpoint||"",p256dh_key:e.keys?.p256dh||null,auth_key:e.keys?.auth||null,subscription_data:e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{onConflict:"user_id"});if(i)throw i}catch{}},$=async()=>{if(!r.value)throw new Error("No active subscription");const t={title:o("notifications.testTitle"),body:o("notifications.testBody"),icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"test-notification",data:{type:"test",timestamp:Date.now()}};await S(r.value,t)},S=async(t,e)=>{try{const h=btoa("alpik:tajneheslo"),l={subscription:t.toJSON(),notification:e},w=await fetch(`${_}/send-notification`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Basic ${h}`},body:JSON.stringify(l)});if(!w.ok){const C=await w.text();throw new Error(`Failed to send notification: ${w.status} ${C}`)}await w.json(),a.notify({type:"positive",message:o("notifications.sent"),timeout:3e3})}catch(i){throw a.notify({type:"negative",message:o("notifications.sendError"),timeout:5e3}),i}},P=async()=>{if(!d())return null;try{const e=await(await navigator.serviceWorker.ready).pushManager.getSubscription();return r.value=e,e}catch{return null}},x=async()=>{d(),n.value&&(await P(),await g(),await A())},A=async()=>{if(u.user?.id)try{const{data:t,error:e}=await b.from("push_subscriptions").select("*").eq("user_id",u.user.id).eq("is_active",!0).single();if(e&&e.code!=="PGRST116")return;t&&r.value}catch{}},D=c(()=>!!r.value),T=c(()=>n.value&&s.value!=="denied"),O=c(()=>s.value==="default");return{isSupported:c(()=>n.value),permission:c(()=>s.value),isSubscribed:D,canSubscribe:T,needsPermission:O,isLoading:c(()=>p.value),vapidPublicKey:c(()=>v.value),initialize:x,requestPermission:m,subscribe:B,unsubscribe:N,sendTestNotification:$,sendNotification:S,getCurrentSubscription:P,checkSupport:d}}export{L as Q,M as u};
