import{a as Y,r as C,n as H,c as Q,o as c,e,p as w,at as V,Q as E,f as s,g as P,h as d,t as m,l as n,ak as A,aw as me,k as $,x as fe,i as W,aD as X,j as S,m as O,av as ce,au as ve,q as ye,aB as Z,aI as be,aJ as pe,b as ge,ax as _e}from"./index-CMeCmwpZ.js";import{Q as j}from"./QForm-BPnd2jto.js";import{Q as he}from"./QPage-CplMTeNP.js";import{u as ee}from"./use-quasar-DTpZL-V_.js";import{u as le}from"./auth-store-D3Azb-Qn.js";import{a as T,Q as $e}from"./QSelect-_uqFViso.js";import{u as Pe,Q as we}from"./usePushNotifications-Bkgxs132.js";import{u as G}from"./vue-i18n.runtime-DAEfigwX.js";import{_ as ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{Q as Ve,a as ke,b as x}from"./QItem-f59aejbR.js";import{supabase as U}from"./supabase-i_KcuiTD.js";import{u as qe}from"./useFriends-Bx4QD1bj.js";import"./format-B_TpDcI_.js";import"./position-engine-TuRIzaVh.js";import"./selection-QAs-AO3A.js";import"./rtl-DFPa-2ov.js";const Se={class:"q-pa-md"},Ce={class:"text-h6 q-mb-md"},Ue={class:"q-mb-md"},De={key:0,class:"q-mb-md"},Qe={key:1,class:"q-mb-md"},Ee={class:"text-h6 q-mb-md"},Fe={class:"text-body2 text-grey-6"},Ne=Y({__name:"NotificationSettings",setup(k){const{t:g}=G(),o=Pe(),y=C(!1);H(async()=>{await o.initialize()});const r=()=>{switch(o.permission.value){case"granted":return"positive";case"denied":return"negative";default:return"warning"}},D=()=>{switch(o.permission.value){case"granted":return"check_circle";case"denied":return"block";default:return"help"}},F=()=>{switch(o.permission.value){case"granted":return g("notifications.permissionGranted");case"denied":return g("notifications.permissionDenied");default:return g("notifications.permissionDefault")}},p=async()=>{try{await o.requestPermission()}catch{}},f=async()=>{try{await o.subscribe()}catch{}},u=async()=>{try{await o.unsubscribe()}catch{}},b=async()=>{y.value=!0;try{await o.sendTestNotification()}catch{}finally{y.value=!1}};return(t,v)=>(c(),Q("div",Se,[e(E,{class:"q-mb-md"},{default:s(()=>[e(P,null,{default:s(()=>[d("div",Ce,m(t.$t("notifications.title")),1),d("div",Ue,[e(T,{color:n(o).isSupported.value?"positive":"negative","text-color":"white",icon:n(o).isSupported.value?"check_circle":"error"},{default:s(()=>[A(m(n(o).isSupported.value?t.$t("notifications.supported"):t.$t("notifications.notSupported")),1)]),_:1},8,["color","icon"])]),n(o).isSupported.value?(c(),Q("div",De,[e(T,{color:r(),"text-color":"white",icon:D()},{default:s(()=>[A(m(F()),1)]),_:1},8,["color","icon"])])):V("",!0),n(o).isSupported.value?(c(),Q("div",Qe,[e(T,{color:n(o).isSubscribed.value?"positive":"grey","text-color":"white",icon:n(o).isSubscribed.value?"notifications_active":"notifications_off"},{default:s(()=>[A(m(n(o).isSubscribed.value?t.$t("notifications.subscribed"):t.$t("notifications.notSubscribed")),1)]),_:1},8,["color","icon"])])):V("",!0)]),_:1}),n(o).isSupported.value?(c(),w(me,{key:0,align:"around"},{default:s(()=>[n(o).needsPermission?(c(),w($,{key:0,color:"primary",icon:"notifications",label:t.$t("notifications.requestPermission"),onClick:p,loading:n(o).isLoading.value},null,8,["label","loading"])):V("",!0),n(o).canSubscribe&&!n(o).isSubscribed.value?(c(),w($,{key:1,color:"positive",icon:"notifications_active",label:t.$t("notifications.subscribe"),onClick:f,loading:n(o).isLoading.value},null,8,["label","loading"])):V("",!0),n(o).isSubscribed?(c(),w($,{key:2,color:"negative",icon:"notifications_off",label:t.$t("notifications.unsubscribe"),onClick:u,loading:n(o).isLoading.value},null,8,["label","loading"])):V("",!0),n(o).isSubscribed?(c(),w($,{key:3,color:"secondary",icon:"send",label:t.$t("notifications.sendTest"),onClick:b,loading:y.value},null,8,["label","loading"])):V("",!0)]),_:1})):V("",!0)]),_:1}),n(o).isSubscribed?(c(),w(E,{key:0},{default:s(()=>[e(P,null,{default:s(()=>[d("div",Ee,m(t.$t("notifications.history")),1),d("div",Fe,m(t.$t("notifications.historyEmpty")),1)]),_:1})]),_:1})):V("",!0)]))}}),Be=ae(Ne,[["__scopeId","data-v-2b373465"]]),Ae=()=>{const k=C(!1),g=async(p,f)=>{k.value=!0;try{const u=f.email||`dummy-${crypto.randomUUID().slice(0,8)}@dummy.local`,{data:b,error:t}=await U.from("profiles").insert({id:crypto.randomUUID(),email:u,name:f.name,surname:f.surname||null,username:f.username||null,date_of_birth:f.date_of_birth||null,birth_year_visible:f.birth_year_visible??!1,is_dummy:!0}).select().single();if(t||!b)throw t||new Error("Failed to create dummy profile");const{error:v}=await U.from("dummy_profile_managers").insert({dummy_profile_id:b.id,manager_user_id:p});if(v)throw await U.from("profiles").delete().eq("id",b.id),v;const{error:_}=await U.from("friendships").insert({user_id:p,friend_id:b.id,status:"accepted"});if(_)throw await U.from("profiles").delete().eq("id",b.id),_;return{data:b,error:null}}catch(u){return console.error("Error creating dummy profile:",u),{data:null,error:u}}finally{k.value=!1}},o=async p=>{k.value=!0;try{const{data:f,error:u}=await U.from("dummy_profile_managers").select(`
          *,
          profiles!dummy_profile_managers_dummy_profile_id_fkey (*)
        `).eq("manager_user_id",p);if(u)throw u;return{data:f?.map(t=>t.profiles).filter(Boolean)||[],error:null}}catch(f){return console.error("Error fetching managed dummy profiles:",f),{data:null,error:f}}finally{k.value=!1}},y=async(p,f)=>{k.value=!0;try{const{data:u,error:b}=await U.from("profiles").update(f).eq("id",p).eq("is_dummy",!0).select().single();if(b)throw b;return{data:u,error:null}}catch(u){return console.error("Error updating dummy profile:",u),{data:null,error:u}}finally{k.value=!1}},r=async(p,f)=>{k.value=!0;try{const{data:u}=await U.from("dummy_profile_managers").select("id").eq("dummy_profile_id",p).eq("manager_user_id",f).single();if(!u)throw new Error("You do not have permission to delete this dummy profile");const{error:b}=await U.from("profiles").delete().eq("id",p).eq("is_dummy",!0);if(b)throw b;return{error:null}}catch(u){return console.error("Error deleting dummy profile:",u),{error:u}}finally{k.value=!1}},D=async(p,f)=>{try{const{data:u}=await U.from("dummy_profile_managers").select("id").eq("dummy_profile_id",p).eq("manager_user_id",f).single();return!!u}catch{return!1}};return{isLoading:k,createDummyProfile:g,fetchManagedDummyProfiles:o,updateDummyProfile:y,deleteDummyProfile:r,canManageDummyProfile:D,suggestDummyProfileAsFriend:async(p,f,u)=>{k.value=!0;try{if(!await D(p,u))throw new Error("You do not have permission to suggest this dummy profile");const{data:t,error:v}=await U.from("friendships").insert({user_id:p,friend_id:f,status:"pending"}).select().single();if(v)throw v;return{data:t,error:null}}catch(b){return console.error("Error suggesting dummy profile as friend:",b),{data:null,error:b}}finally{k.value=!1}}}},Ie={class:"text-h6 q-mb-md"},Le={class:"text-body2 text-grey-7"},Me={class:"text-subtitle1 q-mb-md"},ze={class:"row q-gutter-sm"},Te={class:"text-subtitle1 q-mb-md"},Oe={class:"q-gutter-md"},je={class:"col"},Ye={class:"text-subtitle2"},He={key:0,class:"text-caption text-grey-7"},Ge={key:1,class:"text-caption text-grey-7"},Re={key:2,class:"text-caption text-grey-7"},Je={class:"col-auto"},Ke={class:"text-center text-grey-7 q-py-lg"},We={class:"text-h6"},Xe={class:"row q-gutter-sm justify-end"},Ze={class:"text-h6"},xe={class:"row q-gutter-sm justify-end q-mt-md"},el=Y({__name:"DummyProfileManager",setup(k){const g=ee(),{t:o}=G(),y=le(),r=fe(()=>y.user),{isLoading:D,createDummyProfile:F,fetchManagedDummyProfiles:p,updateDummyProfile:f,deleteDummyProfile:u,suggestDummyProfileAsFriend:b}=Ae(),{fetchEligibleUsersForDummySuggestion:t}=qe(),v=C(!1),_=C(!1),B=C(!1),I=C([]),h=C(null),L=C(null),R=C([]),N=C(null),z=C(!1),q=C({name:"",surname:"",username:"",email:"",date_of_birth:"",birth_year_visible:!1}),te=()=>{q.value={name:"",surname:"",username:"",email:"",date_of_birth:"",birth_year_visible:!1}},J=a=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a),ie=a=>new Date(a).toLocaleDateString(),M=async()=>{if(!r.value?.id)return;const{data:a}=await p(r.value.id);a&&(I.value=a)},oe=async()=>{if(!r.value?.id)return;const{data:a,error:i}=await F(r.value.id,q.value);if(i){g.notify({color:"negative",message:o("dummyProfiles.errors.createFailed"),icon:"error"});return}a&&(g.notify({color:"positive",message:o("dummyProfiles.messages.created"),icon:"check"}),te(),v.value=!1,await M())},re=a=>{h.value={...a},_.value=!0},se=async()=>{if(!h.value)return;const{data:a,error:i}=await f(h.value.id,h.value);if(i){g.notify({color:"negative",message:o("dummyProfiles.errors.updateFailed"),icon:"error"});return}a&&(g.notify({color:"positive",message:o("dummyProfiles.messages.updated"),icon:"check"}),_.value=!1,await M())},ne=a=>{g.dialog({title:o("dummyProfiles.confirmDelete.title"),message:o("dummyProfiles.confirmDelete.message",{name:a.name}),cancel:!0,persistent:!0}).onOk(()=>{(async()=>{if(!r.value?.id)return;const{error:i}=await u(a.id,r.value.id);if(i){g.notify({color:"negative",message:o("dummyProfiles.errors.deleteFailed"),icon:"error"});return}g.notify({color:"positive",message:o("dummyProfiles.messages.deleted"),icon:"check"}),await M()})()})},ue=async a=>{if(L.value=a,z.value=!0,B.value=!0,r.value?.id){const{data:i}=await t(a.id,r.value.id);i&&(R.value=i)}z.value=!1},de=async()=>{if(!r.value?.id||!L.value||!N.value)return;const{error:a}=await b(L.value.id,N.value,r.value.id);if(a){g.notify({color:"negative",message:o("dummyProfiles.errors.suggestionFailed"),icon:"error"});return}g.notify({color:"positive",message:o("dummyProfiles.messages.suggested"),icon:"check"}),B.value=!1,N.value=null,L.value=null};return H(()=>{M()}),(a,i)=>(c(),w(E,{class:"dummy-profile-manager"},{default:s(()=>[e(P,null,{default:s(()=>[d("div",Ie,m(a.$t("dummyProfiles.title")),1),d("p",Le,m(a.$t("dummyProfiles.description")),1)]),_:1}),e(W),v.value?(c(),w(P,{key:0},{default:s(()=>[d("div",Me,m(a.$t("dummyProfiles.createNew")),1),e(j,{onSubmit:X(oe,["prevent"]),class:"q-gutter-md"},{default:s(()=>[e(S,{modelValue:q.value.name,"onUpdate:modelValue":i[0]||(i[0]=l=>q.value.name=l),label:a.$t("dummyProfiles.form.name"),filled:"",rules:[l=>!!l||a.$t("validation.required")],required:""},null,8,["modelValue","label","rules"]),e(S,{modelValue:q.value.surname,"onUpdate:modelValue":i[1]||(i[1]=l=>q.value.surname=l),label:a.$t("dummyProfiles.form.surname"),filled:""},null,8,["modelValue","label"]),e(S,{modelValue:q.value.username,"onUpdate:modelValue":i[2]||(i[2]=l=>q.value.username=l),label:a.$t("dummyProfiles.form.username"),filled:"",hint:a.$t("dummyProfiles.form.usernameHint")},null,8,["modelValue","label","hint"]),e(S,{modelValue:q.value.email,"onUpdate:modelValue":i[3]||(i[3]=l=>q.value.email=l),label:a.$t("dummyProfiles.form.email"),type:"email",filled:"",hint:a.$t("dummyProfiles.form.emailHint"),rules:[l=>!l||J(l)||a.$t("validation.invalidEmail")]},null,8,["modelValue","label","hint","rules"]),e(S,{modelValue:q.value.date_of_birth,"onUpdate:modelValue":i[4]||(i[4]=l=>q.value.date_of_birth=l),label:a.$t("dummyProfiles.form.dateOfBirth"),type:"date",filled:""},null,8,["modelValue","label"]),e(O,{modelValue:q.value.birth_year_visible,"onUpdate:modelValue":i[5]||(i[5]=l=>q.value.birth_year_visible=l),label:a.$t("dummyProfiles.form.birthYearVisible")},null,8,["modelValue","label"]),d("div",ze,[e($,{type:"submit",color:"primary",label:a.$t("common.create"),loading:n(D)},null,8,["label","loading"]),e($,{flat:"",label:a.$t("common.cancel"),onClick:i[6]||(i[6]=l=>v.value=!1)},null,8,["label"])])]),_:1})]),_:1})):(c(),w(P,{key:1},{default:s(()=>[e($,{color:"primary",label:a.$t("dummyProfiles.createNew"),icon:"add",onClick:i[7]||(i[7]=l=>v.value=!0)},null,8,["label"])]),_:1})),I.value.length>0?(c(),w(W,{key:2})):V("",!0),I.value.length>0?(c(),w(P,{key:3},{default:s(()=>[d("div",Te,m(a.$t("dummyProfiles.yourProfiles")),1),d("div",Oe,[(c(!0),Q(ve,null,ce(I.value,l=>(c(),w(E,{key:l.id,flat:"",bordered:"",class:"dummy-profile-item"},{default:s(()=>[e(P,{class:"row items-center"},{default:s(()=>[d("div",je,[d("div",Ye,m(l.name)+" "+m(l.surname),1),l.username?(c(),Q("div",He," @"+m(l.username),1)):V("",!0),l.email&&!l.email.includes("@dummy.local")?(c(),Q("div",Ge,m(l.email),1)):V("",!0),l.date_of_birth?(c(),Q("div",Re,m(ie(l.date_of_birth)),1)):V("",!0)]),d("div",Je,[e(we,{flat:""},{default:s(()=>[e($,{flat:"",icon:"edit",size:"sm",title:a.$t("common.edit"),onClick:K=>re(l)},null,8,["title","onClick"]),e($,{flat:"",icon:"share",size:"sm",title:a.$t("dummyProfiles.suggestAsFriend"),onClick:K=>ue(l)},null,8,["title","onClick"]),e($,{flat:"",icon:"delete",size:"sm",color:"negative",title:a.$t("common.delete"),onClick:K=>ne(l)},null,8,["title","onClick"])]),_:2},1024)])]),_:2},1024)]),_:2},1024))),128))])]),_:1})):v.value?V("",!0):(c(),w(P,{key:4},{default:s(()=>[d("div",Ke,[e(ye,{name:"person_add_disabled",size:"3rem",class:"q-mb-md"}),d("div",null,m(a.$t("dummyProfiles.noProfiles")),1)])]),_:1})),e(Z,{modelValue:_.value,"onUpdate:modelValue":i[15]||(i[15]=l=>_.value=l),persistent:""},{default:s(()=>[e(E,{style:{width:"400px"}},{default:s(()=>[e(P,null,{default:s(()=>[d("div",We,m(a.$t("dummyProfiles.editProfile")),1)]),_:1}),h.value?(c(),w(P,{key:0},{default:s(()=>[e(j,{onSubmit:X(se,["prevent"]),class:"q-gutter-md"},{default:s(()=>[e(S,{modelValue:h.value.name,"onUpdate:modelValue":i[8]||(i[8]=l=>h.value.name=l),label:a.$t("dummyProfiles.form.name"),filled:"",rules:[l=>!!l||a.$t("validation.required")],required:""},null,8,["modelValue","label","rules"]),e(S,{modelValue:h.value.surname,"onUpdate:modelValue":i[9]||(i[9]=l=>h.value.surname=l),label:a.$t("dummyProfiles.form.surname"),filled:""},null,8,["modelValue","label"]),e(S,{modelValue:h.value.username,"onUpdate:modelValue":i[10]||(i[10]=l=>h.value.username=l),label:a.$t("dummyProfiles.form.username"),filled:""},null,8,["modelValue","label"]),e(S,{modelValue:h.value.email,"onUpdate:modelValue":i[11]||(i[11]=l=>h.value.email=l),label:a.$t("dummyProfiles.form.email"),type:"email",filled:"",hint:a.$t("dummyProfiles.form.emailHint"),rules:[l=>!l||J(l)||a.$t("validation.invalidEmail")]},null,8,["modelValue","label","hint","rules"]),e(S,{modelValue:h.value.date_of_birth,"onUpdate:modelValue":i[12]||(i[12]=l=>h.value.date_of_birth=l),label:a.$t("dummyProfiles.form.dateOfBirth"),type:"date",filled:""},null,8,["modelValue","label"]),e(O,{modelValue:h.value.birth_year_visible,"onUpdate:modelValue":i[13]||(i[13]=l=>h.value.birth_year_visible=l),label:a.$t("dummyProfiles.form.birthYearVisible")},null,8,["modelValue","label"]),d("div",Xe,[e($,{flat:"",label:a.$t("common.cancel"),onClick:i[14]||(i[14]=l=>_.value=!1)},null,8,["label"]),e($,{type:"submit",color:"primary",label:a.$t("common.save"),loading:n(D)},null,8,["label","loading"])])]),_:1})]),_:1})):V("",!0)]),_:1})]),_:1},8,["modelValue"]),e(Z,{modelValue:B.value,"onUpdate:modelValue":i[18]||(i[18]=l=>B.value=l),persistent:""},{default:s(()=>[e(E,{style:{width:"400px"}},{default:s(()=>[e(P,null,{default:s(()=>[d("div",Ze,m(a.$t("dummyProfiles.suggestProfile")),1)]),_:1}),e(P,null,{default:s(()=>[e($e,{modelValue:N.value,"onUpdate:modelValue":i[16]||(i[16]=l=>N.value=l),options:R.value,label:a.$t("dummyProfiles.selectFriend"),"option-label":"name","option-value":"id",filled:"","emit-value":"","map-options":"",loading:z.value},{option:s(l=>[e(Ve,be(pe(l.itemProps)),{default:s(()=>[e(ke,null,{default:s(()=>[e(x,null,{default:s(()=>[A(m(l.opt.name)+" "+m(l.opt.surname),1)]),_:2},1024),e(x,{caption:""},{default:s(()=>[A(m(l.opt.email),1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options","label","loading"]),d("div",xe,[e($,{flat:"",label:a.$t("common.cancel"),onClick:i[17]||(i[17]=l=>B.value=!1)},null,8,["label"]),e($,{color:"primary",label:a.$t("dummyProfiles.sendSuggestion"),loading:n(D),disable:!N.value,onClick:de},null,8,["label","loading","disable"])])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}}),ll=ae(el,[["__scopeId","data-v-b1e89a1f"]]),al={class:"text-h4 q-mb-md"},tl={class:"row justify-center"},il={class:"col-12 col-md-6"},ol=["src"],rl={key:1},sl={class:"text-h5 q-mt-md"},nl={key:0,class:"text-subtitle1 text-grey-6"},ul={class:"text-body2 text-grey-7"},dl={class:"row justify-end q-gutter-sm"},ml={class:"text-h6 q-mb-md"},fl={class:"q-mt-md"},Ul=Y({__name:"ProfilePage",setup(k){const g=ee(),{t:o}=G(),y=le(),r=ge({name:"",surname:"",username:"",date_of_birth:"",birth_year_visible:!1}),D=t=>t?t.name&&t.surname?`${t.name} ${t.surname}`:t.username||t.email:"",F=t=>t?t.name&&t.surname?`${t.name.charAt(0)}${t.surname.charAt(0)}`:t.username?t.username.charAt(0).toUpperCase():t.email.charAt(0).toUpperCase():"",p=t=>r.username?!0:!!t||o("profile.validationError"),f=t=>r.name&&r.surname?!0:!!t||o("profile.validationError"),u=()=>{y.profile&&(r.name=y.profile.name||"",r.surname=y.profile.surname||"",r.username=y.profile.username||"",r.date_of_birth=y.profile.date_of_birth||"",r.birth_year_visible=y.profile.birth_year_visible??!1)},b=async()=>{if(!r.username&&(!r.name||!r.surname)){g.notify({type:"negative",message:o("profile.validationError")});return}const t={name:r.name||null,surname:r.surname||null,username:r.username||null,date_of_birth:r.date_of_birth||null,birth_year_visible:r.birth_year_visible};await y.updateProfile(t)?g.notify({type:"positive",message:o("profile.updateSuccess")}):g.notify({type:"negative",message:o("profile.updateError")})};return H(()=>{u()}),(t,v)=>(c(),w(he,{class:"q-pa-md"},{default:s(()=>[d("div",al,m(t.$t("profile.title")),1),d("div",tl,[d("div",il,[e(E,null,{default:s(()=>[e(P,{class:"text-center"},{default:s(()=>[e(_e,{size:"100px",color:"primary","text-color":"white"},{default:s(()=>[n(y).profile?.avatar_url?(c(),Q("img",{key:0,src:n(y).profile.avatar_url},null,8,ol)):(c(),Q("span",rl,m(F(n(y).profile)),1))]),_:1}),d("div",sl,m(D(n(y).profile)),1),n(y).profile?.username?(c(),Q("div",nl," @"+m(n(y).profile.username),1)):V("",!0),d("div",ul,m(n(y).profile?.email),1)]),_:1}),e(P,null,{default:s(()=>[e(j,{onSubmit:b,class:"q-gutter-md"},{default:s(()=>[e(S,{modelValue:r.name,"onUpdate:modelValue":v[0]||(v[0]=_=>r.name=_),label:t.$t("common.name"),outlined:"",rules:[p]},null,8,["modelValue","label","rules"]),e(S,{modelValue:r.surname,"onUpdate:modelValue":v[1]||(v[1]=_=>r.surname=_),label:t.$t("common.surname"),outlined:"",rules:[p]},null,8,["modelValue","label","rules"]),e(S,{modelValue:r.username,"onUpdate:modelValue":v[2]||(v[2]=_=>r.username=_),label:t.$t("common.username"),outlined:"",rules:[f]},null,8,["modelValue","label","rules"]),e(S,{modelValue:r.date_of_birth,"onUpdate:modelValue":v[3]||(v[3]=_=>r.date_of_birth=_),label:t.$t("profile.dateOfBirth"),type:"date",outlined:""},null,8,["modelValue","label"]),e(O,{modelValue:r.birth_year_visible,"onUpdate:modelValue":v[4]||(v[4]=_=>r.birth_year_visible=_),label:t.$t("profile.showBirthYear")},null,8,["modelValue","label"]),d("div",dl,[e($,{label:t.$t("common.cancel"),color:"grey",flat:"",onClick:u},null,8,["label"]),e($,{type:"submit",label:t.$t("common.save"),color:"primary",loading:n(y).isLoading},null,8,["label","loading"])])]),_:1})]),_:1})]),_:1}),e(E,{class:"q-mt-md"},{default:s(()=>[e(P,null,{default:s(()=>[d("div",ml,m(t.$t("notifications.title")),1),e(Be)]),_:1})]),_:1}),d("div",fl,[e(ll)])])])]),_:1}))}});export{Ul as default};
