import{a as j,u as pe,i as b,o,w as i,e as s,f as p,c as l,$ as U,a3 as J,t as u,_ as x,j as D,Q as v,m as ve,a2 as S,r as A,h as G,x as he,C as ye,g as N,k as X,a1 as L,aj as ge,ak as _e}from"./index-v3dJaZ__.js";import{a as ee,Q as $e,b as be,d as te,c as qe}from"./QTabPanels-BcHkYdl7.js";import{Q as M,a as E}from"./QCard-DrepD2Zh.js";import{Q as ke}from"./QInput-Dh94ShZM.js";import{Q as we,a as B,b as se}from"./QItem-BDA4BMIc.js";import{Q as Ce}from"./QList-DxbSl74n.js";import{Q as K}from"./QCardActions-D6RI1XRp.js";import{_ as ae,Q as Qe}from"./_plugin-vue_export-helper-BQNK_z4Q.js";import{Q as Fe}from"./QPage-BLObdsd1.js";import{u as re}from"./use-quasar-BZCkzfFx.js";import{u as Re}from"./auth-store-CNvokGra.js";import{u as Ae}from"./useFriends-CKGLbup-.js";import{u as ne}from"./vue-i18n.runtime-CRONN3rO.js";import"./focus-manager-DoxIdHOn.js";import"./selection-DGVMR2Dj.js";import"./use-dark-DTQKqGAg.js";import"./use-prevent-scroll-D_Baba9B.js";import"./supabase-CI4kAcGq.js";const xe=["src"],De={key:1},Se={class:"text-h6 q-mt-md"},Ve={key:0,class:"text-subtitle2 text-grey-6"},Ie={key:1,class:"text-body2 text-grey-7 q-mt-sm"},Pe=j({__name:"FriendCard",props:{friend:{},friendshipId:{}},emits:["remove"],setup(V,{emit:m}){const c=V,d=m,y=re(),q=pe(),{t:r}=ne(),f=n=>n.name&&n.surname?`${n.name} ${n.surname}`:n.username||n.email,g=n=>n.name&&n.surname?`${n.name.charAt(0)}${n.surname.charAt(0)}`:n.username?n.username.charAt(0).toUpperCase():n.email.charAt(0).toUpperCase(),_=(n,I)=>{const k=new Date(n),w=k.getDate(),C=k.getMonth()+1,T=k.getFullYear();return I?`${w}. ${C}. ${T}`:`${w}. ${C}.`},h=()=>{q.push(`/wishes/${c.friend.id}`)},z=()=>{y.dialog({title:r("friends.removeFriend"),message:`Opravdu chcete odebrat ${f(c.friend)} z přátel?`,cancel:!0,persistent:!0}).onOk(()=>{d("remove",c.friendshipId)})};return(n,I)=>(o(),b(M,{class:"friend-card",style:{width:"100%","max-width":"300px"}},{default:i(()=>[s(E,{class:"text-center"},{default:i(()=>[s(J,{size:"80px",color:"primary","text-color":"white"},{default:i(()=>[n.friend.avatar_url?(o(),l("img",{key:0,src:n.friend.avatar_url},null,8,xe)):(o(),l("span",De,u(g(n.friend)),1))]),_:1}),p("div",Se,u(f(n.friend)),1),n.friend.username?(o(),l("div",Ve,"@"+u(n.friend.username),1)):U("",!0),n.friend.date_of_birth?(o(),l("div",Ie,[s(D,{name:"cake",size:"16px",class:"q-mr-xs"}),x(" "+u(_(n.friend.date_of_birth,n.friend.birth_year_visible)),1)])):U("",!0)]),_:1}),s(K,{align:"center"},{default:i(()=>[s(v,{color:"primary",flat:"",icon:"card_giftcard",label:n.$t("wishes.viewWishes"),onClick:h},null,8,["label"]),s(v,{color:"negative",flat:"",icon:"person_remove",onClick:z})]),_:1})]),_:1}))}}),Ne=ae(Pe,[["__scopeId","data-v-791d7f96"]]),Ue=["src"],Ee={key:1},ze={class:"text-h6 q-mt-md"},Te={key:0,class:"text-subtitle2 text-grey-6"},Oe={class:"text-body2 text-grey-7 q-mt-sm"},Le={class:"text-caption text-grey-6 q-mt-xs"},Be=j({__name:"PendingRequestCard",props:{request:{}},emits:["accept","decline","cancel"],setup(V){const m=V,c=ve(()=>m.request.type==="incoming"?m.request.user:m.request.friend),d=r=>r.name&&r.surname?`${r.name} ${r.surname}`:r.username||r.email,y=r=>r.name&&r.surname?`${r.name.charAt(0)}${r.surname.charAt(0)}`:r.username?r.username.charAt(0).toUpperCase():r.email.charAt(0).toUpperCase(),q=r=>{const f=new Date(r),_=Math.abs(new Date().getTime()-f.getTime()),h=Math.ceil(_/(1e3*60*60*24));return h===1?"Dnes":h===2?"Včera":h<7?`Před ${h} dny`:f.toLocaleDateString("cs-CZ")};return(r,f)=>(o(),b(M,{class:"pending-card",style:{width:"100%","max-width":"300px"}},{default:i(()=>[s(E,{class:"text-center"},{default:i(()=>[s(J,{size:"60px",color:"primary","text-color":"white"},{default:i(()=>[c.value.avatar_url?(o(),l("img",{key:0,src:c.value.avatar_url},null,8,Ue)):(o(),l("span",Ee,u(y(c.value)),1))]),_:1}),p("div",ze,u(d(c.value)),1),c.value.username?(o(),l("div",Te," @"+u(c.value.username),1)):U("",!0),p("div",Oe,[s(D,{name:"schedule",size:"16px",class:"q-mr-xs"}),x(" "+u(q(r.request.created_at)),1)]),p("div",Le,u(r.request.type==="incoming"?"Požadavek od uživatele":"Odeslaný požadavek"),1)]),_:1}),s(K,{align:"center"},{default:i(()=>[r.request.type==="incoming"?(o(),l(S,{key:0},[s(v,{color:"positive",flat:"",icon:"check",label:"Přijmout",onClick:f[0]||(f[0]=g=>r.$emit("accept",r.request.id))}),s(v,{color:"negative",flat:"",icon:"close",label:"Odmítnout",onClick:f[1]||(f[1]=g=>r.$emit("decline",r.request.id))})],64)):(o(),l(S,{key:1},[s(v,{color:"grey",flat:"",icon:"schedule",label:"Čeká na odpověď",disabled:""}),s(v,{color:"negative",flat:"",icon:"close",label:"Zrušit",onClick:f[2]||(f[2]=g=>r.$emit("cancel",r.request.id))})],64))]),_:1})]),_:1}))}}),je=ae(Be,[["__scopeId","data-v-58c867e1"]]),Je={class:"row justify-between items-center q-mb-md"},Me={class:"text-h4"},Ke={key:0,class:"flex justify-center"},We={key:1,class:"text-center text-grey-6 q-py-lg"},Ze={class:"text-h6 q-mt-md"},He={key:2,class:"row q-gutter-md"},Ye={key:0,class:"flex justify-center"},Ge={key:1,class:"text-center text-grey-6 q-py-lg"},Xe={class:"text-h6 q-mt-md"},et={key:2,class:"row q-gutter-md"},tt={class:"text-h6"},st={key:0,class:"q-mt-md"},at={class:"text-subtitle2 q-mb-sm"},qt=j({__name:"FriendsPage",setup(V){const m=re(),{t:c}=ne(),d=Re(),{friends:y,friendships:q,isLoading:r,sendFriendRequest:f,acceptFriendRequest:g,declineFriendRequest:_,fetchFriends:h,fetchPendingRequests:z,searchUsers:n,removeFriend:I,resetLoadingState:k,subscribeToFriendships:w,subscribeToPendingRequests:C,unsubscribeFromFriendships:T}=Ae(),P=A("friends"),Q=A(!1),$=A(""),F=A([]),R=A([]),ie=e=>e.name&&e.surname?`${e.name} ${e.surname}`:e.username||e.email,oe=e=>e.name&&e.surname?`${e.name.charAt(0)}${e.surname.charAt(0)}`:e.username?e.username.charAt(0).toUpperCase():e.email.charAt(0).toUpperCase(),W=()=>{$.value="",F.value=[]},de=e=>d.user&&q.value.find(a=>a.user_id===d.user.id&&a.friend_id===e||a.friend_id===d.user.id&&a.user_id===e)?.id||"",O=async()=>{if($.value.trim().length<2){F.value=[];return}const e=await n($.value);if(e.data){const t=y.value.map(a=>a.id);F.value=e.data.filter(a=>a.id!==d.user?.id&&!t.includes(a.id))}},Z=async e=>{if(!d.user)return;const t=await f(e,d.user.id);t.error?m.notify({type:"negative",message:c("friends.sendRequestError")+": "+(t.error instanceof Error?t.error.message:JSON.stringify(t.error))}):(m.notify({type:"positive",message:c("friends.sendRequestSuccess")}),Q.value=!1,W())},le=async e=>{if(!d.user)return;const t=await g(e,d.user.id);t.error?m.notify({type:"negative",message:c("friends.acceptRequestError")+": "+(t.error instanceof Error?t.error.message:JSON.stringify(t.error))}):m.notify({type:"positive",message:c("friends.acceptRequestSuccess")})},ue=async e=>{const t=await _(e);t.error?m.notify({type:"negative",message:c("friends.declineRequestError")+": "+(t.error instanceof Error?t.error.message:JSON.stringify(t.error))}):m.notify({type:"positive",message:c("friends.declineRequestSuccess")})},ce=async e=>{const t=await _(e);t.error?m.notify({type:"negative",message:"Chyba při rušení požadavku: "+(t.error instanceof Error?t.error.message:JSON.stringify(t.error))}):m.notify({type:"positive",message:"Požadavek byl zrušen."})},me=async e=>{if(!d.user)return;const t=await I(e,d.user.id);t.error?m.notify({type:"negative",message:"Chyba při odstraňování přítele: "+(t.error instanceof Error?t.error.message:JSON.stringify(t.error))}):m.notify({type:"positive",message:"Přítel odstraněn."})},H=async()=>{if(!d.user)return;const e=await z(d.user.id);e?.data&&(R.value=e.data)};G(async()=>{if(d.user){const e=y.value.length>0;await h(d.user.id,e),await H(),w(d.user.id),C(d.user.id,t=>{R.value=t})}}),he(()=>d.user,async(e,t)=>{console.log("👤 User watch triggered - newUser:",e?.id,"oldUser:",t?.id),e&&t&&e.id!==t.id&&(console.log("👤 User actually changed, refetching data"),await h(e.id,!0),await H(),w(e.id),C(e.id,a=>{R.value=a}))});const Y=()=>{!document.hidden&&d.user&&r.value&&k(d.user.id)};return G(()=>{document.addEventListener("visibilitychange",Y)}),ye(()=>{document.removeEventListener("visibilitychange",Y),T()}),(e,t)=>(o(),b(Fe,{class:"q-pa-md"},{default:i(()=>[p("div",Je,[p("div",Me,u(e.$t("friends.title")),1),s(v,{color:"primary",icon:"person_add",label:e.$t("friends.addFriend"),onClick:t[0]||(t[0]=a=>Q.value=!0)},null,8,["label"])]),s($e,{modelValue:P.value,"onUpdate:modelValue":t[1]||(t[1]=a=>P.value=a),class:"text-primary q-mb-md"},{default:i(()=>[s(ee,{name:"friends",label:e.$t("friends.myFriends")},null,8,["label"]),s(ee,{name:"pending",label:e.$t("friends.requests")},null,8,["label"])]),_:1},8,["modelValue"]),s(be),s(qe,{modelValue:P.value,"onUpdate:modelValue":t[2]||(t[2]=a=>P.value=a),animated:""},{default:i(()=>[s(te,{name:"friends"},{default:i(()=>[N(r)?(o(),l("div",Ke,[s(X,{size:"lg"})])):N(y).length===0?(o(),l("div",We,[s(D,{name:"people",size:"4rem"}),p("div",Ze,u(e.$t("friends.noFriends")),1),p("div",null,u(e.$t("friends.addFirstFriend")),1)])):(o(),l("div",He,[(o(!0),l(S,null,L(N(y),a=>(o(),b(Ne,{key:a.id,friend:a,"friendship-id":de(a.id),onRemove:me},null,8,["friend","friendship-id"]))),128))]))]),_:1}),s(te,{name:"pending"},{default:i(()=>[N(r)?(o(),l("div",Ye,[s(X,{size:"lg"})])):R.value.length===0?(o(),l("div",Ge,[s(D,{name:"inbox",size:"4rem"}),p("div",Xe,u(e.$t("friends.noRequests")),1),p("div",null,u(e.$t("friends.noRequestsDescription")),1)])):(o(),l("div",et,[(o(!0),l(S,null,L(R.value,a=>(o(),b(je,{key:a.id,request:a,onAccept:le,onDecline:ue,onCancel:ce},null,8,["request"]))),128))]))]),_:1})]),_:1},8,["modelValue"]),s(Qe,{modelValue:Q.value,"onUpdate:modelValue":t[5]||(t[5]=a=>Q.value=a),onHide:W},{default:i(()=>[s(M,{style:{width:"100%","max-width":"500px"}},{default:i(()=>[s(E,null,{default:i(()=>[p("div",tt,u(e.$t("friends.addFriend")),1)]),_:1}),s(E,null,{default:i(()=>[s(ke,{modelValue:$.value,"onUpdate:modelValue":t[3]||(t[3]=a=>$.value=a),label:e.$t("friends.searchUsers"),outlined:"",placeholder:e.$t("friends.searchPlaceholder"),onInput:O,onKeyup:ge(O,["enter"])},{prepend:i(()=>[s(D,{name:"search"})]),append:i(()=>[s(v,{flat:"",round:"",icon:"search",onClick:O,disabled:$.value.length<2},null,8,["disabled"])]),_:1},8,["modelValue","label","placeholder"]),F.value.length>0?(o(),l("div",st,[p("div",at,u(e.$t("friends.searchResults"))+":",1),s(Ce,null,{default:i(()=>[(o(!0),l(S,null,L(F.value,a=>(o(),b(we,{key:a.id,clickable:"",onClick:fe=>Z(a.id)},{default:i(()=>[s(B,{avatar:""},{default:i(()=>[s(J,{color:"primary","text-color":"white"},{default:i(()=>[x(u(oe(a)),1)]),_:2},1024)]),_:2},1024),s(B,null,{default:i(()=>[s(se,null,{default:i(()=>[x(u(ie(a)),1)]),_:2},1024),s(se,{caption:""},{default:i(()=>[x(u(a.username||a.email),1)]),_:2},1024)]),_:2},1024),s(B,{side:""},{default:i(()=>[s(v,{color:"primary",flat:"",round:"",icon:"person_add",onClick:_e(fe=>Z(a.id),["stop"])},null,8,["onClick"])]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})])):U("",!0)]),_:1}),s(K,{align:"right"},{default:i(()=>[s(v,{label:e.$t("common.cancel"),color:"grey",flat:"",onClick:t[4]||(t[4]=a=>Q.value=!1)},null,8,["label"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});export{qt as default};
