import{a as g,Q}from"./QCard-BCQpJOfr.js";import{Q as h}from"./QSeparator-Bbkzzv40.js";import{a as U,r as v,b as S,i as D,w as c,o as N,f as u,e,c as B,a1 as P,t as f,g as _,Q as p,_ as k,j as q}from"./index-Pn9jnbFE.js";import{Q as m}from"./QInput-C7WvCVR3.js";import{Q as E}from"./QForm-BHxn8Jph.js";import{Q as x}from"./QPage-DWfzfX4w.js";import{u as A}from"./use-quasar-H_JTtl5v.js";import{u as F}from"./usePushNotifications-Bg3LGWxC.js";import{u as O}from"./auth-store-CJRvYrr9.js";import{supabase as G}from"./supabase-0ODH-3DI.js";import{N as K}from"./NotificationSettings-Bs-f5dlJ.js";import{u as L}from"./vue-i18n.runtime-yAy4rlbr.js";import"./use-dark-DBhXlj6i.js";import"./focus-manager-B6BPwZIb.js";import"./QChip-mklSEZmv.js";import"./QCardActions-Bd8qZCxV.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const M={class:"q-pa-md",style:{"max-width":"600px",width:"100%"}},H={class:"text-h4 text-center q-mb-md"},j={class:"text-body1 text-center text-grey-6 q-mb-lg"},J={key:0},z={class:"text-h6 q-mb-md"},X={class:"q-gutter-md"},Y={class:"text-h6 q-mb-md"},Z={class:"text-h6 q-mb-md text-warning"},oo={class:"bg-warning text-dark q-pa-md rounded-borders"},vo=U({__name:"NotificationsPage",setup(io){const b=A(),{t:s}=L(),n=F(),V=O(),r=v(!1),y=v(!1),a=S({title:"",body:"",url:""}),l=S({title:"",body:"",url:""}),C=async()=>{if(n.isSubscribed.value){r.value=!0;try{const o=await n.getCurrentSubscription();if(!o)throw new Error("No subscription found");await n.sendNotification(o,{title:a.title,body:a.body,icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"custom-notification",data:{type:"custom",url:a.url||"/",timestamp:Date.now()}}),a.title="",a.body="",a.url=""}catch(o){console.error("Error sending custom notification:",o)}finally{r.value=!1}}},$=async()=>{if(n.isSubscribed.value){r.value=!0;try{const o=await n.getCurrentSubscription();if(!o)throw new Error("No subscription found");await n.sendNotification(o,{title:s("notifications.wishNotificationTitle"),body:s("notifications.wishNotificationBody"),icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"new-wish",data:{type:"wish",url:"/wishes",timestamp:Date.now()},actions:[{action:"view",title:s("notifications.viewWishes")},{action:"dismiss",title:s("common.close")}]})}catch(o){console.error("Error sending wish notification:",o)}finally{r.value=!1}}},T=async()=>{if(n.isSubscribed.value){r.value=!0;try{const o=await n.getCurrentSubscription();if(!o)throw new Error("No subscription found");await n.sendNotification(o,{title:s("notifications.friendRequestTitle"),body:s("notifications.friendRequestBody"),icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"friend-request",data:{type:"friend-request",url:"/friends",timestamp:Date.now()},actions:[{action:"view",title:s("notifications.viewFriends")},{action:"dismiss",title:s("common.close")}]})}catch(o){console.error("Error sending friend request notification:",o)}finally{r.value=!1}}},W=async()=>{if(console.log("=== DEBUGGING PUSH NOTIFICATIONS ==="),console.log("Notification permission:",Notification.permission),"serviceWorker"in navigator){const i=await navigator.serviceWorker.ready;if(console.log("Service worker registered:",i),console.log("Service worker active:",i.active),console.log("Service worker scope:",i.scope),"pushManager"in i){const t=await i.pushManager.getSubscription();console.log("Push subscription:",t),t&&(console.log("Subscription endpoint:",t.endpoint),console.log("Subscription keys:",t.getKey?{p256dh:t.getKey("p256dh"),auth:t.getKey("auth")}:"getKey not available"))}else console.error("PushManager not available")}console.log("Push notifications composable:",n),console.log("Is subscribed:",n.isSubscribed.value),console.log("Forcing getCurrentSubscription call...");const o=await n.getCurrentSubscription();if(console.log("getCurrentSubscription returned:",o),console.log("Is subscribed after refresh:",n.isSubscribed.value),navigator.serviceWorker.addEventListener("message",i=>{console.log("Message from service worker:",i.data),i.data.type==="PUSH_EVENT_RECEIVED"&&console.log("ðŸŽ‰ Service worker received push event!",i.data)}),"serviceWorker"in navigator){const i=await navigator.serviceWorker.ready,t=await i.pushManager.getSubscription();if(console.log("=== SERVICE WORKER vs PUSH REGISTRATION ==="),console.log("SW Registration scope:",i.scope),console.log("SW Active worker:",i.active?.scriptURL),console.log("Push subscription endpoint:",t?.endpoint),t){console.log("Push subscription belongs to SW scope:",i.scope);try{const d=await navigator.serviceWorker.getRegistration();console.log("Default SW registration:",d?.scope),console.log("Are they the same?",i===d)}catch(d){console.error("Error getting default registration:",d)}}console.log("=== END SW DIAGNOSIS ===")}console.log("Testing direct notification...");try{if(Notification.permission==="granted"){const i=new Notification("Direct Test Notification",{body:"This is shown directly from the main thread",icon:"/icons/icon-192x192.png"});console.log("Direct notification created:",i)}}catch(i){console.error("Failed to create direct notification:",i)}console.log("Testing service worker notification...");try{"serviceWorker"in navigator&&(await(await navigator.serviceWorker.ready).showNotification("Service Worker Test",{body:"This is shown from service worker registration",icon:"/icons/icon-192x192.png"}),console.log("Service worker notification shown"))}catch(i){console.error("Failed to show service worker notification:",i)}if(!n.isSubscribed.value){console.error("Not subscribed to push notifications");return}r.value=!0;try{const i=await n.getCurrentSubscription();if(console.log("Subscription found:",i),!i)throw new Error("No subscription found");await n.sendNotification(i,{title:s("notifications.birthdayTitle"),body:s("notifications.birthdayBody"),icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"birthday",data:{type:"birthday",url:"/friends",timestamp:Date.now()},actions:[{action:"view",title:s("notifications.viewProfile")},{action:"dismiss",title:s("common.close")}]})}catch(i){console.error("Error sending birthday notification:",i)}finally{r.value=!1}},R=async()=>{y.value=!0;try{const{data:o,error:i}=await G.from("push_subscriptions").select("subscription_data").eq("is_active",!0);if(i)throw i;if(!o||o.length===0){b.notify({type:"warning",message:s("notifications.noSubscriptions"),timeout:3e3});return}let t=0,d=0;for(const I of o)try{const w={toJSON:()=>I.subscription_data};await n.sendNotification(w,{title:l.title,body:l.body,icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"admin-broadcast",data:{type:"admin-broadcast",url:l.url||"/",timestamp:Date.now()}}),t++}catch(w){console.error("Error sending to subscription:",w),d++}b.notify({type:t>0?"positive":"negative",message:s("notifications.broadcastResult",{success:t,errors:d}),timeout:5e3}),t>0&&(l.title="",l.body="",l.url="")}catch(o){console.error("Error sending admin notification:",o),b.notify({type:"negative",message:s("notifications.broadcastError"),timeout:5e3})}finally{y.value=!1}};return(o,i)=>(N(),D(x,{class:"flex flex-center"},{default:c(()=>[u("div",M,[e(Q,null,{default:c(()=>[e(g,null,{default:c(()=>[u("div",H,f(o.$t("notifications.title")),1),u("div",j,f(o.$t("notifications.pageDescription")),1)]),_:1}),e(g,null,{default:c(()=>[e(K)]),_:1}),_(V).user?.email==="pichalek@gmail.com"?(N(),B("div",J,[e(g,null,{default:c(()=>[e(h,{class:"q-mb-md"}),u("div",z,f(o.$t("notifications.quickActions")),1),u("div",X,[e(p,{color:"primary",icon:"card_giftcard",label:o.$t("notifications.notifyNewWish"),onClick:$,loading:r.value,class:"full-width"},null,8,["label","loading"]),e(p,{color:"secondary",icon:"group",label:o.$t("notifications.notifyFriendRequest"),onClick:T,loading:r.value,class:"full-width"},null,8,["label","loading"]),e(p,{color:"accent",icon:"celebration",label:o.$t("notifications.notifyBirthday"),onClick:W,loading:r.value,class:"full-width"},null,8,["label","loading"])])]),_:1}),e(g,null,{default:c(()=>[e(h,{class:"q-mb-md"}),u("div",Y,f(o.$t("notifications.customNotification")),1),e(E,{onSubmit:C,class:"q-gutter-md"},{default:c(()=>[e(m,{modelValue:a.title,"onUpdate:modelValue":i[0]||(i[0]=t=>a.title=t),label:o.$t("notifications.notificationTitle"),outlined:"",rules:[t=>!!t||o.$t("common.required")]},null,8,["modelValue","label","rules"]),e(m,{modelValue:a.body,"onUpdate:modelValue":i[1]||(i[1]=t=>a.body=t),label:o.$t("notifications.notificationBody"),outlined:"",type:"textarea",rows:"3",rules:[t=>!!t||o.$t("common.required")]},null,8,["modelValue","label","rules"]),e(m,{modelValue:a.url,"onUpdate:modelValue":i[2]||(i[2]=t=>a.url=t),label:o.$t("notifications.targetUrl"),outlined:"",placeholder:"/wishes",hint:"Optional URL to open when notification is clicked"},null,8,["modelValue","label"]),e(p,{type:"submit",color:"primary",icon:"send",label:o.$t("notifications.sendCustom"),loading:r.value,class:"full-width"},null,8,["label","loading"])]),_:1})]),_:1}),e(g,null,{default:c(()=>[e(h,{class:"q-mb-md"}),u("div",Z,[e(q,{name:"admin_panel_settings",class:"q-mr-sm"}),k(" "+f(o.$t("notifications.adminSection")),1)]),e(E,{onSubmit:R,class:"q-gutter-md"},{default:c(()=>[e(m,{modelValue:l.title,"onUpdate:modelValue":i[3]||(i[3]=t=>l.title=t),label:o.$t("notifications.notificationTitle"),outlined:"",rules:[t=>!!t||o.$t("common.required")]},null,8,["modelValue","label","rules"]),e(m,{modelValue:l.body,"onUpdate:modelValue":i[4]||(i[4]=t=>l.body=t),label:o.$t("notifications.notificationBody"),outlined:"",type:"textarea",rows:"3",rules:[t=>!!t||o.$t("common.required")]},null,8,["modelValue","label","rules"]),e(m,{modelValue:l.url,"onUpdate:modelValue":i[5]||(i[5]=t=>l.url=t),label:o.$t("notifications.targetUrl"),outlined:"",placeholder:"/"},null,8,["modelValue","label"]),u("div",oo,[e(q,{name:"warning",class:"q-mr-sm"}),k(" "+f(o.$t("notifications.adminWarning")),1)]),e(p,{type:"submit",color:"warning",icon:"campaign",label:o.$t("notifications.sendToAll"),loading:y.value,class:"full-width"},null,8,["label","loading"])]),_:1})]),_:1})])):P("",!0)]),_:1})])]),_:1}))}});export{vo as default};
