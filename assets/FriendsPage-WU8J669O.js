import{a as T,u as ce,n as y,o as i,Q as L,w as r,e as a,g as c,ax as z,c as d,t as l,at as P,f as S,v as me,ak as D,p as V,j as v,au as w,aw as ee,r as C,m as Z,E as fe,J as pe,h as ve,k as A,q as G,av as E,i as ge,aC as ye,aB as he,aD as _e}from"./index-DcT2ux80.js";import{a as W,Q as qe}from"./QTabs-DCHTPDvP.js";import{a as X,Q as $e}from"./QTabPanels-BCB2q8q2.js";import{Q as be,a as N,b as Y}from"./QItem-DoA9z5g1.js";import{Q as ke}from"./QList-AwKcHZ4O.js";import{Q as Ce}from"./QPage-BNSETTxJ.js";import{u as we}from"./use-quasar-B4nle0bC.js";import{u as Qe}from"./auth-store-BSTOyDR1.js";import{u as Fe}from"./useFriends-znGoRx1w.js";import{Q as Re}from"./QBadge-BRupl23o.js";import{_ as te}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{u as Ae}from"./vue-i18n.runtime-EzKfoaH7.js";import"./QResizeObserver-D8BsG4LP.js";import"./rtl-DFPa-2ov.js";import"./touch-BjYP5sR0.js";import"./selection-kdsaOv7s.js";import"./supabase-DkOw_aOL.js";const De={class:"row items-center q-gutter-md"},Ve=["src"],Pe={key:1},Se={class:"friend-info flex-1"},xe={class:"row items-center q-gutter-sm"},Ie={class:"text-h6 friend-name"},Ee={key:0,class:"text-subtitle2 text-grey-6"},Ne=T({__name:"FriendCard",props:{friend:{},friendshipId:{}},setup(Q){const m=Q,u=ce(),o=()=>{u.push(`/friend/${m.friend.id}`)},p=t=>t.name&&t.surname?`${t.name} ${t.surname}`:t.username||t.email,q=t=>t.name&&t.surname?`${t.name.charAt(0)}${t.surname.charAt(0)}`:t.username?t.username.charAt(0).toUpperCase():t.email.charAt(0).toUpperCase();return(t,f)=>(i(),y(L,{class:"friend-card",onClick:o},{default:r(()=>[a(S,{class:"friend-card-content"},{default:r(()=>[c("div",De,[a(z,{size:"50px",color:"primary","text-color":"white"},{default:r(()=>[t.friend.avatar_url?(i(),d("img",{key:0,src:t.friend.avatar_url},null,8,Ve)):(i(),d("span",Pe,l(q(t.friend)),1))]),_:1}),c("div",Se,[c("div",xe,[c("div",Ie,l(p(t.friend)),1),t.friend.is_dummy?(i(),y(Re,{key:0,color:"orange",label:t.$t("dummyProfiles.dummy"),rounded:""},null,8,["label"])):P("",!0)]),t.friend.username?(i(),d("div",Ee," @"+l(t.friend.username),1)):P("",!0)])])]),_:1})]),_:1}))}}),Te=te(Ne,[["__scopeId","data-v-1cbed078"]]),Le=["src"],ze={key:1},Be={class:"text-h6 q-mt-md"},Ue={key:0,class:"text-subtitle2 text-grey-6"},Oe={class:"text-body2 text-grey-7 q-mt-sm"},je={class:"text-caption text-grey-6 q-mt-xs"},Je=T({__name:"PendingRequestCard",props:{request:{}},emits:["accept","decline","cancel"],setup(Q){const m=Q,u=me(()=>m.request.type==="incoming"?m.request.user:m.request.friend),o=t=>t.name&&t.surname?`${t.name} ${t.surname}`:t.username||t.email,p=t=>t.name&&t.surname?`${t.name.charAt(0)}${t.surname.charAt(0)}`:t.username?t.username.charAt(0).toUpperCase():t.email.charAt(0).toUpperCase(),q=t=>{const f=new Date(t),F=Math.abs(new Date().getTime()-f.getTime()),g=Math.ceil(F/(1e3*60*60*24));return g===1?"Dnes":g===2?"Včera":g<7?`Před ${g} dny`:f.toLocaleDateString("cs-CZ")};return(t,f)=>(i(),y(L,{class:"pending-card",style:{width:"100%","max-width":"300px"}},{default:r(()=>[a(S,{class:"text-center"},{default:r(()=>[a(z,{size:"60px",color:"primary","text-color":"white"},{default:r(()=>[u.value.avatar_url?(i(),d("img",{key:0,src:u.value.avatar_url},null,8,Le)):(i(),d("span",ze,l(p(u.value)),1))]),_:1}),c("div",Be,l(o(u.value)),1),u.value.username?(i(),d("div",Ue," @"+l(u.value.username),1)):P("",!0),c("div",Oe,[a(V,{name:"schedule",size:"16px",class:"q-mr-xs"}),D(" "+l(t.request.created_at?q(t.request.created_at):"N/A"),1)]),c("div",je,l(t.request.type==="incoming"?"Požadavek od uživatele":"Odeslaný požadavek"),1)]),_:1}),a(ee,{align:"center"},{default:r(()=>[t.request.type==="incoming"?(i(),d(w,{key:0},[a(v,{color:"positive",flat:"",icon:"check",label:"Přijmout",onClick:f[0]||(f[0]=$=>t.$emit("accept",t.request.id))}),a(v,{color:"negative",flat:"",icon:"close",label:"Odmítnout",onClick:f[1]||(f[1]=$=>t.$emit("decline",t.request.id))})],64)):(i(),d(w,{key:1},[a(v,{color:"grey",flat:"",icon:"schedule",label:"Čeká na odpověď",disabled:""}),a(v,{color:"negative",flat:"",icon:"close",label:"Zrušit",onClick:f[2]||(f[2]=$=>t.$emit("cancel",t.request.id))})],64))]),_:1})]),_:1}))}}),Me=te(Je,[["__scopeId","data-v-6f1ce8f2"]]),He={class:"row justify-between items-center q-mb-md"},Ke={class:"text-h4"},Ze={key:0,class:"flex justify-center"},Ge={key:1,class:"text-center text-grey-6 q-py-lg"},We={class:"text-h6 q-mt-md"},Xe={key:2,class:"row q-gutter-md"},Ye={key:0,class:"flex justify-center"},et={key:1,class:"text-center text-grey-6 q-py-lg"},tt={class:"text-h6 q-mt-md"},st={key:2,class:"row q-gutter-md"},at={class:"text-h6"},nt={key:0,class:"q-mt-md"},rt={class:"text-subtitle2 q-mb-sm"},kt=T({__name:"FriendsPage",setup(Q){const m=we(),{t:u}=Ae(),o=Qe(),{friends:p,friendships:q,isLoading:t,sendFriendRequest:f,acceptFriendRequest:$,declineFriendRequest:F,fetchFriends:g,fetchPendingRequests:se,searchUsers:ae,resetLoadingState:x,subscribeToFriendships:B,subscribeToPendingRequests:U,unsubscribeFromFriendships:O}=Fe(),R=C("friends"),b=C(!1),h=C(""),k=C([]),_=C([]),ne=e=>e.name&&e.surname?`${e.name} ${e.surname}`:e.username||e.email,re=e=>e.name&&e.surname?`${e.name.charAt(0)}${e.surname.charAt(0)}`:e.username?e.username.charAt(0).toUpperCase():e.email.charAt(0).toUpperCase(),j=()=>{h.value="",k.value=[]},ie=e=>o.user&&q.value.find(n=>n.user_id===o.user.id&&n.friend_id===e||n.friend_id===o.user.id&&n.user_id===e)?.id||"",I=async()=>{if(h.value.trim().length<2){k.value=[];return}const e=await ae(h.value);if(e.data){const s=p.value.map(n=>n.id);k.value=e.data.filter(n=>n.id!==o.user?.id&&!s.includes(n.id))}},J=async e=>{if(!o.user)return;const s=await f(e,o.user.id);s.error?m.notify({type:"negative",message:u("friends.sendRequestError")+": "+(s.error instanceof Error?s.error.message:JSON.stringify(s.error))}):(m.notify({type:"positive",message:u("friends.sendRequestSuccess")}),b.value=!1,j())},oe=async e=>{if(!o.user)return;const s=await $(e,o.user.id);s.error?m.notify({type:"negative",message:u("friends.acceptRequestError")+": "+(s.error instanceof Error?s.error.message:JSON.stringify(s.error))}):m.notify({type:"positive",message:u("friends.acceptRequestSuccess")})},de=async e=>{const s=await F(e);s.error?m.notify({type:"negative",message:u("friends.declineRequestError")+": "+(s.error instanceof Error?s.error.message:JSON.stringify(s.error))}):m.notify({type:"positive",message:u("friends.declineRequestSuccess")})},le=async e=>{const s=await F(e);s.error?m.notify({type:"negative",message:"Chyba při rušení požadavku: "+(s.error instanceof Error?s.error.message:JSON.stringify(s.error))}):m.notify({type:"positive",message:"Požadavek byl zrušen."})},M=async()=>{if(o.user)try{const e=await se(o.user.id);e?.data&&(_.value=e.data)}catch(e){console.error("Error loading pending requests:",e),_.value=[]}},H=async e=>{if(e){console.log("Loading user data for:",e.id);try{const s=p.value.length>0;console.log("Has existing data:",s),await Promise.all([g(e.id,s),M()]),console.log("Data loaded successfully"),B(e.id),U(e.id,n=>{_.value=n})}catch(s){console.error("Error loading user data:",s),x()}}};Z(async()=>{o.user&&p.value.length===0&&await H(o.user),setTimeout(()=>{t.value&&(console.warn("Loading timeout reached, forcing reset"),x())},1e4)}),fe(()=>o.user,async(e,s)=>{e&&!s?await H(e):e&&s&&e.id!==s.id&&(O(),await g(e.id,!0),await M(),B(e.id),U(e.id,n=>{_.value=n}))});const K=()=>{!document.hidden&&o.user&&t.value&&x(o.user.id)};return Z(()=>{document.addEventListener("visibilitychange",K)}),pe(()=>{document.removeEventListener("visibilitychange",K),O()}),(e,s)=>(i(),y(Ce,{class:"q-pa-md"},{default:r(()=>[c("div",He,[c("div",Ke,l(e.$t("friends.title")),1),a(v,{color:"primary",icon:"person_add",label:e.$t("friends.addFriend"),onClick:s[0]||(s[0]=n=>b.value=!0)},null,8,["label"])]),a(qe,{modelValue:R.value,"onUpdate:modelValue":s[1]||(s[1]=n=>R.value=n),class:"text-primary q-mb-md"},{default:r(()=>[a(W,{name:"friends",label:e.$t("friends.myFriends")},null,8,["label"]),a(W,{name:"pending",label:e.$t("friends.requests")},null,8,["label"])]),_:1},8,["modelValue"]),a(ve),a($e,{modelValue:R.value,"onUpdate:modelValue":s[2]||(s[2]=n=>R.value=n),animated:""},{default:r(()=>[a(X,{name:"friends"},{default:r(()=>[A(t)?(i(),d("div",Ze,[a(G,{size:"lg"})])):A(p).length===0?(i(),d("div",Ge,[a(V,{name:"people",size:"4rem"}),c("div",We,l(e.$t("friends.noFriends")),1),c("div",null,l(e.$t("friends.addFirstFriend")),1)])):(i(),d("div",Xe,[(i(!0),d(w,null,E(A(p),n=>(i(),y(Te,{key:n.id,friend:n,"friendship-id":ie(n.id)},null,8,["friend","friendship-id"]))),128))]))]),_:1}),a(X,{name:"pending"},{default:r(()=>[A(t)?(i(),d("div",Ye,[a(G,{size:"lg"})])):_.value.length===0?(i(),d("div",et,[a(V,{name:"inbox",size:"4rem"}),c("div",tt,l(e.$t("friends.noRequests")),1),c("div",null,l(e.$t("friends.noRequestsDescription")),1)])):(i(),d("div",st,[(i(!0),d(w,null,E(_.value,n=>(i(),y(Me,{key:n.id,request:n,onAccept:oe,onDecline:de,onCancel:le},null,8,["request"]))),128))]))]),_:1})]),_:1},8,["modelValue"]),a(he,{modelValue:b.value,"onUpdate:modelValue":s[5]||(s[5]=n=>b.value=n),onHide:j},{default:r(()=>[a(L,{style:{width:"100%","max-width":"500px"}},{default:r(()=>[a(S,null,{default:r(()=>[c("div",at,l(e.$t("friends.addFriend")),1)]),_:1}),a(S,null,{default:r(()=>[a(ge,{modelValue:h.value,"onUpdate:modelValue":s[3]||(s[3]=n=>h.value=n),label:e.$t("friends.searchUsers"),outlined:"",placeholder:e.$t("friends.searchPlaceholder"),onInput:I,onKeyup:ye(I,["enter"])},{prepend:r(()=>[a(V,{name:"search"})]),append:r(()=>[a(v,{flat:"",round:"",icon:"search",onClick:I,disabled:h.value.length<2},null,8,["disabled"])]),_:1},8,["modelValue","label","placeholder"]),k.value.length>0?(i(),d("div",nt,[c("div",rt,l(e.$t("friends.searchResults"))+":",1),a(ke,null,{default:r(()=>[(i(!0),d(w,null,E(k.value,n=>(i(),y(be,{key:n.id,clickable:"",onClick:ue=>J(n.id)},{default:r(()=>[a(N,{avatar:""},{default:r(()=>[a(z,{color:"primary","text-color":"white"},{default:r(()=>[D(l(re(n)),1)]),_:2},1024)]),_:2},1024),a(N,null,{default:r(()=>[a(Y,null,{default:r(()=>[D(l(ne(n)),1)]),_:2},1024),a(Y,{caption:""},{default:r(()=>[D(l(n.username||n.email),1)]),_:2},1024)]),_:2},1024),a(N,{side:""},{default:r(()=>[a(v,{color:"primary",flat:"",round:"",icon:"person_add",onClick:_e(ue=>J(n.id),["stop"])},null,8,["onClick"])]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})])):P("",!0)]),_:1}),a(ee,{align:"right"},{default:r(()=>[a(v,{label:e.$t("common.cancel"),color:"grey",flat:"",onClick:s[4]||(s[4]=n=>b.value=!1)},null,8,["label"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});export{kt as default};
