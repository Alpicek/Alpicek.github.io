import{E as C,C as n,G as K,H as $,u as I,r as d,k as O}from"./index-DAJwJefL.js";import{u as Q}from"./auth-store-DgD84Utc.js";import{supabase as h}from"./supabase-C5qut0hh.js";const L=C({name:"QBtnGroup",props:{unelevated:Boolean,outline:Boolean,flat:Boolean,rounded:Boolean,square:Boolean,push:Boolean,stretch:Boolean,glossy:Boolean,spread:Boolean},setup(o,{slots:c}){const i=n(()=>{const s=["unelevated","outline","flat","rounded","square","push","stretch","glossy"].filter(r=>o[r]===!0).map(r=>`q-btn-group--${r}`).join(" ");return`q-btn-group row no-wrap${s.length!==0?" "+s:""}`+(o.spread===!0?" q-btn-group--spread":" inline")});return()=>K("div",{class:i.value},$(c.default))}}),U="https://pushserver-production.up.railway.app";function M(){const o=O(),{t:c}=I(),i=Q(),s=d(!1),r=d("default"),u=d(null),v=d(""),l=d(!1),p=()=>(s.value="serviceWorker"in navigator&&"PushManager"in window,s.value&&(r.value=Notification.permission),s.value),S=e=>{const t="=".repeat((4-e.length%4)%4),a=(e+t).replace(/-/g,"+").replace(/_/g,"/"),b=window.atob(a),m=new Uint8Array(b.length);for(let f=0;f<b.length;++f)m[f]=b.charCodeAt(f);return m},y=async()=>{const e=await fetch(`${U}/vapid-public-key`);if(!e.ok)throw new Error(`Failed to get VAPID key: ${e.statusText}`);const t=await e.text();return v.value=t,t},w=async()=>{if(!p())throw new Error("Push notifications are not supported");const e=await Notification.requestPermission();return r.value=e,e},_=async()=>{if(!p())throw new Error("Push notifications are not supported");if(r.value!=="granted"&&await w()!=="granted")throw new Error("Notification permission denied");l.value=!0;try{const e=await navigator.serviceWorker.ready;let t=v.value;t||(t=await y());const a=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:S(t)});return u.value=a,await B(a),o.notify({type:"positive",message:c("notifications.subscribedSuccess"),timeout:3e3}),a}catch(e){throw o.notify({type:"negative",message:c("notifications.subscribeError"),timeout:5e3}),e}finally{l.value=!1}},k=async()=>{if(!u.value)throw new Error("No active subscription");l.value=!0;try{await u.value.unsubscribe(),u.value=null,await P(),o.notify({type:"positive",message:c("notifications.unsubscribedSuccess"),timeout:3e3})}catch(e){throw o.notify({type:"negative",message:c("notifications.unsubscribeError"),timeout:5e3}),e}finally{l.value=!1}},P=async()=>{if(i.user?.id)try{const{error:e}=await h.from("push_subscriptions").delete().eq("user_id",i.user.id);if(e)throw e}catch{}},B=async e=>{if(i.user?.id)try{const t=e.toJSON(),{error:a}=await h.from("push_subscriptions").upsert({user_id:i.user.id,endpoint:t.endpoint||"",p256dh_key:t.keys?.p256dh||null,auth_key:t.keys?.auth||null,subscription_data:t,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{onConflict:"user_id"});if(a)throw a}catch{}},g=async()=>{if(!p())return null;try{const t=await(await navigator.serviceWorker.ready).pushManager.getSubscription();return u.value=t,t}catch{return null}},q=async()=>{p(),s.value&&(await g(),await y(),await E())},E=async()=>{if(i.user?.id)try{const{data:e,error:t}=await h.from("push_subscriptions").select("*").eq("user_id",i.user.id).eq("is_active",!0).limit(1).maybeSingle();if(t)return;e&&u.value}catch{}},D=n(()=>!!u.value),A=n(()=>s.value&&r.value!=="denied"),N=n(()=>r.value==="default");return{isSupported:n(()=>s.value),permission:n(()=>r.value),isSubscribed:D,canSubscribe:A,needsPermission:N,isLoading:n(()=>l.value),vapidPublicKey:n(()=>v.value),initialize:q,requestPermission:w,subscribe:_,unsubscribe:k,getCurrentSubscription:g,checkSupport:p}}export{L as Q,M as u};
