import{Q as R,b as w,a as ee,F as te}from"./FeedbackDetailDialog-D6pN2iTO.js";import{a as ae,u as se,r as c,C as oe,w as le,y as L,h as l,k as ne,o as p,g as v,e as h,f as o,t as f,q as d,p as B,aB as ie,v as F,n as re,Q as de,l as I,ab as ce,m as ue,aF as me,_ as fe}from"./index-BR5I7U9B.js";import{Q as pe}from"./QSelect-CC7M6R9u.js";import{Q as O}from"./QBadge-DErxSnF2.js";import{Q as ve}from"./QPage-BhHXWAMh.js";import{C as ge}from"./ClosePopup-ZLXO9D4Y.js";import{supabase as x}from"./supabase-C7Q3J7Aw.js";import{u as be}from"./auth-store-CLpI6O-q.js";import"./QList-D9VkAbJk.js";import"./QItem-C5GHLq0T.js";import"./format-SQJMwOX7.js";import"./position-engine-ClI9_kBB.js";import"./selection-CVaP_A9r.js";import"./rtl-DFPa-2ov.js";const ye={class:"row items-center q-mb-md"},he={class:"text-h5"},_e={key:1,class:"col"},ke={class:"row items-center q-gutter-sm"},we={class:"ellipsis-2-lines"},xe={key:0,class:"row items-center q-gutter-xs"},Se={key:1,class:"text-grey-6"},Qe={class:"q-pa-md text-grey"},Ce={class:"text-subtitle1"},Ve={key:0},Pe=["src"],De={key:1,class:"text-grey"},qe=ae({__name:"AdminFeedbackPage",setup(je){const{t:s}=se(),_=be(),g=ne(),S=c([]),k=c([]),b=c(["new","read","in_progress"]),y=c(!1),Q=c(""),z=c({page:1,rowsPerPage:25}),G=[{name:"created_at",label:s("feedback.created"),field:e=>e.created_at,align:"left",sortable:!0,format:e=>{if(typeof e!="string"||!e)return"";const a=new Date(e);if(Number.isNaN(a.getTime()))return e;const t=a.toLocaleDateString(void 0,{year:"numeric",month:"2-digit",day:"2-digit"}),n=a.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"});return`${t} ${n}`}},{name:"type",label:s("feedback.type"),field:"type",align:"left",sortable:!0},{name:"status",label:s("feedback.status"),field:"status",align:"left",sortable:!0},{name:"subject",label:s("feedback.subject"),field:"subject",align:"left"},{name:"message",label:s("feedback.message"),field:"message",align:"left"},{name:"screenshot",label:s("feedback.screenshot"),field:"screenshotPath",align:"center"}],C=c(!1),V=c(null),P=c(!1),r=c(null),D=c(!1),q=c(!1),T=["new","read","in_progress","resolved","dismissed"],A=T.map(e=>({label:s(`feedback.status_${e}`),value:e})),H=oe(()=>b.value.length===T.length?s("feedback.filterStatuses"):b.value.map(e=>s(`feedback.status_${e}`)).join(", ")),J=e=>s(`feedback.type${e.charAt(0).toUpperCase()}${e.slice(1)}`)||e,K=e=>{switch(e){case"bug":return"negative";case"idea":return"primary";default:return"grey"}},M=e=>{switch(e){case"new":return"orange";case"read":return"blue-grey";case"in_progress":return"info";case"resolved":return"positive";case"dismissed":return"negative";default:return"grey"}},j=async()=>{if(_.profile?.is_admin){y.value=!0;try{const{data:e,error:a}=await x.from("feedback").select("id, created_at, type, subject, message, context, user_id, status, admin_comment").order("created_at",{ascending:!1}).limit(300);if(a)throw a;const t=(e||[]).map(n=>{if(!n||typeof n!="object")return{id:"",created_at:"",type:"",subject:null,message:"",screenshotPath:null,user_id:null,status:"new"};const i=n;let u=null;const m=i.context;if(m&&typeof m=="object"&&"screenshot"in m&&m.screenshot&&typeof m.screenshot=="object"){const $=m.screenshot;$&&typeof $.path=="string"&&(u=$.path)}return{id:i.id,created_at:i.created_at,type:i.type,subject:i.subject??null,message:i.message,screenshotPath:u,user_id:i.user_id??null,status:i.status||"new",admin_comment:i.admin_comment??null}});k.value=t,U()}catch(e){console.error(e),g.notify({type:"negative",message:s("feedback.loadError")})}finally{y.value=!1}}},U=()=>{S.value=k.value.filter(e=>b.value.includes(e.status))},W=()=>j();le(b,()=>{U()});const E=async e=>{if(e.screenshotPath)try{const{data:a,error:t}=await x.storage.from("feedback").createSignedUrl(e.screenshotPath,60);if(t)throw t;V.value=a.signedUrl,C.value=!0}catch(a){console.error(a),g.notify({type:"negative",message:s("feedback.screenshotLoadError")})}},X=async e=>{r.value=e,P.value=!0,e.status==="new"&&await N(e,"read",!1)},N=async(e,a,t=!0)=>{if(_.profile?.is_admin){q.value=!0;try{const{data:n,error:i}=await x.from("feedback").update({status:a}).eq("id",e.id).select("id, status");if(i)throw i;if(!n||n.length===0)throw new Error("Update blocked by RLS or row missing");e.status=a;const u=k.value.find(m=>m.id===e.id);u&&(u.status=a),r.value?.id===e.id&&(r.value.status=a),U(),t&&g.notify({type:"positive",message:s("feedback.updated")})}catch(n){console.error(n),t&&g.notify({type:"negative",message:s("feedback.updateError")})}finally{q.value=!1}}},Y=()=>{j()},Z=async e=>{if(!(!_.profile?.is_admin||!r.value)){D.value=!0;try{const{data:a,error:t}=await x.from("feedback").update({admin_comment:e}).eq("id",r.value.id).select("id, admin_comment").single();if(t)throw t;r.value.admin_comment=a.admin_comment;const n=k.value.find(u=>u.id===r.value.id);n&&(n.admin_comment=a.admin_comment);const i=S.value.find(u=>u.id===r.value.id);i&&(i.admin_comment=a.admin_comment),g.notify({type:"positive",message:s("feedback.updated")})}catch(a){console.error(a),g.notify({type:"negative",message:s("feedback.updateError")})}finally{D.value=!1}}};return j(),(e,a)=>(p(),L(ve,{class:"q-pa-md column"},{default:l(()=>[v("div",ye,[v("div",he,f(d(s)("feedback.adminTitle")),1),o(R),o(B,{dense:"",flat:"",icon:"refresh",loading:y.value,onClick:W,disable:y.value,"aria-label":d(s)("common.reload")},null,8,["loading","disable","aria-label"])]),d(_).profile?.is_admin?(p(),h("div",_e,[o(ee,{dense:"",flat:"",rows:S.value,columns:G,"row-key":"id",loading:y.value,pagination:z.value,onRequest:Y,filter:Q.value,class:"feedback-table",onRowClick:a[2]||(a[2]=(t,n)=>X(n))},{"top-right":l(()=>[v("div",ke,[o(pe,{modelValue:b.value,"onUpdate:modelValue":a[0]||(a[0]=t=>b.value=t),options:d(A),"option-value":"value","option-label":"label","emit-value":"","map-options":"",multiple:"",dense:"",outlined:"",style:{"min-width":"200px"},"display-value":H.value,"aria-label":d(s)("feedback.filterStatuses")},null,8,["modelValue","options","display-value","aria-label"]),o(re,{dense:"",debounce:"300",modelValue:Q.value,"onUpdate:modelValue":a[1]||(a[1]=t=>Q.value=t),placeholder:d(s)("common.search")},null,8,["modelValue","placeholder"])])]),"body-cell-type":l(t=>[o(w,{props:t},{default:l(()=>[o(O,{color:K(t.row.type),outline:""},{default:l(()=>[F(f(J(t.row.type)),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-status":l(t=>[o(w,{props:t},{default:l(()=>[o(O,{color:M(t.row.status),outline:""},{default:l(()=>[F(f(d(s)(`feedback.status_${t.row.status}`)),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-message":l(t=>[o(w,{props:t,class:"wrap"},{default:l(()=>[v("div",we,f(t.row.message),1)]),_:2},1032,["props"])]),"body-cell-screenshot":l(t=>[o(w,{props:t},{default:l(()=>[t.row.screenshotPath?(p(),h("div",xe,[o(B,{dense:"",flat:"",size:"sm",icon:"image",label:d(s)("feedback.view"),onClick:n=>E(t.row)},null,8,["label","onClick"])])):(p(),h("div",Se,"â€”"))]),_:2},1032,["props"])]),"no-data":l(()=>[v("div",Qe,f(d(s)("feedback.none")),1)]),_:1},8,["rows","loading","pagination","filter"])])):(p(),L(ie,{key:0,class:"bg-negative text-white q-mb-md"},{default:l(()=>[F(f(d(s)("feedback.adminDenied")),1)]),_:1})),o(me,{modelValue:C.value,"onUpdate:modelValue":a[3]||(a[3]=t=>C.value=t)},{default:l(()=>[o(de,{style:{"max-width":"90vw","max-height":"90vh"}},{default:l(()=>[o(I,{class:"row items-center q-gutter-sm"},{default:l(()=>[v("div",Ce,f(d(s)("feedback.screenshot")),1),o(R),ce(o(B,{dense:"",flat:"",icon:"close"},null,512),[[ge]])]),_:1}),o(ue),o(I,{class:"scroll",style:{"max-height":"75vh"}},{default:l(()=>[V.value?(p(),h("div",Ve,[v("img",{src:V.value,style:{"max-width":"100%",height:"auto"}},null,8,Pe)])):(p(),h("div",De,f(d(s)("feedback.noScreenshotData")),1))]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(te,{modelValue:P.value,"onUpdate:modelValue":a[4]||(a[4]=t=>P.value=t),feedback:r.value,"allow-status-edit":!0,"allow-admin-comment-edit":!0,"status-options":d(A),"saving-status":q.value,"saving-admin-comment":D.value,"onUpdate:status":a[5]||(a[5]=t=>r.value&&N(r.value,t)),onSaveAdminComment:a[6]||(a[6]=t=>Z(t)),onOpenScreenshot:a[7]||(a[7]=()=>r.value&&E(r.value))},null,8,["modelValue","feedback","status-options","saving-status","saving-admin-comment"])]),_:1}))}}),He=fe(qe,[["__scopeId","data-v-02c9f25e"]]);export{He as default};
