import{a as G}from"./QSelect-l2ivovYW.js";import{B as ne,E as ae,a0 as le,a2 as ue,H as de,aJ as ce,z as d,C as F,aF as he,x as me,r as z,a as te,q as Z,w as K,c as g,o as a,aC as c,at as $,f,e as m,g as R,p as O,t as T,m as M,F as J,A as Y,k as pe,aE as ve,l as V,s as x,Q as we,ak as fe,i as X,a7 as ge,aD as be,av as _e,j as ye}from"./index-DVxg6bki.js";import{Q as ke}from"./QSlideTransition-Be_hDsgh.js";import{u as Ce}from"./use-quasar-CkVI-nkJ.js";import{u as $e}from"./useGroups-Ba6bv9j6.js";import{supabase as W}from"./supabase-DHOxICEL.js";import{Q as H}from"./QBadge-THsguSLK.js";import{Q as Se,a as ee}from"./QTabs-D4GgAfr5.js";import{u as qe}from"./auth-store-B2tf6G-o.js";import{u as se}from"./vue-i18n.runtime-B8ut2y-E.js";import{_ as ie}from"./_plugin-vue_export-helper-DlAUqK2U.js";function Ie(l){if(!l)return null;let s=l.trim();/^https?:\/\//i.test(s)||(s="https://"+s);try{const y=new URL(s).hostname.toLowerCase().replace(/^www\./,""),k=y.split(".");return k.length>=2?k.slice(-2).join("."):y}catch{return null}}function Ee(){async function l(s,t="_blank"){if(!s)return;const y=W.rpc("track_link_click",{target_url:s});try{t==="_blank"?window.open(s,"_blank","noopener"):window.location.href=s}catch{}try{await y}catch{}}return{trackClickAndOpen:l,extractBaseDomain:Ie}}const Te=ne({name:"QInnerLoading",props:{...le,...ae,showing:Boolean,color:String,size:{type:[String,Number],default:"42px"},label:String,labelClass:String,labelStyle:[String,Array,Object]},setup(l,{slots:s}){const t=de(),y=ue(l,t.proxy.$q),{transitionProps:k,transitionStyle:p}=ce(l),D=d(()=>"q-inner-loading q--avoid-card-border absolute-full column flex-center"+(y.value===!0?" q-inner-loading--dark":"")),v=d(()=>"q-inner-loading__label"+(l.labelClass!==void 0?` ${l.labelClass}`:""));function N(){const S=[F(me,{size:l.size,color:l.color})];return l.label!==void 0&&S.push(F("div",{class:v.value,style:l.labelStyle},[l.label])),S}function b(){return l.showing===!0?F("div",{class:D.value,style:p.value},s.default!==void 0?s.default():N()):null}return()=>F(he,k.value,b)}});function Be(){const l=qe(),s=z([]),t=z(!1),y=new Set,k=new Map,p=new Map,D=o=>s.value.filter(r=>r.wish_id===o),v=o=>D(o).filter(r=>r.thread_type==="recipient"),N=o=>D(o).filter(r=>r.thread_type==="secret"),b=o=>l.user?.id===o.created_for_user_id,S=async o=>{t.value=!0;try{const{data:r,error:C}=await W.from("wish_comments").select("*").eq("wish_id",o).order("created_at",{ascending:!0});if(C)throw C;if(!r)return{data:[],error:null};const h=Array.from(new Set(r.map(n=>n.author_id))),{data:u,error:q}=await W.from("profiles_public").select("*").in("id",h);if(q)throw q;const _=new Map((u||[]).map(n=>[n.id,n]));_.forEach((n,P)=>p.set(P,n));const I=new Set(s.value.map(n=>n.id)),i=r.filter(n=>!I.has(n.id)).map(n=>({...n,author:_.get(n.author_id)||null}));return s.value=s.value.concat(i),y.add(o),{data:i,error:null}}catch(r){return{data:[],error:r instanceof Error?r:new Error(String(r))}}finally{t.value=!1}},L=async(o,r,C)=>{const h=l.user?.id;if(!h)return{error:new Error("Not authenticated")};if(!r.trim())return{error:new Error("Empty comment")};try{const{data:u,error:q}=await W.from("wish_comments").insert([{wish_id:o,body:r.trim(),thread_type:C,author_id:h}]).select("*").single();if(q)throw q;const _={...u,author:l.profile};return p.set(_.author_id,_.author||null),s.value.push(_),{data:u,error:null}}catch(u){return{error:u instanceof Error?u:new Error(String(u))}}},A=o=>{if(k.has(o))return;const r=W.channel(`wish_comments:wish_id=${o}`);r.on("postgres_changes",{event:"INSERT",schema:"public",table:"wish_comments",filter:`wish_id=eq.${o}`},C=>{const h=C.new;if(!s.value.find(u=>u.id===h.id)){const u=p.get(h.author_id)??null,q={...h,author:u};s.value.push(q),u||W.from("profiles_public").select("*").eq("id",h.author_id).single().then(({data:_})=>{if(_){p.set(h.author_id,_);const I=s.value.findIndex(i=>i.id===h.id);I!==-1&&s.value[I]&&(s.value[I].author=_)}})}}),r.on("postgres_changes",{event:"DELETE",schema:"public",table:"wish_comments",filter:`wish_id=eq.${o}`},C=>{const h=C.old.id;s.value=s.value.filter(u=>u.id!==h)}),r.subscribe(),k.set(o,r)},B=o=>{const r=k.get(o);r&&(W.removeChannel(r),k.delete(o))},U=o=>{s.value=s.value.filter(r=>r.wish_id!==o),y.delete(o)};return{comments:d(()=>s.value),loading:d(()=>t.value),fetchComments:S,addComment:L,ensureSubscribed:A,unsubscribe:B,resetWish:U,getRecipientComments:v,getSecretComments:N,isRecipient:b}}const Qe={key:0,class:"row items-center q-mb-sm"},xe={key:2,class:"q-mb-sm"},Re={key:3,class:"q-mb-sm"},De={key:0,class:"text-caption text-grey-6 q-pa-sm"},Ne={class:"text-caption text-grey-6"},Le={class:"author"},Ae={class:"time"},Me={class:"text-body2"},ze=te({__name:"WishComments",props:{wishId:{},wish:{}},setup(l){const s=l,{t}=se(),{fetchComments:y,ensureSubscribed:k,getRecipientComments:p,getSecretComments:D,addComment:v,isRecipient:N}=Be(),b=z("recipient"),S=z(""),L=z(!1),A=d(()=>s.wish.created_by_user_id!==s.wish.created_for_user_id),B=d(()=>N(s.wish));Z(()=>{A.value?b.value="secret":B.value?b.value="recipient":b.value="secret"});const U=d(()=>p(s.wishId)),o=d(()=>D(s.wishId)),r=d(()=>b.value==="recipient"?U.value:o.value),C=d(()=>!A.value),h=d(()=>!B.value||!C.value),u=d(()=>!!S.value.trim()),q=async()=>{if(!u.value)return;const I=b.value;await v(s.wishId,S.value,I),S.value=""},_=async()=>{L.value=!0,await y(s.wishId),k(s.wishId),L.value=!1};return K(()=>s.wishId,()=>{_()},{immediate:!0}),(I,i)=>(a(),g("div",{class:"wish-comments",onClick:i[12]||(i[12]=c(()=>{},["stop"])),onMousedown:i[13]||(i[13]=c(()=>{},["stop"]))},[!A.value&&!B.value?(a(),g("div",Qe,[m(H,{color:"grey-7",outline:""},{default:R(()=>[O(T(M(t)("wishes.comments.infoHelping")),1)]),_:1})])):$("",!0),!A.value&&!B.value?(a(),g("div",{key:1,class:"q-mb-sm",onClick:i[1]||(i[1]=c(()=>{},["stop"])),onMousedown:i[2]||(i[2]=c(()=>{},["stop"]))},[m(Se,{modelValue:b.value,"onUpdate:modelValue":i[0]||(i[0]=n=>b.value=n),dense:"",class:"text-grey-7","active-color":"primary","indicator-color":"primary"},{default:R(()=>[m(ee,{name:"recipient",label:M(t)("wishes.comments.tabRecipient"),disable:!C.value,count:U.value.length},null,8,["label","disable","count"]),m(ee,{name:"secret",label:M(t)("wishes.comments.tabSecret"),disable:!h.value,count:o.value.length},null,8,["label","disable","count"])]),_:1},8,["modelValue"])],32)):B.value?(a(),g("div",xe,[m(H,{color:"primary",outline:""},{default:R(()=>[O(T(M(t)("wishes.comments.visibleToYou")),1)]),_:1})])):(a(),g("div",Re,[m(H,{color:"purple",outline:""},{default:R(()=>[O(T(M(t)("wishes.comments.secretThread")),1)]),_:1})])),f("div",{class:"comments-list q-mb-sm",onClick:i[3]||(i[3]=c(()=>{},["stop"])),onMousedown:i[4]||(i[4]=c(()=>{},["stop"])),onTouchstart:i[5]||(i[5]=c(()=>{},["stop"]))},[m(Te,{showing:L.value},null,8,["showing"]),r.value.length===0&&!L.value?(a(),g("div",De,T(M(t)("wishes.comments.empty")),1)):$("",!0),(a(!0),g(J,null,Y(r.value,n=>(a(),g("div",{key:n.id,class:"comment-item q-pa-xs"},[f("div",Ne,[f("span",Le,T(n.author?.username||n.author_id.substring(0,6)),1),f("span",Ae," â€¢ "+T(new Date(n.created_at||"").toLocaleString("cs-CZ")),1)]),f("div",Me,T(n.body),1)]))),128))],32),f("div",{class:"row items-end q-gutter-sm",onClick:i[9]||(i[9]=c(()=>{},["stop"])),onMousedown:i[10]||(i[10]=c(()=>{},["stop"])),onTouchstart:i[11]||(i[11]=c(()=>{},["stop"]))},[m(pe,{modelValue:S.value,"onUpdate:modelValue":i[6]||(i[6]=n=>S.value=n),dense:"",autogrow:"",filled:"",class:"col",placeholder:M(t)("wishes.comments.placeholder"),onKeyup:ve(c(q,["exact","prevent"]),["enter"]),onClick:i[7]||(i[7]=c(()=>{},["stop"])),onMousedown:i[8]||(i[8]=c(()=>{},["stop"]))},null,8,["modelValue","placeholder","onKeyup"]),m(V,{color:"primary",disable:!u.value,icon:"send",round:"",dense:"",onClick:c(q,["stop"])},null,8,["disable"])],32)],32))}}),Ve=ie(ze,[["__scopeId","data-v-c6209efd"]]),We={class:"row items-center justify-between"},Ue={class:"text-h6 wish-title"},Ge={class:"row items-center q-gutter-xs"},Pe={key:0,class:"text-body2 text-grey-7 q-mt-xs preview-text"},Fe={key:0,class:"row q-gutter-xs q-mb-md items-center"},Ke={key:1,class:"wish-description q-mb-md"},je={class:"text-body2 text-grey-7"},Oe={key:2,class:"wish-url q-mb-md"},He={class:"wish-meta"},Ze={class:"text-caption text-grey-6"},Je={key:0},Ye={class:"q-px-md q-pb-md"},Xe=te({__name:"WishCard",props:{wish:{},currentUserId:{},expanded:{type:Boolean},highlight:{type:Boolean},refreshKey:{}},emits:["edit","delete","toggleBought","toggleReceived"],setup(l,{emit:s}){const t=l,y=s,k=Ce(),{t:p}=se(),{trackClickAndOpen:D}=Ee(),v=z(!1),N=()=>{typeof t.expanded=="boolean"&&(v.value=t.expanded)};Z(N),K(()=>t.expanded,()=>N());const b=()=>{v.value=!v.value},S=d(()=>{switch(t.wish.visibility){case"public":return"green";case"friends":return"blue";case"private":return"grey";default:return"grey"}}),L=d(()=>{switch(t.wish.visibility){case"public":return p("wishes.visibilityPublic");case"friends":return n.value?p("wishes.form.visibilityFriendsGroups"):p("wishes.visibilityFriends");case"private":return p("wishes.visibilityPrivate");default:return p("common.unknown")}}),A=d(()=>t.wish.created_by_user_id!==t.wish.created_for_user_id&&t.currentUserId!==t.wish.created_for_user_id),B=()=>{const e=t.wish.created_by_user;return e.name&&e.surname?`${e.name} ${e.surname}`:e.name?e.name:e.username?e.username:p("common.unknown")},U=d(()=>t.currentUserId===t.wish.created_by_user_id),o=d(()=>t.currentUserId===t.wish.created_by_user_id),r=d(()=>t.currentUserId!==t.wish.created_for_user_id&&t.currentUserId!==void 0),C=d(()=>t.currentUserId===t.wish.created_for_user_id&&t.currentUserId!==void 0),h=d(()=>t.currentUserId===t.wish.created_by_user_id),{groups:u,fetchGroups:q,fetchWishRules:_}=$e(),I=z([]),i=z([]),n=d(()=>I.value.length>0||i.value.length>0),P=e=>{const E=u.value||[];return e.map(w=>E.find(Q=>Q.id===w)?.name).filter(w=>!!w)},j=async()=>{if(!h.value||t.wish.visibility!=="friends")return;(!u.value||u.value.length===0)&&await q();const e=await _(t.wish.id);if(!e.error&&e.data){const E=e.data.filter(Q=>Q.rule_type==="include").map(Q=>Q.group_id),w=e.data.filter(Q=>Q.rule_type==="exclude").map(Q=>Q.group_id);I.value=P(E),i.value=P(w)}};K(()=>v.value,e=>{e&&j()}),K(()=>t.refreshKey,()=>{v.value&&j()}),Z(()=>{v.value&&j()});const re=e=>new Date(e).toLocaleDateString("cs-CZ"),oe=()=>{k.dialog({title:p("wishes.deleteWish"),message:p("wishes.deleteConfirm"),cancel:!0,persistent:!0}).onOk(()=>{y("delete",t.wish.id)})};return(e,E)=>(a(),x(we,{class:fe(["wish-card self-start",{"wish-highlight":e.highlight}])},{default:R(()=>[m(X,{class:"wish-card-header",onClick:b},{default:R(()=>[f("div",We,[f("div",Ue,T(e.wish.name),1),f("div",Ge,[e.wish.is_bought?(a(),x(G,{key:0,color:"green","text-color":"white",label:e.$t("wishes.bought"),size:"sm"},null,8,["label"])):$("",!0),e.wish.is_received?(a(),x(G,{key:1,color:"purple","text-color":"white",label:e.$t("wishes.received"),size:"sm"},null,8,["label"])):$("",!0),m(V,{flat:"",round:"",dense:"",icon:v.value?"expand_less":"expand_more",onClick:c(b,["stop"])},null,8,["icon"])])]),!v.value&&e.wish.description?(a(),g("div",Pe,T(e.wish.description),1)):$("",!0)]),_:1}),m(ke,null,{default:R(()=>[ge(f("div",null,[m(X,{class:"wish-card-details"},{default:R(()=>[h.value?(a(),g("div",Fe,[m(G,{color:S.value,"text-color":"white",label:L.value,size:"sm"},null,8,["color","label"]),(a(!0),g(J,null,Y(I.value,w=>(a(),x(G,{key:`inc-${w}`,color:"green","text-color":"white",label:w,size:"sm"},null,8,["label"]))),128)),(a(!0),g(J,null,Y(i.value,w=>(a(),x(G,{key:`exc-${w}`,color:"red","text-color":"white",label:w,size:"sm"},null,8,["label"]))),128))])):$("",!0),e.wish.description?(a(),g("div",Ke,[f("div",je,T(e.wish.description),1)])):$("",!0),e.wish.url?(a(),g("div",Oe,[m(V,{flat:"",color:"primary",icon:"open_in_new",label:e.$t("wishes.openLink"),size:"sm",onClick:E[0]||(E[0]=c(w=>M(D)(e.wish.url),["stop"]))},null,8,["label"])])):$("",!0),f("div",He,[f("div",Ze,[A.value?(a(),g("div",Je,T(e.$t("wishes.createdBy",{name:B()})),1)):$("",!0),f("div",null,T(e.wish.created_at?re(e.wish.created_at):"N/A"),1)])])]),_:1}),m(_e,{align:"right"},{default:R(()=>[r.value?(a(),x(V,{key:0,color:e.wish.is_bought?"grey":"green",icon:e.wish.is_bought?"shopping_cart":"add_shopping_cart",label:e.wish.is_bought?e.$t("wishes.markAsNotBought"):e.$t("wishes.markAsBought"),flat:"",onClick:E[1]||(E[1]=c(w=>e.$emit("toggleBought",e.wish.id),["stop"]))},null,8,["color","icon","label"])):$("",!0),C.value?(a(),x(V,{key:1,color:e.wish.is_received?"orange":"purple",icon:e.wish.is_received?"undo":"check_circle",label:e.wish.is_received?e.$t("wishes.markAsNotReceived"):e.$t("wishes.markAsReceived"),flat:"",onClick:E[2]||(E[2]=c(w=>e.$emit("toggleReceived",e.wish.id),["stop"]))},null,8,["color","icon","label"])):$("",!0),U.value?(a(),x(V,{key:2,color:"primary",icon:"edit",flat:"",onClick:E[3]||(E[3]=c(w=>e.$emit("edit",e.wish),["stop"]))})):$("",!0),o.value?(a(),x(V,{key:3,color:"negative",icon:"delete",flat:"",onClick:c(oe,["stop"])})):$("",!0)]),_:1}),m(ye,{class:"q-mx-md q-mt-sm"}),f("div",Ye,[m(Ve,{"wish-id":e.wish.id,wish:{id:e.wish.id,created_for_user_id:e.wish.created_for_user_id,created_by_user_id:e.wish.created_by_user_id}},null,8,["wish-id","wish"])])],512),[[be,v.value]])]),_:1})]),_:1},8,["class"]))}}),ct=ie(Xe,[["__scopeId","data-v-c0c76b18"]]);export{ct as W};
