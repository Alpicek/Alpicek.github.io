import{supabase as t}from"./supabase-DumeQkYe.js";import{a as F}from"./auth-store-XB83oEbh.js";import{m as h,r as p}from"./index-MmE2OoPn.js";const w=p([]),_=p([]),u=p(0);let c=null,d=null;const j=()=>{const{shouldShowLoading:m,markDataLoaded:y}=F(),q=h(()=>u.value>0),a=async(e,n=!0,r="friends")=>{n&&m(r)&&u.value++;try{const s=await e();return n&&y(r),s}finally{n&&m(r)&&u.value--}},b=h(()=>_.value),v=h(()=>w.value),E=async(e,n)=>a(async()=>{try{const{data:r,error:s}=await t.from("friendships").insert([{user_id:n,friend_id:e,status:"pending"}]).select().single();if(s)throw s;return{data:r,error:null}}catch(r){return{data:null,error:r instanceof Error?r:new Error(String(r))}}},!0,"friends"),C=async(e,n)=>a(async()=>{try{const{data:r,error:s}=await t.from("friendships").update({status:"accepted"}).eq("id",e).select().single();if(s)throw s;return n&&await l(n,!0),{data:r,error:null}}catch(r){return{data:null,error:r instanceof Error?r:new Error(String(r))}}},!0,"friends"),L=async e=>a(async()=>{try{const{data:n,error:r}=await t.from("friendships").update({status:"declined"}).eq("id",e).select().single();if(r)throw r;return{data:n,error:null}}catch(n){return{data:null,error:n instanceof Error?n:new Error(String(n))}}},!0,"friends"),l=async(e,n=!1)=>e?a(async()=>{try{const{data:r,error:s}=await t.from("friendships").select(`
            *,
            friend:profiles!friendships_friend_id_fkey(*),
            user:profiles!friendships_user_id_fkey(*)
          `).or(`user_id.eq.${e},friend_id.eq.${e}`).eq("status","accepted");if(s)throw s;const i=r?.map(o=>o.user_id===e?o.friend:o.user)||[];return _.value=i,w.value=r||[],{data:i,error:null}}catch(r){return{data:null,error:r instanceof Error?r:new Error(String(r))}}},!n,"friends"):{data:[],error:null},g=async(e,n=!1)=>e?a(async()=>{try{const{data:r,error:s}=await t.from("friendships").select(`
            *,
            user:profiles!friendships_user_id_fkey(*)
          `).eq("friend_id",e).eq("status","pending"),{data:i,error:o}=await t.from("friendships").select(`
            *,
            friend:profiles!friendships_friend_id_fkey(*)
          `).eq("user_id",e).eq("status","pending");if(s)throw s;if(o)throw o;return{data:[...r?.map(f=>({...f,type:"incoming"}))||[],...i?.map(f=>({...f,type:"outgoing"}))||[]],error:null}}catch(r){return{data:null,error:r instanceof Error?r:new Error(String(r))}}},!n,"pendingRequests"):{data:[],error:null};return{friends:b,friendships:v,isLoading:q,sendFriendRequest:E,acceptFriendRequest:C,declineFriendRequest:L,fetchFriends:l,fetchPendingRequests:g,searchUsers:async e=>a(async()=>{try{const{data:n,error:r}=await t.rpc("search_users",{search_query:e,limit_count:10});if(r)throw r;return{data:n,error:null}}catch{try{const{data:n,error:r}=await t.from("profiles").select("*").eq("is_dummy",!1).limit(10);if(r)throw r;return{data:n?.filter(i=>i.email.toLowerCase().includes(e.toLowerCase())||i.name&&i.name.toLowerCase().includes(e.toLowerCase())||i.surname&&i.surname.toLowerCase().includes(e.toLowerCase())||i.username&&i.username.toLowerCase().includes(e.toLowerCase()))||[],error:null}}catch(n){return{data:null,error:n instanceof Error?n:new Error(String(n))}}}},!0,"friends"),removeFriend:async(e,n)=>a(async()=>{try{const{error:r}=await t.from("friendships").delete().eq("id",e);if(r)throw r;return n&&await l(n,!0),{error:null}}catch(r){return{error:r instanceof Error?r:new Error(String(r))}}},!0,"friends"),resetLoadingState:async e=>{u.value=0,e&&await l(e,!0)},subscribeToFriendships:e=>{c&&t.removeChannel(c),c=t.channel(`friendships:${e}`).on("postgres_changes",{event:"*",schema:"public",table:"friendships",filter:`or(user_id.eq.${e},friend_id.eq.${e})`},()=>{l(e,!0)}).subscribe()},subscribeToPendingRequests:(e,n)=>{d&&t.removeChannel(d),d=t.channel(`pending_requests:${e}`).on("postgres_changes",{event:"*",schema:"public",table:"friendships",filter:`and(or(user_id.eq.${e},friend_id.eq.${e}),status.eq.pending)`},()=>{g(e,!0).then(r=>{r?.data&&n&&n(r.data)})}).subscribe()},unsubscribeFromFriendships:()=>{c&&(t.removeChannel(c),c=null),d&&(t.removeChannel(d),d=null)}}};export{j as u};
