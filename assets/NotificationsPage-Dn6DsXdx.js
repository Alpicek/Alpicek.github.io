import{s as qt,z as nt,W as kt,a8 as Nt,Y as St,B as Ct,r as L,v as M,aX as Tt,_ as _t,aY as $t,$ as xt,aZ as Vt,E as ut,J as dt,M as ft,R as mt,a9 as Qt,x as pt,aE as Et,y as Pt,V as At,a as Dt,b as gt,m as Ot,ae as Rt,n as x,w as l,o as b,g as f,e,c as B,at as U,f as V,t as m,k as h,h as W,j as q,i as Q,ak as E,p as F,q as Bt,av as Ut,au as Mt,Q as Lt,u as Ht,a3 as jt,aj as zt,ax as It,aD as Wt,b5 as Ft}from"./index-DcT2ux80.js";import{Q as bt}from"./QForm-CYsn5LZN.js";import{Q as Jt,a as st}from"./QTabs-DCHTPDvP.js";import{Q as Kt,a as lt,b as rt}from"./QItem-DoA9z5g1.js";import{Q as Yt}from"./QBadge-BRupl23o.js";import{v as Xt,a as ht,e as Zt,p as yt,b as Gt,c as te,d as ee,r as vt,s as oe}from"./position-engine-CNzjy2rL.js";import{c as wt}from"./selection-kdsaOv7s.js";import{Q as ie}from"./QList-AwKcHZ4O.js";import{Q as ae}from"./QPage-BNSETTxJ.js";import{u as ne}from"./use-quasar-B4nle0bC.js";import{u as se}from"./usePushNotifications-Nt4zb2im.js";import{u as le}from"./useNotifications-Bh1rOFyA.js";import{u as re}from"./auth-store-BSTOyDR1.js";import{supabase as ce}from"./supabase-DkOw_aOL.js";import{N as ue}from"./NotificationSettings-BzeBCMDA.js";import{u as de}from"./vue-i18n.runtime-EzKfoaH7.js";import"./QResizeObserver-D8BsG4LP.js";import"./rtl-DFPa-2ov.js";import"./QChip-DsLmkw4c.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const fe=qt({name:"QTooltip",inheritAttrs:!1,props:{...Zt,...St,...nt,maxHeight:{type:String,default:null},maxWidth:{type:String,default:null},transitionShow:{...nt.transitionShow,default:"jump-down"},transitionHide:{...nt.transitionHide,default:"jump-up"},anchor:{type:String,default:"bottom middle",validator:ht},self:{type:String,default:"top middle",validator:ht},offset:{type:Array,default:()=>[14,14],validator:Xt},scrollTarget:Nt,delay:{type:Number,default:0},hideDelay:{type:Number,default:0},persistent:Boolean},emits:[...kt],setup(s,{slots:P,emit:i,attrs:A}){let c,p;const D=Ct(),{proxy:{$q:g}}=D,w=L(null),T=L(!1),J=M(()=>yt(s.anchor,g.lang.rtl)),K=M(()=>yt(s.self,g.lang.rtl)),Y=M(()=>s.persistent!==!0),{registerTick:X,removeTick:Z}=Tt(),{registerTimeout:_}=_t(),{transitionProps:G,transitionStyle:tt}=$t(s),{localScrollTarget:u,changeScrollEvent:O,unconfigureScrollTarget:$}=Gt(s,y),{anchorEl:n,canShow:d,anchorEvents:k}=te({showing:T,configureAnchorEl:o}),{show:et,hide:R}=xt({showing:T,canShow:d,handleShow:ot,handleHide:it,hideOnRouteChange:Y,processOnMount:!0});Object.assign(k,{delayShow:t,delayHide:a});const{showPortal:H,hidePortal:j,renderPortal:z}=Vt(D,w,v,"tooltip");if(g.platform.is.mobile===!0){const r={anchorEl:n,innerRef:w,onClickOutside(C){return R(C),C.target.classList.contains("q-dialog__backdrop")&&At(C),!0}},at=M(()=>s.modelValue===null&&s.persistent!==!0&&T.value===!0);ut(at,C=>{(C===!0?ee:vt)(r)}),dt(()=>{vt(r)})}function ot(r){H(),X(()=>{p=new MutationObserver(()=>N()),p.observe(w.value,{attributes:!1,childList:!0,characterData:!0,subtree:!0}),N(),y()}),c===void 0&&(c=ut(()=>g.screen.width+"|"+g.screen.height+"|"+s.self+"|"+s.anchor+"|"+g.lang.rtl,N)),_(()=>{H(!0),i("show",r)},s.transitionDuration)}function it(r){Z(),j(),I(),_(()=>{j(!0),i("hide",r)},s.transitionDuration)}function I(){p!==void 0&&(p.disconnect(),p=void 0),c!==void 0&&(c(),c=void 0),$(),ft(k,"tooltipTemp")}function N(){oe({targetEl:w.value,offset:s.offset,anchorEl:n.value,anchorOrigin:J.value,selfOrigin:K.value,maxHeight:s.maxHeight,maxWidth:s.maxWidth})}function t(r){if(g.platform.is.mobile===!0){wt(),document.body.classList.add("non-selectable");const at=n.value,C=["touchmove","touchcancel","touchend","click"].map(ct=>[at,ct,"delayHide","passiveCapture"]);mt(k,"tooltipTemp",C)}_(()=>{et(r)},s.delay)}function a(r){g.platform.is.mobile===!0&&(ft(k,"tooltipTemp"),wt(),setTimeout(()=>{document.body.classList.remove("non-selectable")},10)),_(()=>{R(r)},s.hideDelay)}function o(){if(s.noParentEvent===!0||n.value===null)return;const r=g.platform.is.mobile===!0?[[n.value,"touchstart","delayShow","passive"]]:[[n.value,"mouseenter","delayShow","passive"],[n.value,"mouseleave","delayHide","passive"]];mt(k,"anchor",r)}function y(){if(n.value!==null||s.scrollTarget!==void 0){u.value=Qt(n.value,s.scrollTarget);const r=s.noParentEvent===!0?N:R;O(u.value,r)}}function S(){return T.value===!0?pt("div",{...A,ref:w,class:["q-tooltip q-tooltip--style q-position-engine no-pointer-events",A.class],style:[A.style,tt.value],role:"tooltip"},Pt(P.default)):null}function v(){return pt(Et,G.value,S)}return dt(I),Object.assign(D.proxy,{updatePosition:N}),z}}),me={class:"q-pa-md",style:{"max-width":"600px",width:"100%"}},pe={class:"text-h4 text-center q-mb-md"},ge={class:"text-body1 text-center text-grey-6 q-mb-lg"},be={key:0},he={class:"text-h6 q-mb-md"},ye={class:"q-gutter-md"},ve={class:"text-h6 q-mb-md"},we={class:"text-h6 q-mb-md text-warning"},qe={class:"bg-warning text-dark q-pa-md rounded-borders"},ke={class:"row items-center justify-between q-mb-md"},Ne={class:"text-h6"},Se={key:0,class:"q-pa-md text-center"},Ce={class:"q-mt-sm text-grey-6"},Te={key:1,class:"q-pa-md text-center"},_e={class:"text-body1 text-grey-6 q-mt-md"},$e={class:"column items-end"},xe={key:3,class:"q-pa-md text-center"},Ye=Dt({__name:"NotificationsPage",setup(s){const P=ne(),{t:i}=de(),A=Ht(),c=se(),{notifications:p,unreadCount:D,hasUnread:g,isLoading:w,initialize:T,cleanup:J,markAsRead:K,markAllAsRead:Y,handleNotificationClick:X,getNotificationIcon:Z,getNotificationColor:_,fetchNotifications:G}=le(),tt=re(),u=L(!1),O=L(!1),$=L("all"),n=gt({title:"",body:"",url:""}),d=gt({title:"",body:"",url:""}),k=async()=>{if(c.isSubscribed.value){u.value=!0;try{const t=await c.getCurrentSubscription();if(!t)throw new Error("No subscription found");await c.sendNotification(t,{title:n.title,body:n.body,icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"custom-notification",data:{type:"custom",url:n.url||"/",timestamp:Date.now()}}),n.title="",n.body="",n.url=""}catch(t){console.error("Error sending custom notification:",t)}finally{u.value=!1}}},et=async()=>{if(c.isSubscribed.value){u.value=!0;try{const t=await c.getCurrentSubscription();if(!t)throw new Error("No subscription found");await c.sendNotification(t,{title:i("notifications.wishNotificationTitle"),body:i("notifications.wishNotificationBody"),icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"new-wish",data:{type:"wish",url:"/wishes",timestamp:Date.now()},actions:[{action:"view",title:i("notifications.viewWishes")},{action:"dismiss",title:i("common.close")}]})}catch(t){console.error("Error sending wish notification:",t)}finally{u.value=!1}}},R=async()=>{if(c.isSubscribed.value){u.value=!0;try{const t=await c.getCurrentSubscription();if(!t)throw new Error("No subscription found");await c.sendNotification(t,{title:i("notifications.friendRequestTitle"),body:i("notifications.friendRequestBody"),icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"friend-request",data:{type:"friend-request",url:"/friends",timestamp:Date.now()},actions:[{action:"view",title:i("notifications.viewFriends")},{action:"dismiss",title:i("common.close")}]})}catch(t){console.error("Error sending friend request notification:",t)}finally{u.value=!1}}},H=async()=>{u.value=!0;try{const t=await c.getCurrentSubscription();if(!t)throw new Error("No subscription found");await c.sendNotification(t,{title:i("notifications.birthdayTitle"),body:i("notifications.birthdayBody"),icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"birthday",data:{type:"birthday",url:"/friends",timestamp:Date.now()},actions:[{action:"view",title:i("notifications.viewProfile")},{action:"dismiss",title:i("common.close")}]})}catch(t){console.error("Error sending birthday notification:",t)}finally{u.value=!1}},j=async()=>{O.value=!0;try{const{data:t,error:a}=await ce.from("push_subscriptions").select("subscription_data").eq("is_active",!0);if(a)throw a;if(!t||t.length===0){P.notify({type:"warning",message:i("notifications.noSubscriptions"),timeout:3e3});return}let o=0,y=0;for(const S of t)try{const v=S.subscription_data,r={endpoint:v.endpoint,expirationTime:null,options:{applicationServerKey:null,userVisibleOnly:!0},getKey:()=>null,unsubscribe:()=>Promise.resolve(!0),toJSON:()=>v};await c.sendNotification(r,{title:d.title,body:d.body,icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"admin-broadcast",data:{type:"admin-broadcast",url:d.url||"/",timestamp:Date.now()}}),o++}catch(v){console.error("Error sending to subscription:",v),y++}P.notify({type:o>0?"positive":"negative",message:i("notifications.broadcastResult",{success:o,errors:y}),timeout:5e3}),o>0&&(d.title="",d.body="",d.url="")}catch(t){console.error("Error sending admin notification:",t),P.notify({type:"negative",message:i("notifications.broadcastError"),timeout:5e3})}finally{O.value=!1}},z=M(()=>{switch($.value){case"unread":return p.value.filter(t=>!t.is_read);case"read":return p.value.filter(t=>t.is_read);default:return p.value}}),ot=()=>{switch($.value){case"unread":return i("notifications.noUnread");case"read":return i("notifications.noRead");default:return i("notifications.noNotifications")}},it=t=>{if(!t)return"";const a=Date.now(),o=new Date(t).getTime(),y=a-o,S=Math.floor(y/(1e3*60)),v=Math.floor(y/(1e3*60*60)),r=Math.floor(y/(1e3*60*60*24));return S<1?i("notifications.justNow"):S<60?i("notifications.minutesAgo",{count:S}):v<24?i("notifications.hoursAgo",{count:v}):r<7?i("notifications.daysAgo",{count:r}):new Date(t).toLocaleDateString()},I=async t=>{const a=await X(t);await A.push(a)},N=async()=>{await G(p.value.length+20)};return Ot(()=>{T()}),Rt(()=>{J()}),(t,a)=>(b(),x(ae,{class:"flex flex-center"},{default:l(()=>[f("div",me,[e(Lt,null,{default:l(()=>[e(V,null,{default:l(()=>[f("div",pe,m(t.$t("notifications.title")),1),f("div",ge,m(t.$t("notifications.pageDescription")),1)]),_:1}),e(V,null,{default:l(()=>[e(ue)]),_:1}),h(tt).user?.email==="pichalek@gmail.com"?(b(),B("div",be,[e(V,null,{default:l(()=>[e(W,{class:"q-mb-md"}),f("div",he,m(t.$t("notifications.quickActions")),1),f("div",ye,[e(q,{color:"primary",icon:"card_giftcard",label:t.$t("notifications.notifyNewWish"),onClick:et,loading:u.value,class:"full-width"},null,8,["label","loading"]),e(q,{color:"secondary",icon:"group",label:t.$t("notifications.notifyFriendRequest"),onClick:R,loading:u.value,class:"full-width"},null,8,["label","loading"]),e(q,{color:"accent",icon:"celebration",label:t.$t("notifications.notifyBirthday"),onClick:H,loading:u.value,class:"full-width"},null,8,["label","loading"])])]),_:1}),e(V,null,{default:l(()=>[e(W,{class:"q-mb-md"}),f("div",ve,m(t.$t("notifications.customNotification")),1),e(bt,{onSubmit:k,class:"q-gutter-md"},{default:l(()=>[e(Q,{modelValue:n.title,"onUpdate:modelValue":a[0]||(a[0]=o=>n.title=o),label:t.$t("notifications.notificationTitle"),outlined:"",rules:[o=>!!o||t.$t("common.required")]},null,8,["modelValue","label","rules"]),e(Q,{modelValue:n.body,"onUpdate:modelValue":a[1]||(a[1]=o=>n.body=o),label:t.$t("notifications.notificationBody"),outlined:"",type:"textarea",rows:"3",rules:[o=>!!o||t.$t("common.required")]},null,8,["modelValue","label","rules"]),e(Q,{modelValue:n.url,"onUpdate:modelValue":a[2]||(a[2]=o=>n.url=o),label:t.$t("notifications.targetUrl"),outlined:"",placeholder:"/wishes",hint:"Optional URL to open when notification is clicked"},null,8,["modelValue","label"]),e(q,{type:"submit",color:"primary",icon:"send",label:t.$t("notifications.sendCustom"),loading:u.value,class:"full-width"},null,8,["label","loading"])]),_:1})]),_:1}),e(V,null,{default:l(()=>[e(W,{class:"q-mb-md"}),f("div",we,[e(F,{name:"admin_panel_settings",class:"q-mr-sm"}),E(" "+m(t.$t("notifications.adminSection")),1)]),e(bt,{onSubmit:j,class:"q-gutter-md"},{default:l(()=>[e(Q,{modelValue:d.title,"onUpdate:modelValue":a[3]||(a[3]=o=>d.title=o),label:t.$t("notifications.notificationTitle"),outlined:"",rules:[o=>!!o||t.$t("common.required")]},null,8,["modelValue","label","rules"]),e(Q,{modelValue:d.body,"onUpdate:modelValue":a[4]||(a[4]=o=>d.body=o),label:t.$t("notifications.notificationBody"),outlined:"",type:"textarea",rows:"3",rules:[o=>!!o||t.$t("common.required")]},null,8,["modelValue","label","rules"]),e(Q,{modelValue:d.url,"onUpdate:modelValue":a[5]||(a[5]=o=>d.url=o),label:t.$t("notifications.targetUrl"),outlined:"",placeholder:"/"},null,8,["modelValue","label"]),f("div",qe,[e(F,{name:"warning",class:"q-mr-sm"}),E(" "+m(t.$t("notifications.adminWarning")),1)]),e(q,{type:"submit",color:"warning",icon:"campaign",label:t.$t("notifications.sendToAll"),loading:O.value,class:"full-width"},null,8,["label","loading"])]),_:1})]),_:1})])):U("",!0),e(V,null,{default:l(()=>[e(W,{class:"q-mb-md"}),f("div",ke,[f("div",Ne,m(t.$t("notifications.receivedNotifications")),1),h(g)?(b(),x(q,{key:0,flat:"",dense:"",color:"primary",label:t.$t("notifications.markAllRead"),icon:"done_all",onClick:h(Y)},null,8,["label","onClick"])):U("",!0)]),e(Jt,{modelValue:$.value,"onUpdate:modelValue":a[6]||(a[6]=o=>$.value=o),dense:"",class:"text-grey q-mb-md","active-color":"primary","indicator-color":"primary",align:"left","narrow-indicator":""},{default:l(()=>[e(st,{name:"all",label:t.$t("notifications.all"),badge:h(p).length||void 0},null,8,["label","badge"]),e(st,{name:"unread",label:t.$t("notifications.unread"),badge:h(D)||void 0},null,8,["label","badge"]),e(st,{name:"read",label:t.$t("notifications.read")},null,8,["label"])]),_:1},8,["modelValue"]),h(w)?(b(),B("div",Se,[e(Bt,{size:"md",color:"primary"}),f("div",Ce,m(t.$t("notifications.loading")),1)])):z.value.length===0?(b(),B("div",Te,[e(F,{name:"notifications_none",size:"60px",color:"grey-4"}),f("div",_e,m(ot()),1)])):(b(),x(ie,{key:2,separator:"",class:"rounded-borders"},{default:l(()=>[(b(!0),B(Mt,null,Ut(z.value,o=>jt((b(),x(Kt,{key:o.id,clickable:"",class:zt({"bg-blue-1":!o.is_read}),onClick:()=>I(o)},{default:l(()=>[e(lt,{avatar:""},{default:l(()=>[e(It,{color:h(_)(o.type),"text-color":"white",icon:h(Z)(o.type),size:"40px"},null,8,["color","icon"])]),_:2},1024),e(lt,null,{default:l(()=>[e(rt,{class:"text-weight-medium"},{default:l(()=>[E(m(o.title),1)]),_:2},1024),e(rt,{caption:"",lines:"2",class:"q-mt-xs"},{default:l(()=>[E(m(o.body),1)]),_:2},1024),e(rt,{caption:"",class:"text-grey-6 q-mt-xs"},{default:l(()=>[e(F,{name:"schedule",size:"14px",class:"q-mr-xs"}),E(" "+m(it(o.created_at)),1)]),_:2},1024)]),_:2},1024),e(lt,{side:"",top:""},{default:l(()=>[f("div",$e,[o.is_read?U("",!0):(b(),x(Yt,{key:0,color:"primary",rounded:"",class:"q-mb-sm"})),o.is_read?U("",!0):(b(),x(q,{key:1,flat:"",round:"",dense:"",icon:"done",size:"sm",color:"primary",onClick:Wt(y=>h(K)(o.id),["stop"])},{default:l(()=>[e(fe,null,{default:l(()=>[E(m(t.$t("notifications.markAsRead")),1)]),_:1})]),_:2},1032,["onClick"]))])]),_:2},1024)]),_:2},1032,["class","onClick"])),[[Ft]])),128))]),_:1})),h(p).length>=20?(b(),B("div",xe,[e(q,{flat:"",color:"primary",label:t.$t("notifications.loadMore"),icon:"expand_more",onClick:N,loading:h(w)},null,8,["label","loading"])])):U("",!0)]),_:1})]),_:1})])]),_:1}))}});export{Ye as default};
