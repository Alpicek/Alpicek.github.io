import{a as ge,v as P,r as b,b as ye,m as we,aA as be,ae as We,E as K,n as N,w as f,o as l,g as h,c as n,e as t,t as y,j,h as _e,k as W,q as z,p as L,au as S,av as O,Q as $e,f as X,i as J,aB as Re}from"./index-DsP-nMLo.js";import{a as Y,Q as Ve}from"./QTabs-DaUEGq_e.js";import{a as Z,Q as ke}from"./QTabPanels-CxWymmZi.js";import{Q as Qe}from"./QSelect-DZuIywsw.js";import{Q as Se}from"./QForm-Cw4tplyn.js";import{Q as qe}from"./QPage-BjfGDhL-.js";import{u as Ee}from"./useWishes-CuoPzFq7.js";import{u as Fe}from"./auth-store-Bf3hSUlm.js";import{u as Ue}from"./use-quasar-8KxiYwhJ.js";import{supabase as ee}from"./supabase-DBrb1RXq.js";import{W as H}from"./WishCard-C_ZNJ3va.js";import{u as Ce}from"./vue-i18n.runtime-B326ilhY.js";import"./QResizeObserver-0SPLo5D2.js";import"./rtl-DFPa-2ov.js";import"./touch-BjYP5sR0.js";import"./selection-C6vwuMfh.js";import"./QChip-BBRjXeTi.js";import"./QItem-BoJwHhdH.js";import"./format-Cogwy6g5.js";import"./position-engine-Cq_FHD70.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Te={class:"row justify-between items-center q-mb-md"},Ae={class:"text-h4"},Be={key:0,class:"flex justify-center"},De={key:1,class:"text-center text-grey-6 q-py-lg"},Ne={class:"text-h6 q-mt-md"},Ie={key:2,class:"row q-gutter-md"},Pe={key:0,class:"flex justify-center"},je={key:1,class:"text-center text-grey-6 q-py-lg"},ze={class:"text-h6 q-mt-md"},Le={key:2,class:"row q-gutter-md"},Oe={key:0,class:"flex justify-center"},Je={key:1,class:"text-center text-grey-6 q-py-lg"},He={class:"text-h6 q-mt-md"},xe={key:2,class:"row q-gutter-md"},Me={class:"text-h6"},Ge={class:"row justify-end q-gutter-sm"},ys=ge({__name:"WishesPage",setup(Ke){const w=Ue(),{t:d}=Ce(),k=be(),a=Fe(),p=P(()=>k.params.userId),u=P(()=>!!p.value),{isLoading:q,createWish:se,fetchWishes:ie,fetchAllWishesForUser:ae,fetchReceivedWishes:te,refreshWishes:E,refreshAllWishesForUser:F,refreshReceivedWishes:U,updateWish:re,deleteWish:le,toggleBought:oe,toggleReceived:ue}=Ee(),c=b([]),m=b([]),C=P(()=>u.value?m.value:c.value);let _=null;const T=b("my-wishes"),$=b(!1),R=b(null),v=b([]),V=b(""),r=ye({name:"",description:"",url:"",visibility:"friends"}),ne=[{label:d("wishes.form.visibilityPublic"),value:"public"},{label:d("wishes.form.visibilityFriends"),value:"friends"},{label:d("wishes.form.visibilityPrivate"),value:"private"}],x=()=>{r.name="",r.description="",r.url="",r.visibility="friends",R.value=null},de=async()=>{if(!a.user)return;const e=u.value?p.value:a.user.id;if(!e)return;const i={name:r.name,...r.description&&{description:r.description},...r.url&&{url:r.url},visibility:r.visibility,created_for_user_id:e,created_by_user_id:a.user.id};let s;if(R.value?s=await re(R.value,i):s=await se(i),s.error)w.notify({type:"negative",message:d("wishes.saveError")+": "+(s.error instanceof Error?s.error.message:JSON.stringify(s.error))});else if(w.notify({type:"positive",message:R.value?d("wishes.updateSuccess"):d("wishes.createSuccess")}),$.value=!1,x(),u.value){const o=await F(p.value,!0);o?.data&&(m.value=o.data)}else{const o=await E(a.user.id);o?.data&&(c.value=o.data)}},ce=e=>{r.name=e.name,r.description=e.description||"",r.url=e.url||"",r.visibility=e.visibility,R.value=e.id,$.value=!0},ve=async e=>{const i=await le(e);i.error?w.notify({type:"negative",message:d("wishes.deleteError")+": "+(i.error instanceof Error?i.error.message:JSON.stringify(i.error))}):w.notify({type:"positive",message:d("wishes.deleteSuccess")})},M=async e=>{if(!a.user)return;const i=await oe(e,a.user.id);if(i.error)w.notify({type:"negative",message:d("wishes.toggleBoughtError")+": "+(i.error instanceof Error?i.error.message:JSON.stringify(i.error))});else if(u.value){const s=await F(p.value);s?.data&&(m.value=s.data)}else{const s=await E(a.user.id);s?.data&&(c.value=s.data);const o=await U(a.user.id);o?.data&&(v.value=o.data)}},I=async e=>{if(!a.user)return;const i=await ue(e,a.user.id);if(i.error)w.notify({type:"negative",message:d("wishes.toggleReceivedError")+": "+(typeof i.error=="string"?i.error:JSON.stringify(i.error))});else{if(u.value){const s=await F(p.value);s?.data&&(m.value=s.data)}else{const s=await E(a.user.id);s?.data&&(c.value=s.data);const o=await U(a.user.id);o?.data&&(v.value=o.data)}w.notify({type:"positive",message:d("wishes.toggleReceivedSuccess")})}};let Q=null;const me=async()=>{!document.hidden&&a.user&&(await A(k.params.userId),B())};we(async()=>{a.user&&(await A(k.params.userId),B()),Q=()=>{me().catch(()=>{})},document.addEventListener("visibilitychange",Q)}),We(()=>{Q&&(document.removeEventListener("visibilitychange",Q),Q=null),G()});const fe=async()=>{if(!a.user)return;const e=await te(a.user.id);e?.data&&(v.value=e.data)},he=async e=>{try{const{data:i,error:s}=await ee.from("profiles").select("name, username").eq("id",e).single();if(s)throw s;V.value=i.name||i.username||"Unknown"}catch{V.value="Unknown"}},A=async e=>{if(a.user)if(e){c.value=[],m.value=[],v.value=[],V.value="",await he(e);const i=await ae(e,!0);i?.data&&(m.value=i.data)}else{const i=c.value.length>0;c.value=[],m.value=[],v.value=[],V.value="";const s=await ie(a.user.id,i,"active");s?.data&&(c.value=s.data),await fe()}};K(()=>k.params.userId,async(e,i)=>{e!==i&&(V.value="",await A(e),B())},{immediate:!0}),K(()=>a.user?.id,async e=>{e?(await A(k.params.userId),B()):G()});const B=()=>{a.user&&(_&&_.unsubscribe(),_=ee.channel("wishes_changes").on("postgres_changes",{event:"*",schema:"public",table:"wishes"},e=>{pe(e)}).subscribe())},pe=async e=>{if(!a.user)return;const{eventType:i,new:s,old:o}=e;if(i==="INSERT"&&s)u.value&&s.created_for_user_id===p.value?await D():!u.value&&s.created_for_user_id===a.user.id&&await D();else if(i==="UPDATE"&&s)if(!u.value&&s.created_for_user_id===a.user.id){await D();const g=await U(a.user.id);g?.data&&(v.value=g.data)}else u.value&&s.created_for_user_id===p.value&&await D();else i==="DELETE"&&o&&(u.value?m.value=m.value.filter(g=>g.id!==o.id):(c.value=c.value.filter(g=>g.id!==o.id),v.value=v.value.filter(g=>g.id!==o.id)))},D=async()=>{if(a.user)if(u.value){const e=await F(p.value,!0);e?.data&&(m.value=e.data)}else{const e=await E(a.user.id);e?.data&&(c.value=e.data);const i=await U(a.user.id);i?.data&&(v.value=i.data)}},G=()=>{_&&(_.unsubscribe(),_=null)};return(e,i)=>(l(),N(qe,{class:"q-pa-md"},{default:f(()=>[h("div",Te,[h("div",Ae,y(u.value?`${V.value}'s ${e.$t("wishes.wishes")}`:e.$t("wishes.title")),1),t(j,{color:"primary",icon:"add",label:u.value?e.$t("wishes.addForFriend"):e.$t("wishes.add"),onClick:i[0]||(i[0]=s=>$.value=!0)},null,8,["label"])]),u.value?(l(),n(S,{key:1},[W(q)?(l(),n("div",Oe,[t(z,{size:"lg"})])):C.value.length===0?(l(),n("div",Je,[t(L,{name:"card_giftcard",size:"4rem"}),h("div",He,y(e.$t("wishes.noWishes")),1),h("div",null,y(e.$t("wishes.friendHasNoWishes")),1)])):(l(),n("div",xe,[(l(!0),n(S,null,O(C.value,s=>(l(),N(H,{key:s.id,wish:s,"current-user-id":W(a).user?.id,onToggleBought:M,onToggleReceived:I},null,8,["wish","current-user-id"]))),128))]))],64)):(l(),n(S,{key:0},[t(Ve,{modelValue:T.value,"onUpdate:modelValue":i[1]||(i[1]=s=>T.value=s),class:"text-primary q-mb-md"},{default:f(()=>[t(Y,{name:"my-wishes",label:e.$t("wishes.myWishes")},null,8,["label"]),t(Y,{name:"archive",label:e.$t("wishes.archive")},null,8,["label"])]),_:1},8,["modelValue"]),t(_e),t(ke,{modelValue:T.value,"onUpdate:modelValue":i[2]||(i[2]=s=>T.value=s),animated:""},{default:f(()=>[t(Z,{name:"my-wishes"},{default:f(()=>[W(q)?(l(),n("div",Be,[t(z,{size:"lg"})])):C.value.length===0?(l(),n("div",De,[t(L,{name:"card_giftcard",size:"4rem"}),h("div",Ne,y(e.$t("wishes.noWishes")),1),h("div",null,y(e.$t("wishes.addFirstWish")),1)])):(l(),n("div",Ie,[(l(!0),n(S,null,O(C.value,s=>(l(),N(H,{key:s.id,wish:s,"current-user-id":W(a).user?.id,onEdit:ce,onDelete:ve,onToggleBought:M,onToggleReceived:I},null,8,["wish","current-user-id"]))),128))]))]),_:1}),t(Z,{name:"archive"},{default:f(()=>[W(q)?(l(),n("div",Pe,[t(z,{size:"lg"})])):v.value.length===0?(l(),n("div",je,[t(L,{name:"archive",size:"4rem"}),h("div",ze,y(e.$t("wishes.noArchivedWishes")),1),h("div",null,y(e.$t("wishes.noArchivedWishesDesc")),1)])):(l(),n("div",Le,[(l(!0),n(S,null,O(v.value,s=>(l(),N(H,{key:s.id,wish:s,"current-user-id":W(a).user?.id,onToggleReceived:I},null,8,["wish","current-user-id"]))),128))]))]),_:1})]),_:1},8,["modelValue"])],64)),t(Re,{modelValue:$.value,"onUpdate:modelValue":i[8]||(i[8]=s=>$.value=s),onHide:x},{default:f(()=>[t($e,{style:{width:"100%","max-width":"500px"}},{default:f(()=>[t(X,null,{default:f(()=>[h("div",Me,y(R.value?e.$t("wishes.editWish"):e.$t("wishes.addWish")),1)]),_:1}),t(X,null,{default:f(()=>[t(Se,{onSubmit:de,class:"q-gutter-md"},{default:f(()=>[t(J,{modelValue:r.name,"onUpdate:modelValue":i[3]||(i[3]=s=>r.name=s),label:e.$t("wishes.form.name"),outlined:"",rules:[s=>!!s||e.$t("wishes.form.nameRequired")]},null,8,["modelValue","label","rules"]),t(J,{modelValue:r.description,"onUpdate:modelValue":i[4]||(i[4]=s=>r.description=s),label:e.$t("wishes.form.description"),type:"textarea",outlined:"",rows:"3"},null,8,["modelValue","label"]),t(J,{modelValue:r.url,"onUpdate:modelValue":i[5]||(i[5]=s=>r.url=s),label:e.$t("wishes.form.url"),outlined:"",type:"url"},null,8,["modelValue","label"]),t(Qe,{modelValue:r.visibility,"onUpdate:modelValue":i[6]||(i[6]=s=>r.visibility=s),label:e.$t("wishes.form.visibility"),outlined:"",options:ne,"option-value":"value","option-label":"label","emit-value":"","map-options":""},null,8,["modelValue","label"]),h("div",Ge,[t(j,{label:e.$t("common.cancel"),color:"grey",flat:"",onClick:i[7]||(i[7]=s=>$.value=!1)},null,8,["label"]),t(j,{type:"submit",label:e.$t("common.save"),color:"primary",loading:W(q)},null,8,["label","loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});export{ys as default};
