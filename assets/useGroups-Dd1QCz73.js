import{supabase as n}from"./supabase-CPQ3eL74.js";import{a as S}from"./auth-store-MnmwA6R3.js";import{r as _,z as p}from"./index-B3spGy88.js";const F=()=>{const c=_([]),l=_({}),i=_({}),f=_(0),{shouldShowLoading:m,markDataLoaded:y}=S(),v=p(()=>f.value>0),o=async(e,r=!0,t="groups")=>{const s=r&&m(t);s&&f.value++;try{const a=await e();return r&&y(t),a}finally{s&&(f.value=Math.max(0,f.value-1))}},g=async()=>o(async()=>{const{data:e,error:r}=await n.from("groups").select("*").order("created_at",{ascending:!1});return r?{data:[],error:r}:(c.value=e||[],{data:c.value,error:null})}),h=async(e,r)=>o(async()=>{const{data:t,error:s}=await n.from("groups").insert([{name:e.name,description:e.description||null,creator_id:r}]).select("*").single();return s?{data:null,error:s}:(c.value.unshift(t),{data:t,error:null})}),w=async(e,r)=>o(async()=>{const{data:t,error:s}=await n.from("groups").update(r).eq("id",e).select("*").single();if(s)return{data:null,error:s};const a=c.value.findIndex(u=>u.id===e);return a!==-1&&(c.value[a]=t),{data:t,error:null}}),q=async e=>o(async()=>{const{error:r}=await n.from("groups").delete().eq("id",e);return r?{error:r}:(c.value=c.value.filter(t=>t.id!==e),delete l.value[e],{error:null})}),G=async e=>o(async()=>{const{data:r,error:t}=await n.from("group_members").select("*").eq("group_id",e).order("created_at",{ascending:!0});return t?{data:[],error:t}:(l.value[e]=r||[],{data:l.value[e],error:null})}),x=async(e,r)=>o(async()=>{const{data:t,error:s}=await n.from("group_members").insert([{group_id:e,user_id:r}]).select("*").single();return s?{data:null,error:s}:(l.value[e]||(l.value[e]=[]),l.value[e].push(t),{data:t,error:null})}),b=async(e,r)=>o(async()=>{const{error:t}=await n.from("group_members").delete().eq("group_id",e).eq("user_id",r);return t?{error:t}:(l.value[e]=(l.value[e]||[]).filter(s=>s.user_id!==r),{error:null})}),C=async e=>o(async()=>{const{data:r,error:t}=await n.from("wish_group_rules").select("*").eq("wish_id",e);return t?{data:[],error:t}:(i.value[e]=r||[],{data:i.value[e],error:null})},!1),W=async(e,r,t)=>o(async()=>{await n.from("wish_group_rules").delete().eq("wish_id",e).eq("group_id",r);const{data:s,error:a}=await n.from("wish_group_rules").insert([{wish_id:e,group_id:r,rule_type:t}]).select("*").single();if(a)return{data:null,error:a};const u=i.value[e]||[],d=u.findIndex(R=>R.group_id===r);return d!==-1?u[d]=s:u.push(s),i.value[e]=u,{data:s,error:null}},!1),B=async(e,r)=>o(async()=>{const{error:t}=await n.from("wish_group_rules").delete().eq("wish_id",e).eq("group_id",r);return t?{error:t}:(i.value[e]=(i.value[e]||[]).filter(s=>s.group_id!==r),{error:null})},!1),L=async(e,r,t)=>o(async()=>{const s=await n.from("wish_group_rules").delete().eq("wish_id",e);if(s.error)return{error:s.error};const a=[];for(const u of r)a.push({wish_id:e,group_id:u,rule_type:"include"});for(const u of t)a.push({wish_id:e,group_id:u,rule_type:"exclude"});if(a.length>0){const{data:u,error:d}=await n.from("wish_group_rules").insert(a).select("*");if(d)return{error:d};i.value[e]=u||[]}else i.value[e]=[];return{error:null}},!1),M=async e=>o(async()=>{const{data:r,error:t}=await n.from("wish_group_rules").select("wish_id, rule_type").eq("group_id",e);if(t)return{data:{wishesCount:0,includesCount:0,excludesCount:0},error:t};const s=new Set;let a=0,u=0;for(const d of r||[])s.add(d.wish_id),d.rule_type==="include"?a++:u++;return{data:{wishesCount:s.size,includesCount:a,excludesCount:u},error:null}},!1);return{groups:p(()=>c.value),membersByGroup:p(()=>l.value),rulesByWish:p(()=>i.value),isLoading:v,fetchGroups:g,createGroup:h,updateGroup:w,deleteGroup:q,fetchGroupMembers:G,addMemberToGroup:x,removeMemberFromGroup:b,fetchWishRules:C,upsertWishRule:W,removeWishRule:B,setWishRules:L,countGroupUsage:M}};export{F as u};
