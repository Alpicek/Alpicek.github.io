import{a as ve,Q as ge}from"./QSelect-CC7M6R9u.js";import{K as Z,r as g,C as _,N as be,a2 as ne,W as he,G as j,E as ie,aZ as ye,a_ as pe,a$ as _e,b0 as Se,b1 as ke,b2 as we,b3 as J,b4 as xe,b5 as Ce,a0 as Fe,a7 as ee,al as Ve,x as qe,aK as je,H as Te,A as ze,w as Ne,b6 as G,a as se,u as oe,e as M,o as A,g as $,y as re,ax as K,f as h,t as U,q as p,p as O,h as D,v as Y,_ as ue,n as te,z as ae,aG as Ie,j as De,aP as Qe,aB as Le,m as Pe,k as Re}from"./index-BR5I7U9B.js";import{h as Ue}from"./format-SQJMwOX7.js";import{Q as $e}from"./QForm-DzuwJCeg.js";import{Q as Ae}from"./QPage-BhHXWAMh.js";import{Q as Ee,a as Be,b as le,F as Oe}from"./FeedbackDetailDialog-D6pN2iTO.js";import{Q as Me}from"./QBadge-DErxSnF2.js";import{supabase as H}from"./supabase-C7Q3J7Aw.js";import{u as ce}from"./auth-store-CLpI6O-q.js";import"./QItem-C5GHLq0T.js";import"./rtl-DFPa-2ov.js";import"./position-engine-ClI9_kBB.js";import"./selection-CVaP_A9r.js";import"./QList-D9VkAbJk.js";import"./ClosePopup-ZLXO9D4Y.js";function E(e,a,w,C){const o=[];return e.forEach(f=>{C(f)===!0?o.push(f):a.push({failedPropValidation:w,file:f})}),o}function W(e){e?.dataTransfer&&(e.dataTransfer.dropEffect="copy"),ne(e)}const He={multiple:Boolean,accept:String,capture:String,maxFileSize:[Number,String],maxTotalSize:[Number,String],maxFiles:[Number,String],filter:Function},We=["rejected"];function Ke({editable:e,dnd:a,getFileInput:w,addFilesToQueue:C}){const{props:o,emit:f,proxy:v}=Z(),m=g(null),T=_(()=>o.accept!==void 0?o.accept.split(",").map(t=>(t=t.trim(),t==="*"?"*/":(t.endsWith("/*")&&(t=t.slice(0,t.length-1)),t.toUpperCase()))):null),V=_(()=>parseInt(o.maxFiles,10)),S=_(()=>parseInt(o.maxTotalSize,10));function x(t){if(e.value)if(t!==Object(t)&&(t={target:null}),t.target?.matches('input[type="file"]')===!0)t.clientX===0&&t.clientY===0&&be(t);else{const n=w();n!==t.target&&n?.click(t)}}function y(t){e.value&&t&&C(null,t)}function F(t,n,l,i){let s=Array.from(n||t.target.files);const k=[],q=()=>{k.length!==0&&f("rejected",k)};if(o.accept!==void 0&&T.value.indexOf("*/")===-1&&(s=E(s,k,"accept",d=>T.value.some(b=>d.type.toUpperCase().startsWith(b)||d.name.toUpperCase().endsWith(b))),s.length===0))return q();if(o.maxFileSize!==void 0){const d=parseInt(o.maxFileSize,10);if(s=E(s,k,"max-file-size",b=>b.size<=d),s.length===0)return q()}if(o.multiple!==!0&&s.length!==0&&(s=[s[0]]),s.forEach(d=>{d.__key=d.webkitRelativePath+d.lastModified+d.name+d.size}),i===!0){const d=l.map(b=>b.__key);s=E(s,k,"duplicate",b=>d.includes(b.__key)===!1)}if(s.length===0)return q();if(o.maxTotalSize!==void 0){let d=i===!0?l.reduce((b,B)=>b+B.size,0):0;if(s=E(s,k,"max-total-size",b=>(d+=b.size,d<=S.value)),s.length===0)return q()}if(typeof o.filter=="function"){const d=o.filter(s);s=E(s,k,"filter",b=>d.includes(b))}if(o.maxFiles!==void 0){let d=i===!0?l.length:0;if(s=E(s,k,"max-files",()=>(d++,d<=V.value)),s.length===0)return q()}if(q(),s.length!==0)return s}function z(t){W(t),a.value!==!0&&(a.value=!0)}function c(t){ne(t),(t.relatedTarget!==null||he.is.safari!==!0?t.relatedTarget!==m.value:document.elementsFromPoint(t.clientX,t.clientY).includes(m.value)===!1)===!0&&(a.value=!1)}function Q(t){W(t);const n=t.dataTransfer.files;n.length!==0&&C(null,n),a.value=!1}function N(t){if(a.value===!0)return j("div",{ref:m,class:`q-${t}__dnd absolute-full`,onDragenter:W,onDragover:W,onDragleave:c,onDrop:Q})}return Object.assign(v,{pickFiles:x,addFiles:y}),{pickFiles:x,addFiles:y,onDragover:z,onDragleave:c,processFiles:F,getDndNode:N,maxFilesNumber:V,maxTotalSizeNumber:S}}const Xe=ie({name:"QFile",inheritAttrs:!1,props:{..._e,...pe,...He,modelValue:[File,FileList,Array],append:Boolean,useChips:Boolean,displayValue:[String,Number],tabindex:{type:[String,Number],default:0},counterLabel:Function,inputClass:[Array,String,Object],inputStyle:[Array,String,Object]},emits:[...ye,...We],setup(e,{slots:a,emit:w,attrs:C}){const{proxy:o}=Z(),f=Se(),v=g(null),m=g(!1),T=ke(e),{pickFiles:V,onDragover:S,onDragleave:x,processFiles:y,getDndNode:F}=Ke({editable:f.editable,dnd:m,getFileInput:r,addFilesToQueue:L}),z=we(e),c=_(()=>Object(e.modelValue)===e.modelValue?"length"in e.modelValue?Array.from(e.modelValue):[e.modelValue]:[]),Q=_(()=>J(c.value)),N=_(()=>c.value.map(u=>u.name).join(", ")),t=_(()=>Ue(c.value.reduce((u,I)=>u+I.size,0))),n=_(()=>({totalSize:t.value,filesNumber:c.value.length,maxFiles:e.maxFiles})),l=_(()=>({tabindex:-1,type:"file",title:"",accept:e.accept,capture:e.capture,name:T.value,...C,id:f.targetUid.value,disabled:f.editable.value!==!0})),i=_(()=>"q-file q-field--auto-height"+(m.value===!0?" q-file--dnd":"")),s=_(()=>e.multiple===!0&&e.append===!0);function k(u){const I=c.value.slice();I.splice(u,1),d(I)}function q(u){const I=c.value.indexOf(u);I!==-1&&k(I)}function d(u){w("update:modelValue",e.multiple===!0?u:u[0])}function b(u){u.keyCode===13&&Fe(u)}function B(u){(u.keyCode===13||u.keyCode===32)&&V(u)}function r(){return v.value}function L(u,I){const P=y(u,I,c.value,s.value),X=r();X!=null&&(X.value=""),P!==void 0&&((e.multiple===!0?e.modelValue&&P.every(fe=>c.value.includes(fe)):e.modelValue===P[0])||d(s.value===!0?c.value.concat(P):P))}function R(){return[j("input",{class:[e.inputClass,"q-file__filler"],style:e.inputStyle})]}function de(){if(a.file!==void 0)return c.value.length===0?R():c.value.map((I,P)=>a.file({index:P,file:I,ref:this}));if(a.selected!==void 0)return c.value.length===0?R():a.selected({files:c.value,ref:this});if(e.useChips===!0)return c.value.length===0?R():c.value.map((I,P)=>j(ve,{key:"file-"+P,removable:f.editable.value,dense:!0,textColor:e.color,tabindex:e.tabindex,onRemove:()=>{k(P)}},()=>j("span",{class:"ellipsis",textContent:I.name})));const u=e.displayValue!==void 0?e.displayValue:N.value;return u.length!==0?[j("div",{class:e.inputClass,style:e.inputStyle,textContent:u})]:R()}function me(){const u={ref:v,...l.value,...z.value,class:"q-field__input fit absolute-full cursor-pointer",onChange:L};return e.multiple===!0&&(u.multiple=!0),j("input",u)}return Object.assign(f,{fieldClass:i,emitValue:d,hasValue:Q,inputRef:v,innerValue:c,floatingLabel:_(()=>Q.value===!0||J(e.displayValue)),computedCounter:_(()=>{if(e.counterLabel!==void 0)return e.counterLabel(n.value);const u=e.maxFiles;return`${c.value.length}${u!==void 0?" / "+u:""} (${t.value})`}),getControlChild:()=>F("file"),getControl:()=>{const u={ref:f.targetRef,class:"q-field__native row items-center cursor-pointer",tabindex:e.tabindex};return f.editable.value===!0&&Object.assign(u,{onDragover:S,onDragleave:x,onKeydown:b,onKeyup:B}),j("div",u,[me()].concat(de()))}}),Object.assign(o,{removeAtIndex:k,removeFile:q,getNativeElement:()=>v.value}),xe(o,"nativeEl",()=>v.value),Ce(f)}}),Ge={ratio:[String,Number]};function Ye(e,a){return _(()=>{const w=Number(e.ratio||(a!==void 0?a.value:void 0));return isNaN(w)!==!0&&w>0?{paddingBottom:`${100/w}%`}:null})}const Ze=1.7778,Je=ie({name:"QImg",props:{...Ge,src:String,srcset:String,sizes:String,alt:String,crossorigin:String,decoding:String,referrerpolicy:String,draggable:Boolean,loading:{type:String,default:"lazy"},loadingShowDelay:{type:[Number,String],default:0},fetchpriority:{type:String,default:"auto"},width:String,height:String,initialRatio:{type:[Number,String],default:Ze},placeholderSrc:String,errorSrc:String,fit:{type:String,default:"cover"},position:{type:String,default:"50% 50%"},imgClass:String,imgStyle:Object,noSpinner:Boolean,noNativeMenu:Boolean,noTransition:Boolean,spinnerColor:String,spinnerSize:String},emits:["load","error"],setup(e,{slots:a,emit:w}){const C=g(e.initialRatio),o=Ye(e,C),f=Z(),{registerTimeout:v,removeTimeout:m}=ee(),{registerTimeout:T,removeTimeout:V}=ee(),S=_(()=>e.placeholderSrc!==void 0?{src:e.placeholderSrc}:null),x=_(()=>e.errorSrc!==void 0?{src:e.errorSrc,__qerror:!0}:null),y=[g(null),g(S.value)],F=g(0),z=g(!1),c=g(!1),Q=_(()=>`q-img q-img--${e.noNativeMenu===!0?"no-":""}menu`),N=_(()=>({width:e.width,height:e.height})),t=_(()=>`q-img__image ${e.imgClass!==void 0?e.imgClass+" ":""}q-img__image--with${e.noTransition===!0?"out":""}-transition q-img__image--`),n=_(()=>({...e.imgStyle,objectFit:e.fit,objectPosition:e.position}));function l(){if(V(),e.loadingShowDelay===0){z.value=!0;return}T(()=>{z.value=!0},e.loadingShowDelay)}function i(){V(),z.value=!1}function s({target:r}){G(f)===!1&&(m(),C.value=r.naturalHeight===0?.5:r.naturalWidth/r.naturalHeight,k(r,1))}function k(r,L){L===1e3||G(f)===!0||(r.complete===!0?q(r):v(()=>{k(r,L+1)},50))}function q(r){G(f)!==!0&&(F.value=F.value^1,y[F.value].value=null,i(),r.getAttribute("__qerror")!=="true"&&(c.value=!1),w("load",r.currentSrc||r.src))}function d(r){m(),i(),c.value=!0,y[F.value].value=x.value,y[F.value^1].value=S.value,w("error",r)}function b(r){const L=y[r].value,R={key:"img_"+r,class:t.value,style:n.value,alt:e.alt,crossorigin:e.crossorigin,decoding:e.decoding,referrerpolicy:e.referrerpolicy,height:e.height,width:e.width,loading:e.loading,fetchpriority:e.fetchpriority,"aria-hidden":"true",draggable:e.draggable,...L};return F.value===r?Object.assign(R,{class:R.class+"current",onLoad:s,onError:d}):R.class+="loaded",j("div",{class:"q-img__container absolute-full",key:"img"+r},j("img",R))}function B(){return z.value===!1?j("div",{key:"content",class:"q-img__content absolute-full q-anchor--skip"},Te(a[c.value===!0?"error":"default"])):j("div",{key:"loading",class:"q-img__loading absolute-full flex flex-center"},a.loading!==void 0?a.loading():e.noSpinner===!0?void 0:[j(ze,{color:e.spinnerColor,size:e.spinnerSize})])}{let r=function(){Ne(()=>e.src||e.srcset||e.sizes?{src:e.src,srcset:e.srcset,sizes:e.sizes}:null,L=>{m(),c.value=!1,L===null?(i(),y[F.value^1].value=S.value):l(),y[F.value].value=L},{immediate:!0})};Ve.value===!0?qe(r):r()}return()=>{const r=[];return o.value!==null&&r.push(j("div",{key:"filler",style:o.value})),y[0].value!==null&&r.push(b(0)),y[1].value!==null&&r.push(b(1)),r.push(j(je,{name:"q-transition--fade"},B)),j("div",{key:"main",class:Q.value,style:N.value,role:"img","aria-label":e.alt},r)}}}),et={class:"column q-gutter-md"},tt={class:"row items-center q-gutter-sm"},at={class:"text-subtitle1"},lt={class:"q-pa-md text-grey"},nt={key:1,class:"text-grey"},it=se({__name:"UserFeedbackList",setup(e){const{t:a}=oe(),w=ce(),C=g([]),o=g(!1),f=g({page:1,rowsPerPage:50}),v=g(!1),m=g(null),T=g(""),V=g(!1),S=!!w.profile?.is_admin,x=[{name:"created_at",label:a("feedback.created"),field:"created_at",align:"left",sortable:!0},{name:"type",label:a("feedback.type"),field:"type",align:"left",sortable:!0},{name:"subject",label:a("feedback.subject"),field:"subject",align:"left"},{name:"status",label:a("feedback.status"),field:"status",align:"left",sortable:!0}],y=t=>{if(!t)return"";const n=new Date(t);if(Number.isNaN(n.getTime()))return t;const l=n.toLocaleDateString(void 0,{year:"numeric",month:"2-digit",day:"2-digit"}),i=n.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"});return`${l} ${i}`},F=t=>{switch(t){case"new":return"orange";case"read":return"blue-grey";case"in_progress":return"info";case"resolved":return"positive";case"dismissed":return"negative";default:return"grey"}},z=async()=>{const t=w.profile?.id;if(t){o.value=!0;try{const{data:n,error:l}=await H.from("feedback").select("id, created_at, type, subject, status, message, admin_comment").eq("user_id",t).order("created_at",{ascending:!1}).limit(100);if(l)throw l;C.value=(n||[]).map(i=>({id:i.id,created_at:i.created_at||null,type:i.type,subject:i.subject??null,status:i.status||"new",message:i.message??null,admin_comment:i.admin_comment??null}))}catch(n){console.error(n)}finally{o.value=!1}}};z();const c=t=>{m.value=t,T.value=t.admin_comment||"",v.value=!0},Q=t=>({id:t.id,created_at:t.created_at,type:t.type,status:t.status,subject:t.subject,message:t.message||"",screenshotPath:null,admin_comment:t.admin_comment}),N=async t=>{if(!(!S||!m.value)){T.value=t,V.value=!0;try{const{error:n,data:l}=await H.from("feedback").update({admin_comment:T.value}).eq("id",m.value.id).select("admin_comment").single();if(n)throw n;m.value.admin_comment=l.admin_comment;const i=C.value.find(s=>s.id===m.value.id);i&&(i.admin_comment=l.admin_comment)}catch(n){console.error(n)}finally{V.value=!1}}};return(t,n)=>(A(),M("div",et,[$("div",tt,[$("div",at,U(p(a)("feedback.myFeedback")),1),h(Ee),h(O,{dense:"",flat:"",icon:"refresh",loading:o.value,onClick:z,"aria-label":p(a)("common.reload")},null,8,["loading","aria-label"])]),C.value.length?(A(),re(Be,{key:0,dense:"",flat:"",rows:C.value,columns:x,"row-key":"id",loading:o.value,pagination:f.value,"hide-bottom":"",class:"user-feedback-table",onRowClick:n[0]||(n[0]=(l,i)=>c(i))},{"body-cell-status":D(l=>[h(le,{props:l},{default:D(()=>[h(Me,{color:F(l.row.status),outline:""},{default:D(()=>[Y(U(p(a)(`feedback.status_${l.row.status}`)),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-created_at":D(l=>[h(le,{props:l},{default:D(()=>[Y(U(y(l.row.created_at)),1)]),_:2},1032,["props"])]),"no-data":D(()=>[$("div",lt,U(p(a)("feedback.none")),1)]),_:1},8,["rows","loading","pagination"])):o.value?K("",!0):(A(),M("div",nt,U(p(a)("feedback.none")),1)),h(Oe,{modelValue:v.value,"onUpdate:modelValue":n[1]||(n[1]=l=>v.value=l),feedback:m.value&&Q(m.value),"allow-status-edit":!1,"allow-admin-comment-edit":S,"status-options":[],"saving-admin-comment":V.value,onSaveAdminComment:n[2]||(n[2]=l=>N(l))},null,8,["modelValue","feedback","saving-admin-comment"])]))}}),st=ue(it,[["__scopeId","data-v-ab135761"]]),ot={class:"text-h5 q-mb-md"},rt={key:0,class:"q-mt-sm row items-start q-gutter-sm"},ut={key:1,class:"text-negative text-caption q-mt-xs"},ct={class:"text-caption text-grey-7 q-mt-xs"},dt={class:"row items-center q-gutter-sm"},mt={class:"row q-gutter-sm"},ft={key:0,class:"q-mt-lg"},vt=2*1024*1024,gt=se({__name:"FeedbackPage",setup(e){const{t:a,locale:w}=oe(),C=De(),o=Re(),f=ce(),v=g({type:"other",subject:"",message:""}),m=g(!1),T=g(null),V=g(!0),S=g(null),x=g(null),y=g(null),F=_(()=>[{label:a("feedback.typeBug"),value:"bug"},{label:a("feedback.typeIdea"),value:"idea"},{label:a("feedback.typeOther"),value:"other"}]),z=()=>V.value?{appVersion:"0.0.1",locale:w.value,userAgent:typeof navigator<"u"?navigator.userAgent:"n/a",screen:typeof window<"u"?{w:window.innerWidth,h:window.innerHeight}:null,userId:f.profile?.id||null}:null,c=()=>{v.value={type:"other",subject:"",message:""},T.value=null,N()},Q=n=>{if(y.value=null,!n){N();return}if(!n.type.startsWith("image/")){y.value=a("feedback.screenshotTypeError"),N();return}if(n.size>vt){y.value=a("feedback.screenshotTooLarge",{size:"2MB"}),N();return}S.value=n,x.value&&URL.revokeObjectURL(x.value),x.value=URL.createObjectURL(n)},N=()=>{S.value=null,x.value&&URL.revokeObjectURL(x.value),x.value=null},t=async()=>{m.value=!0;try{const l=await(async()=>{if(f.profile?.id)return f.profile.id;const{data:q}=await H.auth.getUser();return q.user?.id||null})();if(!l){o.notify({type:"negative",message:a("auth.loginError")});return}let i=null;if(S.value){const q="feedback",d=`${l}/${crypto.randomUUID()}`,{error:b}=await H.storage.from(q).upload(d,S.value,{contentType:S.value.type,upsert:!1});if(b)throw b;i={bucket:q,path:d}}const{data:s,error:k}=await H.from("feedback").insert({user_id:l,type:v.value.type,subject:v.value.subject?.trim()||null,message:v.value.message.trim(),context:{...z(),screenshot:i}}).select("id").single();if(k)throw k;T.value=s.id,o.notify({type:"positive",message:a("feedback.submitted")}),c()}catch(n){const l=n;console.error(l),l.message&&l.message.includes("row-level security")?o.notify({type:"negative",message:"RLS blocked feedback insert (user mismatch). Try again."}):o.notify({type:"negative",message:a("feedback.submitError")})}finally{m.value=!1}};return(n,l)=>(A(),re(Ae,{class:"q-pa-md column items-stretch feedback-page"},{default:D(()=>[$("div",ot,U(p(a)("feedback.title")),1),h($e,{onSubmit:Qe(t,["prevent"]),class:"column q-gutter-md",greedy:""},{default:D(()=>[h(ge,{modelValue:v.value.type,"onUpdate:modelValue":l[0]||(l[0]=i=>v.value.type=i),options:F.value,"emit-value":"","map-options":"",label:p(a)("feedback.type"),dense:"",outlined:"",disable:m.value},null,8,["modelValue","options","label","disable"]),h(te,{modelValue:v.value.subject,"onUpdate:modelValue":l[1]||(l[1]=i=>v.value.subject=i),label:p(a)("feedback.subject"),dense:"",outlined:"",maxlength:120,counter:"",disable:m.value},null,8,["modelValue","label","disable"]),h(te,{modelValue:v.value.message,"onUpdate:modelValue":l[2]||(l[2]=i=>v.value.message=i),type:"textarea",autogrow:"",label:p(a)("feedback.message"),placeholder:p(a)("feedback.placeholder"),maxlength:2e3,counter:"",outlined:"",disable:m.value,rules:[i=>!!i||p(a)("feedback.messageRequired")]},null,8,["modelValue","label","placeholder","disable","rules"]),$("div",null,[h(Xe,{modelValue:S.value,"onUpdate:modelValue":[l[3]||(l[3]=i=>S.value=i),Q],accept:"image/*",label:p(a)("feedback.screenshot"),outlined:"",dense:"",clearable:"",disable:m.value},{prepend:D(()=>[h(ae,{name:"image"})]),_:1},8,["modelValue","label","disable"]),x.value?(A(),M("div",rt,[h(Je,{src:x.value,style:{"max-width":"160px","max-height":"120px"},ratio:4/3},null,8,["src"]),h(O,{dense:"",flat:"",icon:"close",color:"negative",onClick:N,label:p(a)("feedback.removeScreenshot")},null,8,["label"])])):K("",!0),y.value?(A(),M("div",ut,U(y.value),1)):K("",!0),$("div",ct,U(p(a)("feedback.screenshotHint")),1)]),$("div",dt,[h(Ie,{modelValue:V.value,"onUpdate:modelValue":l[4]||(l[4]=i=>V.value=i),label:p(a)("feedback.includeContext"),disable:m.value},null,8,["modelValue","label","disable"]),h(ae,{name:"help_outline",size:"16px",title:p(a)("feedback.includeContextHelp")},null,8,["title"])]),$("div",mt,[h(O,{label:p(a)("feedback.submit"),type:"submit",color:"primary",loading:m.value},null,8,["label","loading"]),h(O,{flat:"",label:p(a)("common.cancel"),onClick:l[5]||(l[5]=i=>p(C).back()),disable:m.value},null,8,["label","disable"])])]),_:1}),T.value?(A(),M("div",ft,[h(Le,{dense:"",class:"bg-positive text-white"},{action:D(()=>[h(O,{flat:"",dense:"",color:"white",label:p(a)("feedback.new"),onClick:c},null,8,["label"])]),default:D(()=>[Y(U(p(a)("feedback.thanks"))+" ",1)]),_:1})])):K("",!0),h(Pe,{class:"q-my-xl"}),h(st)]),_:1}))}}),zt=ue(gt,[["__scopeId","data-v-d83d6685"]]);export{zt as default};
