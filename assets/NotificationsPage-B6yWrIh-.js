import{a as m,Q as _}from"./QCard-rq8DpM5S.js";import{Q as w}from"./QSeparator-wY4-eaUV.js";import{a as x,r as v,b as N,i as D,w as c,o as S,f as u,e as t,c as I,a1 as P,t as d,g as A,Q as p,_ as q,j as V}from"./index---xzQOhw.js";import{Q as f}from"./QInput-DoGwTWhY.js";import{Q as $}from"./QForm-CGitd5Ty.js";import{Q as R}from"./QPage-C-C9aa-p.js";import{u as W}from"./use-quasar-kE8-QRyI.js";import{u as F}from"./usePushNotifications-Be9AedKb.js";import{u as K}from"./auth-store-Bt8PQceF.js";import{supabase as O}from"./supabase-DBGUSoHq.js";import{N as G}from"./NotificationSettings-CWxRjbit.js";import{u as L}from"./vue-i18n.runtime-DIn8Ggtl.js";import"./use-dark-DQYMUBv7.js";import"./focus-manager-D9pa9QOr.js";import"./QChip-DDYm095C.js";import"./QCardActions-D9bYvr00.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const M={class:"q-pa-md",style:{"max-width":"600px",width:"100%"}},j={class:"text-h4 text-center q-mb-md"},H={class:"text-body1 text-center text-grey-6 q-mb-lg"},J={key:0},z={class:"text-h6 q-mb-md"},X={class:"q-gutter-md"},Y={class:"text-h6 q-mb-md"},Z={class:"text-h6 q-mb-md text-warning"},ii={class:"bg-warning text-dark q-pa-md rounded-borders"},hi=x({__name:"NotificationsPage",setup(ti){const b=W(),{t:n}=L(),s=F(),k=K(),a=v(!1),g=v(!1),r=N({title:"",body:"",url:""}),l=N({title:"",body:"",url:""}),C=async()=>{if(s.isSubscribed.value){a.value=!0;try{const i=await s.getCurrentSubscription();if(!i)throw new Error("No subscription found");await s.sendNotification(i,{title:r.title,body:r.body,icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"custom-notification",data:{type:"custom",url:r.url||"/",timestamp:Date.now()}}),r.title="",r.body="",r.url=""}catch(i){console.error("Error sending custom notification:",i)}finally{a.value=!1}}},Q=async()=>{if(s.isSubscribed.value){a.value=!0;try{const i=await s.getCurrentSubscription();if(!i)throw new Error("No subscription found");await s.sendNotification(i,{title:n("notifications.wishNotificationTitle"),body:n("notifications.wishNotificationBody"),icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"new-wish",data:{type:"wish",url:"/wishes",timestamp:Date.now()},actions:[{action:"view",title:n("notifications.viewWishes")},{action:"dismiss",title:n("common.close")}]})}catch(i){console.error("Error sending wish notification:",i)}finally{a.value=!1}}},B=async()=>{if(s.isSubscribed.value){a.value=!0;try{const i=await s.getCurrentSubscription();if(!i)throw new Error("No subscription found");await s.sendNotification(i,{title:n("notifications.friendRequestTitle"),body:n("notifications.friendRequestBody"),icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"friend-request",data:{type:"friend-request",url:"/friends",timestamp:Date.now()},actions:[{action:"view",title:n("notifications.viewFriends")},{action:"dismiss",title:n("common.close")}]})}catch(i){console.error("Error sending friend request notification:",i)}finally{a.value=!1}}},E=async()=>{if(console.log("=== DEBUGGING PUSH NOTIFICATIONS ==="),console.log("Notification permission:",Notification.permission),Notification.permission==="granted"&&new Notification("Test",{body:"Simple notification test"}),"serviceWorker"in navigator){const i=await navigator.serviceWorker.ready;if(console.log("Service worker registered:",i),console.log("Service worker active:",i.active),console.log("Service worker scope:",i.scope),"pushManager"in i){const e=await i.pushManager.getSubscription();console.log("Push subscription:",e),e&&(console.log("Subscription endpoint:",e.endpoint),console.log("Subscription keys:",e.getKey?{p256dh:e.getKey("p256dh"),auth:e.getKey("auth")}:"getKey not available"))}else console.error("PushManager not available")}if(console.log("Push notifications composable:",s),console.log("Is subscribed:",s.isSubscribed.value),!s.isSubscribed.value){console.error("Not subscribed to push notifications");return}a.value=!0;try{const i=await s.getCurrentSubscription();if(console.log("Subscription found:",i),!i)throw new Error("No subscription found");await s.sendNotification(i,{title:n("notifications.birthdayTitle"),body:n("notifications.birthdayBody"),icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"birthday",data:{type:"birthday",url:"/friends",timestamp:Date.now()},actions:[{action:"view",title:n("notifications.viewProfile")},{action:"dismiss",title:n("common.close")}]})}catch(i){console.error("Error sending birthday notification:",i)}finally{a.value=!1}},U=async()=>{g.value=!0;try{const{data:i,error:e}=await O.from("push_subscriptions").select("subscription_data").eq("is_active",!0);if(e)throw e;if(!i||i.length===0){b.notify({type:"warning",message:n("notifications.noSubscriptions"),timeout:3e3});return}let o=0,h=0;for(const T of i)try{const y={toJSON:()=>T.subscription_data};await s.sendNotification(y,{title:l.title,body:l.body,icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"admin-broadcast",data:{type:"admin-broadcast",url:l.url||"/",timestamp:Date.now()}}),o++}catch(y){console.error("Error sending to subscription:",y),h++}b.notify({type:o>0?"positive":"negative",message:n("notifications.broadcastResult",{success:o,errors:h}),timeout:5e3}),o>0&&(l.title="",l.body="",l.url="")}catch(i){console.error("Error sending admin notification:",i),b.notify({type:"negative",message:n("notifications.broadcastError"),timeout:5e3})}finally{g.value=!1}};return(i,e)=>(S(),D(R,{class:"flex flex-center"},{default:c(()=>[u("div",M,[t(_,null,{default:c(()=>[t(m,null,{default:c(()=>[u("div",j,d(i.$t("notifications.title")),1),u("div",H,d(i.$t("notifications.pageDescription")),1)]),_:1}),t(m,null,{default:c(()=>[t(G)]),_:1}),A(k).user?.email==="pichalek@gmail.com"?(S(),I("div",J,[t(m,null,{default:c(()=>[t(w,{class:"q-mb-md"}),u("div",z,d(i.$t("notifications.quickActions")),1),u("div",X,[t(p,{color:"primary",icon:"card_giftcard",label:i.$t("notifications.notifyNewWish"),onClick:Q,loading:a.value,class:"full-width"},null,8,["label","loading"]),t(p,{color:"secondary",icon:"group",label:i.$t("notifications.notifyFriendRequest"),onClick:B,loading:a.value,class:"full-width"},null,8,["label","loading"]),t(p,{color:"accent",icon:"celebration",label:i.$t("notifications.notifyBirthday"),onClick:E,loading:a.value,class:"full-width"},null,8,["label","loading"])])]),_:1}),t(m,null,{default:c(()=>[t(w,{class:"q-mb-md"}),u("div",Y,d(i.$t("notifications.customNotification")),1),t($,{onSubmit:C,class:"q-gutter-md"},{default:c(()=>[t(f,{modelValue:r.title,"onUpdate:modelValue":e[0]||(e[0]=o=>r.title=o),label:i.$t("notifications.notificationTitle"),outlined:"",rules:[o=>!!o||i.$t("common.required")]},null,8,["modelValue","label","rules"]),t(f,{modelValue:r.body,"onUpdate:modelValue":e[1]||(e[1]=o=>r.body=o),label:i.$t("notifications.notificationBody"),outlined:"",type:"textarea",rows:"3",rules:[o=>!!o||i.$t("common.required")]},null,8,["modelValue","label","rules"]),t(f,{modelValue:r.url,"onUpdate:modelValue":e[2]||(e[2]=o=>r.url=o),label:i.$t("notifications.targetUrl"),outlined:"",placeholder:"/wishes",hint:"Optional URL to open when notification is clicked"},null,8,["modelValue","label"]),t(p,{type:"submit",color:"primary",icon:"send",label:i.$t("notifications.sendCustom"),loading:a.value,class:"full-width"},null,8,["label","loading"])]),_:1})]),_:1}),t(m,null,{default:c(()=>[t(w,{class:"q-mb-md"}),u("div",Z,[t(V,{name:"admin_panel_settings",class:"q-mr-sm"}),q(" "+d(i.$t("notifications.adminSection")),1)]),t($,{onSubmit:U,class:"q-gutter-md"},{default:c(()=>[t(f,{modelValue:l.title,"onUpdate:modelValue":e[3]||(e[3]=o=>l.title=o),label:i.$t("notifications.notificationTitle"),outlined:"",rules:[o=>!!o||i.$t("common.required")]},null,8,["modelValue","label","rules"]),t(f,{modelValue:l.body,"onUpdate:modelValue":e[4]||(e[4]=o=>l.body=o),label:i.$t("notifications.notificationBody"),outlined:"",type:"textarea",rows:"3",rules:[o=>!!o||i.$t("common.required")]},null,8,["modelValue","label","rules"]),t(f,{modelValue:l.url,"onUpdate:modelValue":e[5]||(e[5]=o=>l.url=o),label:i.$t("notifications.targetUrl"),outlined:"",placeholder:"/"},null,8,["modelValue","label"]),u("div",ii,[t(V,{name:"warning",class:"q-mr-sm"}),q(" "+d(i.$t("notifications.adminWarning")),1)]),t(p,{type:"submit",color:"warning",icon:"campaign",label:i.$t("notifications.sendToAll"),loading:g.value,class:"full-width"},null,8,["label","loading"])]),_:1})]),_:1})])):P("",!0)]),_:1})])]),_:1}))}});export{hi as default};
