import{a as ge,z as P,r as b,b as ye,n as we,aC as be,af as We,w as K,p as N,f,o as r,h,c as n,e as t,t as y,k as z,i as _e,l as W,s as j,q as L,au as S,av as O,Q as $e,g as X,j as J,aD as Re}from"./index-D27XNSYz.js";import{a as Y,Q as Ve}from"./QTabs-h-h4Tfrp.js";import{a as Z,Q as ke}from"./QTabPanels-DLt6fU30.js";import{Q as Qe}from"./QSelect-nDTDzA6N.js";import{Q as Se}from"./QForm-BZy2mtOn.js";import{Q as qe}from"./QPage-Dy-J6F1K.js";import{u as Ee}from"./useWishes-DHbHZfoG.js";import{u as Ce}from"./auth-store-DIdeLsq-.js";import{u as Fe}from"./use-quasar-BotVfJR3.js";import{supabase as ee}from"./supabase-Dw8x5Xws.js";import{W as H}from"./WishCard-CSQfCM8_.js";import{u as Ue}from"./vue-i18n.runtime-D6Rwe0Ae.js";import"./QResizeObserver-DY0dzyEu.js";import"./rtl-DFPa-2ov.js";import"./touch-BjYP5sR0.js";import"./selection-CGeNsZmr.js";import"./QItem-CVXzD_iB.js";import"./format-BmU5OcL9.js";import"./position-engine-BHPZTd0e.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Te={class:"row justify-between items-center q-mb-md"},Ae={class:"text-h4"},Be={key:0,class:"flex justify-center"},De={key:1,class:"text-center text-grey-6 q-py-lg"},Ne={class:"text-h6 q-mt-md"},Ie={key:2,class:"row q-gutter-md"},Pe={key:0,class:"flex justify-center"},ze={key:1,class:"text-center text-grey-6 q-py-lg"},je={class:"text-h6 q-mt-md"},Le={key:2,class:"row q-gutter-md"},Oe={key:0,class:"flex justify-center"},Je={key:1,class:"text-center text-grey-6 q-py-lg"},He={class:"text-h6 q-mt-md"},xe={key:2,class:"row q-gutter-md"},Me={class:"text-h6"},Ge={class:"row justify-end q-gutter-sm"},gs=ge({__name:"WishesPage",setup(Ke){const w=Fe(),{t:d}=Ue(),k=be(),a=Ce(),p=P(()=>k.params.userId),u=P(()=>!!p.value),{isLoading:q,createWish:se,fetchWishes:ie,fetchAllWishesForUser:ae,fetchReceivedWishes:te,refreshWishes:E,refreshAllWishesForUser:C,refreshReceivedWishes:F,updateWish:le,deleteWish:re,toggleBought:oe,toggleReceived:ue}=Ee(),c=b([]),m=b([]),U=P(()=>u.value?m.value:c.value);let _=null;const T=b("my-wishes"),$=b(!1),R=b(null),v=b([]),V=b(""),l=ye({name:"",description:"",url:"",visibility:"friends"}),ne=[{label:d("wishes.form.visibilityPublic"),value:"public"},{label:d("wishes.form.visibilityFriends"),value:"friends"},{label:d("wishes.form.visibilityPrivate"),value:"private"}],x=()=>{l.name="",l.description="",l.url="",l.visibility="friends",R.value=null},de=async()=>{if(!a.user)return;const e=u.value?p.value:a.user.id;if(!e)return;const i={name:l.name,...l.description&&{description:l.description},...l.url&&{url:l.url},visibility:l.visibility,created_for_user_id:e,created_by_user_id:a.user.id};let s;if(R.value?s=await le(R.value,i):s=await se(i),s.error)w.notify({type:"negative",message:d("wishes.saveError")+": "+(s.error instanceof Error?s.error.message:JSON.stringify(s.error))});else if(w.notify({type:"positive",message:R.value?d("wishes.updateSuccess"):d("wishes.createSuccess")}),$.value=!1,x(),u.value){const o=await C(p.value,!0);o?.data&&(m.value=o.data)}else{const o=await E(a.user.id);o?.data&&(c.value=o.data)}},ce=e=>{l.name=e.name,l.description=e.description||"",l.url=e.url||"",l.visibility=e.visibility,R.value=e.id,$.value=!0},ve=async e=>{const i=await re(e);i.error?w.notify({type:"negative",message:d("wishes.deleteError")+": "+(i.error instanceof Error?i.error.message:JSON.stringify(i.error))}):w.notify({type:"positive",message:d("wishes.deleteSuccess")})},M=async e=>{if(!a.user)return;const i=await oe(e,a.user.id);if(i.error)w.notify({type:"negative",message:d("wishes.toggleBoughtError")+": "+(i.error instanceof Error?i.error.message:JSON.stringify(i.error))});else if(u.value){const s=await C(p.value);s?.data&&(m.value=s.data)}else{const s=await E(a.user.id);s?.data&&(c.value=s.data);const o=await F(a.user.id);o?.data&&(v.value=o.data)}},I=async e=>{if(!a.user)return;const i=await ue(e,a.user.id);if(i.error)w.notify({type:"negative",message:d("wishes.toggleReceivedError")+": "+(typeof i.error=="string"?i.error:JSON.stringify(i.error))});else{if(u.value){const s=await C(p.value);s?.data&&(m.value=s.data)}else{const s=await E(a.user.id);s?.data&&(c.value=s.data);const o=await F(a.user.id);o?.data&&(v.value=o.data)}w.notify({type:"positive",message:d("wishes.toggleReceivedSuccess")})}};let Q=null;const me=async()=>{!document.hidden&&a.user&&(await A(k.params.userId),B())};we(async()=>{a.user&&(await A(k.params.userId),B()),Q=()=>{me().catch(()=>{})},document.addEventListener("visibilitychange",Q)}),We(()=>{Q&&(document.removeEventListener("visibilitychange",Q),Q=null),G()});const fe=async()=>{if(!a.user)return;const e=await te(a.user.id);e?.data&&(v.value=e.data)},he=async e=>{try{const{data:i,error:s}=await ee.from("profiles").select("name, username").eq("id",e).single();if(s)throw s;V.value=i.name||i.username||"Unknown"}catch{V.value="Unknown"}},A=async e=>{if(a.user)if(e){c.value=[],m.value=[],v.value=[],V.value="",await he(e);const i=await ae(e,!0);i?.data&&(m.value=i.data)}else{const i=c.value.length>0;c.value=[],m.value=[],v.value=[],V.value="";const s=await ie(a.user.id,i,"active");s?.data&&(c.value=s.data),await fe()}};K(()=>k.params.userId,async(e,i)=>{e!==i&&(V.value="",await A(e),B())},{immediate:!0}),K(()=>a.user?.id,async e=>{e?(await A(k.params.userId),B()):G()});const B=()=>{a.user&&(_&&_.unsubscribe(),_=ee.channel("wishes_changes").on("postgres_changes",{event:"*",schema:"public",table:"wishes"},e=>{pe(e)}).subscribe())},pe=async e=>{if(!a.user)return;const{eventType:i,new:s,old:o}=e;if(i==="INSERT"&&s)u.value&&s.created_for_user_id===p.value?await D():!u.value&&s.created_for_user_id===a.user.id&&await D();else if(i==="UPDATE"&&s)if(!u.value&&s.created_for_user_id===a.user.id){await D();const g=await F(a.user.id);g?.data&&(v.value=g.data)}else u.value&&s.created_for_user_id===p.value&&await D();else i==="DELETE"&&o&&(u.value?m.value=m.value.filter(g=>g.id!==o.id):(c.value=c.value.filter(g=>g.id!==o.id),v.value=v.value.filter(g=>g.id!==o.id)))},D=async()=>{if(a.user)if(u.value){const e=await C(p.value,!0);e?.data&&(m.value=e.data)}else{const e=await E(a.user.id);e?.data&&(c.value=e.data);const i=await F(a.user.id);i?.data&&(v.value=i.data)}},G=()=>{_&&(_.unsubscribe(),_=null)};return(e,i)=>(r(),N(qe,{class:"q-pa-md"},{default:f(()=>[h("div",Te,[h("div",Ae,y(u.value?`${V.value}'s ${e.$t("wishes.wishes")}`:e.$t("wishes.title")),1),t(z,{color:"primary",icon:"add",label:u.value?e.$t("wishes.addForFriend"):e.$t("wishes.add"),onClick:i[0]||(i[0]=s=>$.value=!0)},null,8,["label"])]),u.value?(r(),n(S,{key:1},[W(q)?(r(),n("div",Oe,[t(j,{size:"lg"})])):U.value.length===0?(r(),n("div",Je,[t(L,{name:"card_giftcard",size:"4rem"}),h("div",He,y(e.$t("wishes.noWishes")),1),h("div",null,y(e.$t("wishes.friendHasNoWishes")),1)])):(r(),n("div",xe,[(r(!0),n(S,null,O(U.value,s=>(r(),N(H,{key:s.id,wish:s,"current-user-id":W(a).user?.id,onToggleBought:M,onToggleReceived:I},null,8,["wish","current-user-id"]))),128))]))],64)):(r(),n(S,{key:0},[t(Ve,{modelValue:T.value,"onUpdate:modelValue":i[1]||(i[1]=s=>T.value=s),class:"text-primary q-mb-md"},{default:f(()=>[t(Y,{name:"my-wishes",label:e.$t("wishes.myWishes")},null,8,["label"]),t(Y,{name:"archive",label:e.$t("wishes.archive")},null,8,["label"])]),_:1},8,["modelValue"]),t(_e),t(ke,{modelValue:T.value,"onUpdate:modelValue":i[2]||(i[2]=s=>T.value=s),animated:""},{default:f(()=>[t(Z,{name:"my-wishes"},{default:f(()=>[W(q)?(r(),n("div",Be,[t(j,{size:"lg"})])):U.value.length===0?(r(),n("div",De,[t(L,{name:"card_giftcard",size:"4rem"}),h("div",Ne,y(e.$t("wishes.noWishes")),1),h("div",null,y(e.$t("wishes.addFirstWish")),1)])):(r(),n("div",Ie,[(r(!0),n(S,null,O(U.value,s=>(r(),N(H,{key:s.id,wish:s,"current-user-id":W(a).user?.id,onEdit:ce,onDelete:ve,onToggleBought:M,onToggleReceived:I},null,8,["wish","current-user-id"]))),128))]))]),_:1}),t(Z,{name:"archive"},{default:f(()=>[W(q)?(r(),n("div",Pe,[t(j,{size:"lg"})])):v.value.length===0?(r(),n("div",ze,[t(L,{name:"archive",size:"4rem"}),h("div",je,y(e.$t("wishes.noArchivedWishes")),1),h("div",null,y(e.$t("wishes.noArchivedWishesDesc")),1)])):(r(),n("div",Le,[(r(!0),n(S,null,O(v.value,s=>(r(),N(H,{key:s.id,wish:s,"current-user-id":W(a).user?.id,onToggleReceived:I},null,8,["wish","current-user-id"]))),128))]))]),_:1})]),_:1},8,["modelValue"])],64)),t(Re,{modelValue:$.value,"onUpdate:modelValue":i[8]||(i[8]=s=>$.value=s),onHide:x},{default:f(()=>[t($e,{style:{width:"100%","max-width":"500px"}},{default:f(()=>[t(X,null,{default:f(()=>[h("div",Me,y(R.value?e.$t("wishes.editWish"):e.$t("wishes.addWish")),1)]),_:1}),t(X,null,{default:f(()=>[t(Se,{onSubmit:de,class:"q-gutter-md"},{default:f(()=>[t(J,{modelValue:l.name,"onUpdate:modelValue":i[3]||(i[3]=s=>l.name=s),label:e.$t("wishes.form.name"),outlined:"",rules:[s=>!!s||e.$t("wishes.form.nameRequired")]},null,8,["modelValue","label","rules"]),t(J,{modelValue:l.description,"onUpdate:modelValue":i[4]||(i[4]=s=>l.description=s),label:e.$t("wishes.form.description"),type:"textarea",outlined:"",rows:"3"},null,8,["modelValue","label"]),t(J,{modelValue:l.url,"onUpdate:modelValue":i[5]||(i[5]=s=>l.url=s),label:e.$t("wishes.form.url"),outlined:"",type:"url"},null,8,["modelValue","label"]),t(Qe,{modelValue:l.visibility,"onUpdate:modelValue":i[6]||(i[6]=s=>l.visibility=s),label:e.$t("wishes.form.visibility"),outlined:"",options:ne,"option-value":"value","option-label":"label","emit-value":"","map-options":""},null,8,["modelValue","label"]),h("div",Ge,[t(z,{label:e.$t("common.cancel"),color:"grey",flat:"",onClick:i[7]||(i[7]=s=>$.value=!1)},null,8,["label"]),t(z,{type:"submit",label:e.$t("common.save"),color:"primary",loading:W(q)},null,8,["label","loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});export{gs as default};
