import{supabase as i}from"./supabase-CI4kAcGq.js";import{a as R}from"./auth-store-CNvokGra.js";import{m as f,r as g}from"./index-v3dJaZ__.js";const v=g([]),q=g([]),s=g(0),E=f(()=>s.value>0);let a=null,l=null;const B=()=>{const{shouldShowLoading:u,markDataLoaded:p}=R(),w=f(()=>E.value),_=f(()=>q.value),y=f(()=>v.value),b=async(r,n)=>{s.value++;try{const{data:e,error:t}=await i.from("friendships").insert([{user_id:n,friend_id:r,status:"pending"}]).select().single();if(t)throw t;return{data:e,error:null}}catch(e){return console.error("Error sending friend request:",e),{data:null,error:e}}finally{s.value--}},C=async(r,n)=>{s.value++;try{const{data:e,error:t}=await i.from("friendships").update({status:"accepted"}).eq("id",r).select().single();if(t)throw t;return n&&await d(n,!0),{data:e,error:null}}catch(e){return console.error("Error accepting friend request:",e),{data:null,error:e}}finally{s.value--}},L=async r=>{s.value++;try{const{data:n,error:e}=await i.from("friendships").update({status:"declined"}).eq("id",r).select().single();if(e)throw e;return{data:n,error:null}}catch(n){return console.error("Error declining friend request:",n),{data:null,error:n}}finally{s.value--}},d=async(r,n=!1)=>{if(r){!n&&u("friends")&&s.value++;try{const{data:e,error:t}=await i.from("friendships").select(`
          *,
          friend:profiles!friendships_friend_id_fkey(*),
          user:profiles!friendships_user_id_fkey(*)
        `).or(`user_id.eq.${r},friend_id.eq.${r}`).eq("status","accepted");if(t)throw t;const c=e?.map(o=>o.user_id===r?o.friend:o.user)||[];return q.value=c,v.value=e||[],n||p("friends"),{data:c,error:null}}catch(e){return console.error("Error fetching friends:",e),{data:null,error:e}}finally{!n&&u("friends")&&s.value--}}},m=async(r,n=!1)=>{if(r){console.log("📋 fetchPendingRequests called - userId:",r,"isBackgroundRefresh:",n,"current loadingCounter:",s.value),!n&&u("pendingRequests")?(s.value++,console.log("⬆️ loadingCounter incremented to:",s.value)):console.log("🔕 Background refresh or already loaded - NOT incrementing loadingCounter");try{const{data:e,error:t}=await i.from("friendships").select(`
          *,
          user:profiles!friendships_user_id_fkey(*)
        `).eq("friend_id",r).eq("status","pending"),{data:c,error:o}=await i.from("friendships").select(`
          *,
          friend:profiles!friendships_friend_id_fkey(*)
        `).eq("user_id",r).eq("status","pending");if(t)throw t;if(o)throw o;const F=[...e?.map(h=>({...h,type:"incoming"}))||[],...c?.map(h=>({...h,type:"outgoing"}))||[]];return n||p("pendingRequests"),{data:F,error:null}}catch(e){return console.error("Error fetching pending requests:",e),{data:null,error:e}}finally{!n&&u("pendingRequests")?(s.value--,console.log("⬇️ fetchPendingRequests loadingCounter decremented to:",s.value)):console.log("🔕 Background refresh or already loaded - NOT decrementing loadingCounter")}}};return{friends:_,friendships:y,isLoading:w,sendFriendRequest:b,acceptFriendRequest:C,declineFriendRequest:L,fetchFriends:d,fetchPendingRequests:m,searchUsers:async r=>{s.value++;try{const{data:n,error:e}=await i.rpc("search_users",{search_query:r,limit_count:10});if(e)throw e;return{data:n,error:null}}catch(n){console.error("Error searching users:",n);try{const{data:e,error:t}=await i.from("profiles").select("*").eq("is_dummy",!1).limit(10);if(t)throw t;return{data:e?.filter(o=>o.email.toLowerCase().includes(r.toLowerCase())||o.name&&o.name.toLowerCase().includes(r.toLowerCase())||o.surname&&o.surname.toLowerCase().includes(r.toLowerCase())||o.username&&o.username.toLowerCase().includes(r.toLowerCase()))||[],error:null}}catch(e){return console.error("Fallback search also failed:",e),{data:null,error:e}}}finally{s.value--}},removeFriend:async(r,n)=>{s.value++;try{const{error:e}=await i.from("friendships").delete().eq("id",r);if(e)throw e;return n&&await d(n,!0),{error:null}}catch(e){return console.error("Error removing friend:",e),{error:e}}finally{s.value--}},resetLoadingState:async r=>{console.log("🔄 resetLoadingState called - before:",s.value),s.value=0,console.log("🔄 resetLoadingState - after reset:",s.value),r&&(console.log("🔄 resetLoadingState - calling fetchFriends with isBackgroundRefresh=true"),await d(r,!0))},subscribeToFriendships:r=>{a&&i.removeChannel(a),a=i.channel(`friendships:${r}`).on("postgres_changes",{event:"*",schema:"public",table:"friendships",filter:`or(user_id.eq.${r},friend_id.eq.${r})`},n=>{console.log("📡 Friendships realtime update:",n),console.log("🔄 Calling fetchFriends with isBackgroundRefresh=true"),d(r,!0)}).subscribe()},subscribeToPendingRequests:(r,n)=>{l&&i.removeChannel(l),l=i.channel(`pending_requests:${r}`).on("postgres_changes",{event:"*",schema:"public",table:"friendships",filter:`and(or(user_id.eq.${r},friend_id.eq.${r}),status.eq.pending)`},e=>{console.log("📋 Pending requests realtime update:",e),console.log("🔄 Calling fetchPendingRequests with isBackgroundRefresh=true"),m(r,!0).then(t=>{t?.data&&n&&n(t.data)})}).subscribe()},unsubscribeFromFriendships:()=>{a&&(i.removeChannel(a),a=null),l&&(i.removeChannel(l),l=null)}}};export{B as u};
