import{a as J,s as y,o as r,Q as M,g as i,e as n,i as T,f as d,au as K,c as o,t as u,at as C,u as xe,z,p as O,v as G,av as he,F as w,l as h,r as q,w as N,q as ue,O as Pe,aB as Ee,j as Ne,m as D,x as ce,A as V,aC as me,a7 as Oe,aD as Ge,k as Te,aE as Be,aA as Le}from"./index-CzEHk4FJ.js";import{a as fe,Q as je}from"./QTabs-hMbSUOU_.js";import{Q as Ue}from"./QSlideTransition-CuHHXKmI.js";import{a as ve,Q as ze}from"./QTabPanels-Cehjd_OV.js";import{Q as Je,a as U,b as pe}from"./QItem-atIWw8xQ.js";import{Q as Me}from"./QList-CCrgn17T.js";import{Q as Ke}from"./QPage-GP0CvhFB.js";import{u as He}from"./use-quasar-jdesDfeO.js";import{u as Ye}from"./auth-store-B9ZbRhc6.js";import{u as Ze}from"./useFriends-DJYu5NqC.js";import{Q as Xe}from"./QBadge-B8zPsIYt.js";import{_ as _e}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{u as We}from"./useGroups-C__TII0R.js";import{u as et}from"./vue-i18n.runtime-zO4z2J8f.js";import"./QResizeObserver-BXHMh2fz.js";import"./rtl-DFPa-2ov.js";import"./touch-BjYP5sR0.js";import"./selection-DmknuNDx.js";import"./supabase-RdUxExGH.js";const tt={class:"row items-center q-gutter-md"},st=["src"],at={key:1},nt={class:"friend-info flex-1"},rt={class:"row items-center q-gutter-sm"},it={class:"text-h6 friend-name"},ot={key:0,class:"text-subtitle2 text-grey-6"},lt=J({__name:"FriendCard",props:{friend:{},friendshipId:{}},setup(P){const m=P,c=xe(),l=()=>{c.push(`/app/friend/${m.friend.id}`)},k=a=>a.name&&a.surname?`${a.name} ${a.surname}`:a.username||a.email,A=a=>a.name&&a.surname?`${a.name.charAt(0)}${a.surname.charAt(0)}`:a.username?a.username.charAt(0).toUpperCase():a.email.charAt(0).toUpperCase();return(a,v)=>(r(),y(M,{class:"friend-card",onClick:l},{default:i(()=>[n(T,{class:"friend-card-content"},{default:i(()=>[d("div",tt,[n(K,{size:"50px",color:"primary","text-color":"white"},{default:i(()=>[a.friend.avatar_url?(r(),o("img",{key:0,src:a.friend.avatar_url},null,8,st)):(r(),o("span",at,u(A(a.friend)),1))]),_:1}),d("div",nt,[d("div",rt,[d("div",it,u(k(a.friend)),1),a.friend.is_dummy?(r(),y(Xe,{key:0,color:"orange",label:a.$t("dummyProfiles.dummy"),rounded:""},null,8,["label"])):C("",!0)]),a.friend.username?(r(),o("div",ot," @"+u(a.friend.username),1)):C("",!0)])])]),_:1})]),_:1}))}}),ge=_e(lt,[["__scopeId","data-v-cd8780a2"]]),dt=["src"],ut={key:1},ct={class:"text-h6 q-mt-md"},mt={key:0,class:"text-subtitle2 text-grey-6"},ft={class:"text-body2 text-grey-7 q-mt-sm"},vt={class:"text-caption text-grey-6 q-mt-xs"},pt=J({__name:"PendingRequestCard",props:{request:{}},emits:["accept","decline","cancel"],setup(P){const m=P,c=z(()=>m.request.type==="incoming"?m.request.user:m.request.friend),l=a=>a.name&&a.surname?`${a.name} ${a.surname}`:a.username||a.email,k=a=>a.name&&a.surname?`${a.name.charAt(0)}${a.surname.charAt(0)}`:a.username?a.username.charAt(0).toUpperCase():a.email.charAt(0).toUpperCase(),A=a=>{const v=new Date(a),B=Math.abs(new Date().getTime()-v.getTime()),b=Math.ceil(B/(1e3*60*60*24));return b===1?"Dnes":b===2?"Včera":b<7?`Před ${b} dny`:v.toLocaleDateString("cs-CZ")};return(a,v)=>(r(),y(M,{class:"pending-card",style:{width:"100%","max-width":"300px"}},{default:i(()=>[n(T,{class:"text-center"},{default:i(()=>[n(K,{size:"60px",color:"primary","text-color":"white"},{default:i(()=>[c.value.avatar_url?(r(),o("img",{key:0,src:c.value.avatar_url},null,8,dt)):(r(),o("span",ut,u(k(c.value)),1))]),_:1}),d("div",ct,u(l(c.value)),1),c.value.username?(r(),o("div",mt," @"+u(c.value.username),1)):C("",!0),d("div",ft,[n(G,{name:"schedule",size:"16px",class:"q-mr-xs"}),O(" "+u(a.request.created_at?A(a.request.created_at):"N/A"),1)]),d("div",vt,u(a.request.type==="incoming"?"Požadavek od uživatele":"Odeslaný požadavek"),1)]),_:1}),n(he,{align:"center"},{default:i(()=>[a.request.type==="incoming"?(r(),o(w,{key:0},[n(h,{color:"positive",flat:"",icon:"check",label:"Přijmout",onClick:v[0]||(v[0]=p=>a.$emit("accept",a.request.id))}),n(h,{color:"negative",flat:"",icon:"close",label:"Odmítnout",onClick:v[1]||(v[1]=p=>a.$emit("decline",a.request.id))})],64)):(r(),o(w,{key:1},[n(h,{color:"grey",flat:"",icon:"schedule",label:"Čeká na odpověď",disabled:""}),n(h,{color:"negative",flat:"",icon:"close",label:"Zrušit",onClick:v[2]||(v[2]=p=>a.$emit("cancel",a.request.id))})],64))]),_:1})]),_:1}))}}),gt=_e(pt,[["__scopeId","data-v-7b9f5f5e"]]),yt={class:"row justify-between items-center q-mb-md"},ht={class:"text-h4"},_t={class:"row items-center q-gutter-sm"},bt={key:0,class:"flex justify-center"},$t={key:1,class:"text-center text-grey-6 q-py-lg"},kt={class:"text-h6 q-mt-md"},qt={key:2},wt=["onClick"],Ct={class:"text-subtitle1"},Qt={class:"row q-gutter-md"},St={key:1,class:"row q-gutter-md"},At={key:0,class:"flex justify-center"},Ft={key:1,class:"text-center text-grey-6 q-py-lg"},Rt={class:"text-h6 q-mt-md"},It={key:2,class:"row q-gutter-md"},Dt={class:"text-h6"},Vt={key:0,class:"q-mt-md"},xt={class:"text-subtitle2 q-mb-sm"},ye="friends.groupByGroups",x="friends.expandedGroups",es=J({__name:"FriendsPage",setup(P){const m=He(),{t:c}=et(),l=Ye(),{groups:k,fetchGroups:A,fetchGroupMembers:a,membersByGroup:v}=We(),{friends:p,friendships:B,isLoading:b,sendFriendRequest:be,acceptFriendRequest:$e,declineFriendRequest:H,fetchFriends:Y,fetchPendingRequests:ke,searchUsers:qe,resetLoadingState:L,subscribeToFriendships:Z,subscribeToPendingRequests:X,unsubscribeFromFriendships:W}=Ze(),E=q("friends"),F=q(!1),Q=q(""),R=q([]),S=q([]),$=q(localStorage.getItem(ye)==="1");N(()=>$.value,e=>localStorage.setItem(ye,e?"1":"0"));const ee=z(()=>{if(!$.value)return[];const e={};for(const _ of k.value){const I=v.value[_.id]||[],de=p.value.filter(De=>I.some(Ve=>Ve.user_id===De.id));de.length>0&&(e[_.id]={id:_.id,name:_.name,items:de})}const t=new Set(Object.values(e).flatMap(_=>_.items.map(I=>I.id))),s=p.value.filter(_=>!t.has(_.id)),le=[...Object.values(e).sort((_,I)=>_.name.localeCompare(I.name,void 0,{sensitivity:"base"}))];return s.length>0&&le.push({id:null,name:c("friends.other"),items:s}),le}),we=z(()=>k.value.length>0),f=q((()=>{try{const e=localStorage.getItem(x);return e?JSON.parse(e):{}}catch{return{}}})());N(()=>ee.value,e=>{if(!$.value)return;const t={...f.value};for(const s of e){const g=s.id||"ungrouped";g in t||(t[g]=!0)}f.value=t},{immediate:!0});const te=e=>{const t=e||"ungrouped";f.value[t]=!f.value[t],localStorage.setItem(x,JSON.stringify(f.value))},Ce=()=>{for(const e of Object.keys(f.value))f.value[e]=!1;localStorage.setItem(x,JSON.stringify(f.value))},Qe=()=>{for(const e of Object.keys(f.value))f.value[e]=!0;localStorage.setItem(x,JSON.stringify(f.value))};N(()=>f.value,e=>{try{localStorage.setItem(x,JSON.stringify(e))}catch{}},{deep:!0});const Se=e=>e.name&&e.surname?`${e.name} ${e.surname}`:e.username||e.email,Ae=e=>e.name&&e.surname?`${e.name.charAt(0)}${e.surname.charAt(0)}`:e.username?e.username.charAt(0).toUpperCase():e.email.charAt(0).toUpperCase(),se=()=>{Q.value="",R.value=[]},ae=e=>l.user&&B.value.find(s=>s.user_id===l.user.id&&s.friend_id===e||s.friend_id===l.user.id&&s.user_id===e)?.id||"",j=async()=>{if(Q.value.trim().length<2){R.value=[];return}const e=await qe(Q.value);if(e.data){const t=p.value.map(s=>s.id);R.value=e.data.filter(s=>s.id!==l.user?.id&&!t.includes(s.id))}},ne=async e=>{if(!l.user)return;const t=await be(e,l.user.id);t.error?m.notify({type:"negative",message:c("friends.sendRequestError")+": "+(t.error instanceof Error?t.error.message:JSON.stringify(t.error))}):(m.notify({type:"positive",message:c("friends.sendRequestSuccess")}),F.value=!1,se())},Fe=async e=>{if(!l.user)return;const t=await $e(e,l.user.id);t.error?m.notify({type:"negative",message:c("friends.acceptRequestError")+": "+(t.error instanceof Error?t.error.message:JSON.stringify(t.error))}):m.notify({type:"positive",message:c("friends.acceptRequestSuccess")})},Re=async e=>{const t=await H(e);t.error?m.notify({type:"negative",message:c("friends.declineRequestError")+": "+(t.error instanceof Error?t.error.message:JSON.stringify(t.error))}):m.notify({type:"positive",message:c("friends.declineRequestSuccess")})},Ie=async e=>{const t=await H(e);t.error?m.notify({type:"negative",message:"Chyba při rušení požadavku: "+(t.error instanceof Error?t.error.message:JSON.stringify(t.error))}):m.notify({type:"positive",message:"Požadavek byl zrušen."})},re=async()=>{if(l.user)try{const e=await ke(l.user.id);e?.data&&(S.value=e.data)}catch(e){console.error("Error loading pending requests:",e),S.value=[]}},ie=async e=>{if(e){console.log("Loading user data for:",e.id);try{const t=p.value.length>0;console.log("Has existing data:",t),await Promise.all([Y(e.id,t),re()]),console.log("Data loaded successfully"),Z(e.id),X(e.id,s=>{S.value=s})}catch(t){console.error("Error loading user data:",t),L()}}};ue(async()=>{l.user&&p.value.length===0&&await ie(l.user),await A();for(const e of k.value)await a(e.id);setTimeout(()=>{b.value&&(console.warn("Loading timeout reached, forcing reset"),L())},1e4)}),N(()=>l.user,async(e,t)=>{e&&!t?await ie(e):e&&t&&e.id!==t.id&&(W(),await Y(e.id,!0),await re(),Z(e.id),X(e.id,s=>{S.value=s}))});const oe=()=>{!document.hidden&&l.user&&b.value&&L(l.user.id)};return ue(()=>{document.addEventListener("visibilitychange",oe)}),Pe(()=>{document.removeEventListener("visibilitychange",oe),W()}),(e,t)=>(r(),y(Ke,{class:"q-pa-md"},{default:i(()=>[d("div",yt,[d("div",ht,u(e.$t("friends.title")),1),d("div",_t,[$.value?(r(),y(h,{key:0,dense:"",flat:"",icon:"unfold_less",label:e.$t("common.collapseAll"),onClick:t[0]||(t[0]=s=>Ce())},null,8,["label"])):C("",!0),$.value?(r(),y(h,{key:1,dense:"",flat:"",icon:"unfold_more",label:e.$t("common.expandAll"),onClick:t[1]||(t[1]=s=>Qe())},null,8,["label"])):C("",!0),we.value?(r(),y(Ee,{key:2,modelValue:$.value,"onUpdate:modelValue":t[2]||(t[2]=s=>$.value=s),label:e.$t("friends.groupByGroups")},null,8,["modelValue","label"])):C("",!0),n(h,{color:"primary",icon:"person_add",label:e.$t("friends.addFriend"),onClick:t[3]||(t[3]=s=>F.value=!0)},null,8,["label"])])]),n(je,{modelValue:E.value,"onUpdate:modelValue":t[4]||(t[4]=s=>E.value=s),class:"text-primary q-mb-md"},{default:i(()=>[n(fe,{name:"friends",label:e.$t("friends.myFriends")},null,8,["label"]),n(fe,{name:"pending",label:e.$t("friends.requests")},null,8,["label"])]),_:1},8,["modelValue"]),n(Ne),n(ze,{modelValue:E.value,"onUpdate:modelValue":t[5]||(t[5]=s=>E.value=s),animated:""},{default:i(()=>[n(ve,{name:"friends"},{default:i(()=>[D(b)?(r(),o("div",bt,[n(ce,{size:"lg"})])):D(p).length===0?(r(),o("div",$t,[n(G,{name:"people",size:"4rem"}),d("div",kt,u(e.$t("friends.noFriends")),1),d("div",null,u(e.$t("friends.addFirstFriend")),1)])):(r(),o("div",qt,[$.value?(r(!0),o(w,{key:0},V(ee.value,s=>(r(),o("div",{key:s.id||"ungrouped",class:"q-mb-lg"},[d("div",{class:"row items-center justify-between q-mb-sm cursor-pointer",onClick:g=>te(s.id)},[d("div",Ct,u(s.name),1),n(h,{dense:"",flat:"",icon:f.value[s.id||"ungrouped"]?"expand_less":"expand_more",onClick:me(g=>te(s.id),["stop"])},null,8,["icon","onClick"])],8,wt),n(Ue,null,{default:i(()=>[Oe(d("div",Qt,[(r(!0),o(w,null,V(s.items,g=>(r(),y(ge,{key:g.id,friend:g,"friendship-id":ae(g.id)},null,8,["friend","friendship-id"]))),128))],512),[[Ge,f.value[s.id||"ungrouped"]]])]),_:2},1024)]))),128)):(r(),o("div",St,[(r(!0),o(w,null,V(D(p),s=>(r(),y(ge,{key:s.id,friend:s,"friendship-id":ae(s.id)},null,8,["friend","friendship-id"]))),128))]))]))]),_:1}),n(ve,{name:"pending"},{default:i(()=>[D(b)?(r(),o("div",At,[n(ce,{size:"lg"})])):S.value.length===0?(r(),o("div",Ft,[n(G,{name:"inbox",size:"4rem"}),d("div",Rt,u(e.$t("friends.noRequests")),1),d("div",null,u(e.$t("friends.noRequestsDescription")),1)])):(r(),o("div",It,[(r(!0),o(w,null,V(S.value,s=>(r(),y(gt,{key:s.id,request:s,onAccept:Fe,onDecline:Re,onCancel:Ie},null,8,["request"]))),128))]))]),_:1})]),_:1},8,["modelValue"]),n(Le,{modelValue:F.value,"onUpdate:modelValue":t[8]||(t[8]=s=>F.value=s),onHide:se},{default:i(()=>[n(M,{style:{width:"100%","max-width":"500px"}},{default:i(()=>[n(T,null,{default:i(()=>[d("div",Dt,u(e.$t("friends.addFriend")),1)]),_:1}),n(T,null,{default:i(()=>[n(Te,{modelValue:Q.value,"onUpdate:modelValue":t[6]||(t[6]=s=>Q.value=s),label:e.$t("friends.searchUsers"),outlined:"",placeholder:e.$t("friends.searchPlaceholder"),onInput:j,onKeyup:Be(j,["enter"])},{prepend:i(()=>[n(G,{name:"search"})]),append:i(()=>[n(h,{flat:"",round:"",icon:"search",onClick:j,disabled:Q.value.length<2},null,8,["disabled"])]),_:1},8,["modelValue","label","placeholder"]),R.value.length>0?(r(),o("div",Vt,[d("div",xt,u(e.$t("friends.searchResults"))+":",1),n(Me,null,{default:i(()=>[(r(!0),o(w,null,V(R.value,s=>(r(),y(Je,{key:s.id,clickable:"",onClick:g=>ne(s.id)},{default:i(()=>[n(U,{avatar:""},{default:i(()=>[n(K,{color:"primary","text-color":"white"},{default:i(()=>[O(u(Ae(s)),1)]),_:2},1024)]),_:2},1024),n(U,null,{default:i(()=>[n(pe,null,{default:i(()=>[O(u(Se(s)),1)]),_:2},1024),n(pe,{caption:""},{default:i(()=>[O(u(s.username||(s.id===D(l).profile?.id?s.email:"")),1)]),_:2},1024)]),_:2},1024),n(U,{side:""},{default:i(()=>[n(h,{color:"primary",flat:"",round:"",icon:"person_add",onClick:me(g=>ne(s.id),["stop"])},null,8,["onClick"])]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})])):C("",!0)]),_:1}),n(he,{align:"right"},{default:i(()=>[n(h,{label:e.$t("common.cancel"),color:"grey",flat:"",onClick:t[7]||(t[7]=s=>F.value=!1)},null,8,["label"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});export{es as default};
