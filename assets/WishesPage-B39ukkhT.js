import{a as Ce,u as Ue,C as $,r as b,w as x,b as xe,x as Ie,aE as Te,am as Ne,y as Be,h as W,o,g as m,e as u,f as a,t as g,p as L,m as le,q as R,A as H,z as M,F as I,D as K,Q as De,l as re,ax as Oe,n as X,aF as Pe,k as ze}from"./index-BR5I7U9B.js";import{a as oe,Q as Ge}from"./QTabs-ko1bx41e.js";import{a as ue,Q as Je}from"./QTabPanels-nLdV6WAV.js";import{Q as Y}from"./QSelect-CC7M6R9u.js";import{Q as je}from"./QForm-DzuwJCeg.js";import{Q as Le}from"./QPage-BhHXWAMh.js";import{u as He}from"./useWishes-B7vuTOXU.js";import{u as Me}from"./auth-store-CLpI6O-q.js";import{supabase as ne}from"./supabase-C7Q3J7Aw.js";import{W as Z}from"./WishCard-BnhkT9mE.js";import{u as Ke}from"./useGroups-BniwYyCy.js";import"./QResizeObserver-DZc6HSOo.js";import"./rtl-DFPa-2ov.js";import"./touch-BjYP5sR0.js";import"./selection-CVaP_A9r.js";import"./QItem-C5GHLq0T.js";import"./format-SQJMwOX7.js";import"./position-engine-ClI9_kBB.js";import"./QSlideTransition-BeC8BwHB.js";import"./QBadge-DErxSnF2.js";const Xe={class:"row justify-between items-center q-mb-md"},Ye={class:"text-h4"},Ze={key:0,class:"flex justify-center"},es={key:1,class:"text-center text-grey-6 q-py-lg"},ss={class:"text-h6 q-mt-md"},is={key:2,class:"masonry"},as=["data-wish-id"],ts={key:0,class:"flex justify-center"},ls={key:1,class:"text-center text-grey-6 q-py-lg"},rs={class:"text-h6 q-mt-md"},os={key:2,class:"masonry"},us={key:0,class:"flex justify-center"},ns={key:1,class:"text-center text-grey-6 q-py-lg"},ds={class:"text-h6 q-mt-md"},vs={key:2,class:"masonry"},cs=["data-wish-id"],ms={class:"text-h6"},fs={key:0},hs={class:"text-subtitle2"},ps={class:"text-caption text-grey-7 q-mb-sm"},gs={class:"row justify-end q-gutter-sm"},Bs=Ce({__name:"WishesPage",setup(ys){const _=ze(),{t:n}=Ue(),S=Te(),t=Me(),V=$(()=>S.params.userId),v=$(()=>!!V.value),{isLoading:T,createWish:de,fetchWishes:ve,fetchAllWishesForUser:ce,fetchReceivedWishes:me,refreshWishes:N,refreshAllWishesForUser:B,refreshReceivedWishes:D,updateWish:fe,deleteWish:he,toggleBought:pe,toggleReceived:ge}=He(),f=b([]),y=b([]),A=$(()=>v.value?y.value:f.value);let k=null;const O=b("my-wishes"),q=b(!1),E=b(null),h=b([]),Q=b(""),F=b({}),ye=$(()=>S.query.highlight||null),C=$(()=>S.query.expand?ye.value:null);x(()=>[A.value.length,C.value],()=>{C.value&&requestAnimationFrame(()=>{const e=document.querySelector(`[data-wish-id="${C.value}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"center"})})},{flush:"post"});const r=xe({name:"",description:"",url:"",visibility:"friends"}),{groups:ee,fetchGroups:we,setWishRules:se,fetchWishRules:be}=Ke(),p=b([]),w=b([]),We=$(()=>(ee.value||[]).filter(e=>!w.value.includes(e.id)).map(e=>({label:e.name,value:e.id}))),_e=$(()=>(ee.value||[]).filter(e=>!p.value.includes(e.id)).map(e=>({label:e.name,value:e.id}))),Ve=$(()=>[{label:n("wishes.form.visibilityPublic"),value:"public"},{label:n("wishes.form.visibilityFriends"),value:"friends"},{label:n("wishes.form.visibilityFriendsGroups"),value:"friends-groups"},{label:n("wishes.form.visibilityPrivate"),value:"private"}]),ie=()=>{r.name="",r.description="",r.url="",r.visibility="friends",p.value=[],w.value=[],E.value=null},$e=async()=>{if(!t.user)return;const e=v.value?V.value:t.user.id;if(!e)return;const s=r.visibility==="friends-groups"?"friends":r.visibility,i={name:r.name,...r.description&&{description:r.description},...r.url&&{url:r.url},visibility:s,created_for_user_id:e,created_by_user_id:t.user.id};let l;if(E.value?l=await fe(E.value,i):l=await de(i),l.error)_.notify({type:"negative",message:n("wishes.saveError")+": "+(l.error instanceof Error?l.error.message:JSON.stringify(l.error))});else{const d=l&&"data"in l&&l.data?.id||void 0;if(d){if(r.visibility==="friends-groups"){const c=Array.from(new Set(p.value)),Fe=Array.from(new Set(w.value)).filter(Ae=>!c.includes(Ae)),J=await se(d,c,Fe);if(J.error){_.notify({type:"negative",message:n("wishes.saveError")+": "+(J.error instanceof Error?J.error.message:JSON.stringify(J.error))});return}F.value[d]=(F.value[d]||0)+1}else if(s==="friends"){const c=await se(d,[],[]);if(c.error){_.notify({type:"negative",message:n("wishes.saveError")+": "+(c.error instanceof Error?c.error.message:JSON.stringify(c.error))});return}F.value[d]=(F.value[d]||0)+1}}if(_.notify({type:"positive",message:E.value?n("wishes.updateSuccess"):n("wishes.createSuccess")}),q.value=!1,ie(),v.value){const c=await B(V.value,!0);c?.data&&(y.value=c.data)}else{const c=await N(t.user.id);c?.data&&(f.value=c.data)}}},Se=e=>{r.name=e.name,r.description=e.description||"",r.url=e.url||"",r.visibility=e.visibility,E.value=e.id,(async()=>{const s=await be(e.id);if(!s.error&&s.data){p.value=s.data.filter(l=>l.rule_type==="include").map(l=>l.group_id);const i=s.data.filter(l=>l.rule_type==="exclude").map(l=>l.group_id);w.value=i.filter(l=>!p.value.includes(l)),e.visibility==="friends"&&(p.value.length||w.value.length)&&(r.visibility="friends-groups")}q.value=!0})()},Re=async e=>{const s=await he(e);s.error?_.notify({type:"negative",message:n("wishes.deleteError")+": "+(s.error instanceof Error?s.error.message:JSON.stringify(s.error))}):_.notify({type:"positive",message:n("wishes.deleteSuccess")})},ae=async e=>{if(!t.user)return;const s=await pe(e,t.user.id);if(s.error)_.notify({type:"negative",message:n("wishes.toggleBoughtError")+": "+(s.error instanceof Error?s.error.message:JSON.stringify(s.error))});else if(v.value){const i=await B(V.value);i?.data&&(y.value=i.data)}else{const i=await N(t.user.id);i?.data&&(f.value=i.data);const l=await D(t.user.id);l?.data&&(h.value=l.data)}},j=async e=>{if(!t.user)return;const s=await ge(e,t.user.id);if(s.error)_.notify({type:"negative",message:n("wishes.toggleReceivedError")+": "+(typeof s.error=="string"?s.error:JSON.stringify(s.error))});else{if(v.value){const i=await B(V.value);i?.data&&(y.value=i.data)}else{const i=await N(t.user.id);i?.data&&(f.value=i.data);const l=await D(t.user.id);l?.data&&(h.value=l.data)}_.notify({type:"positive",message:n("wishes.toggleReceivedSuccess")})}};let U=null;const ke=async()=>{!document.hidden&&t.user&&(await P(S.params.userId),z())};Ie(async()=>{t.user&&(await P(S.params.userId),z()),await we(),U=()=>{ke().catch(()=>{})},document.addEventListener("visibilitychange",U)}),Ne(()=>{U&&(document.removeEventListener("visibilitychange",U),U=null),te()});const qe=async()=>{if(!t.user)return;const e=await me(t.user.id);e?.data&&(h.value=e.data)},Ee=async e=>{try{const{data:s,error:i}=await ne.from("profiles_public").select("name, username").eq("id",e).single();if(i)throw i;Q.value=(s?.name||s?.username)??n("common.unknown")}catch{Q.value=n("common.unknown")}},P=async e=>{if(t.user)if(e){f.value=[],y.value=[],h.value=[],Q.value="",await Ee(e);const s=await ce(e,!0);s?.data&&(y.value=s.data)}else{const s=f.value.length>0;f.value=[],y.value=[],h.value=[],Q.value="";const i=await ve(t.user.id,s,"active");i?.data&&(f.value=i.data),await qe()}};x(p,e=>{e?.length&&(w.value=w.value.filter(s=>!e.includes(s)))}),x(w,e=>{e?.length&&(p.value=p.value.filter(s=>!e.includes(s)))}),x(()=>S.params.userId,async(e,s)=>{e!==s&&(Q.value="",await P(e),z())},{immediate:!0}),x(()=>t.user?.id,async e=>{e?(await P(S.params.userId),z()):te()});const z=()=>{t.user&&(k&&k.unsubscribe(),k=ne.channel("wishes_changes").on("postgres_changes",{event:"*",schema:"public",table:"wishes"},e=>{Qe(e)}).subscribe())},Qe=async e=>{if(!t.user)return;const{eventType:s,new:i,old:l}=e;if(s==="INSERT"&&i)v.value&&i.created_for_user_id===V.value?await G():!v.value&&i.created_for_user_id===t.user.id&&await G();else if(s==="UPDATE"&&i)if(!v.value&&i.created_for_user_id===t.user.id){await G();const d=await D(t.user.id);d?.data&&(h.value=d.data)}else v.value&&i.created_for_user_id===V.value&&await G();else s==="DELETE"&&l&&(v.value?y.value=y.value.filter(d=>d.id!==l.id):(f.value=f.value.filter(d=>d.id!==l.id),h.value=h.value.filter(d=>d.id!==l.id)))},G=async()=>{if(t.user)if(v.value){const e=await B(V.value,!0);e?.data&&(y.value=e.data)}else{const e=await N(t.user.id);e?.data&&(f.value=e.data);const s=await D(t.user.id);s?.data&&(h.value=s.data)}},te=()=>{k&&(k.unsubscribe(),k=null)};return(e,s)=>(o(),Be(Le,{class:"q-pa-md"},{default:W(()=>[m("div",Xe,[m("div",Ye,g(v.value?`${Q.value}'s ${e.$t("wishes.wishes")}`:e.$t("wishes.title")),1),a(L,{color:"primary",icon:"add",label:v.value?e.$t("wishes.addForFriend"):e.$t("wishes.add"),onClick:s[0]||(s[0]=i=>q.value=!0)},null,8,["label"])]),v.value?(o(),u(I,{key:1},[R(T)?(o(),u("div",us,[a(H,{size:"lg"})])):A.value.length===0?(o(),u("div",ns,[a(M,{name:"card_giftcard",size:"4rem"}),m("div",ds,g(e.$t("wishes.noWishes")),1),m("div",null,g(e.$t("wishes.friendHasNoWishes")),1)])):(o(),u("div",vs,[(o(!0),u(I,null,K(A.value,i=>(o(),u("div",{key:i.id,class:"masonry-item","data-wish-id":i.id},[a(Z,{wish:i,"current-user-id":R(t).user?.id,"refresh-key":F.value[i.id]||0,expanded:C.value===i.id,onToggleBought:ae,onToggleReceived:j},null,8,["wish","current-user-id","refresh-key","expanded"])],8,cs))),128))]))],64)):(o(),u(I,{key:0},[a(Ge,{modelValue:O.value,"onUpdate:modelValue":s[1]||(s[1]=i=>O.value=i),class:"text-primary q-mb-md"},{default:W(()=>[a(oe,{name:"my-wishes",label:e.$t("wishes.myWishes")},null,8,["label"]),a(oe,{name:"archive",label:e.$t("wishes.archive")},null,8,["label"])]),_:1},8,["modelValue"]),a(le),a(Je,{modelValue:O.value,"onUpdate:modelValue":s[2]||(s[2]=i=>O.value=i),animated:""},{default:W(()=>[a(ue,{name:"my-wishes"},{default:W(()=>[R(T)?(o(),u("div",Ze,[a(H,{size:"lg"})])):A.value.length===0?(o(),u("div",es,[a(M,{name:"card_giftcard",size:"4rem"}),m("div",ss,g(e.$t("wishes.noWishes")),1),m("div",null,g(e.$t("wishes.addFirstWish")),1)])):(o(),u("div",is,[(o(!0),u(I,null,K(A.value,i=>(o(),u("div",{key:i.id,class:"masonry-item","data-wish-id":i.id},[a(Z,{wish:i,"current-user-id":R(t).user?.id,"refresh-key":F.value[i.id]||0,expanded:C.value===i.id,onEdit:Se,onDelete:Re,onToggleBought:ae,onToggleReceived:j},null,8,["wish","current-user-id","refresh-key","expanded"])],8,as))),128))]))]),_:1}),a(ue,{name:"archive"},{default:W(()=>[R(T)?(o(),u("div",ts,[a(H,{size:"lg"})])):h.value.length===0?(o(),u("div",ls,[a(M,{name:"archive",size:"4rem"}),m("div",rs,g(e.$t("wishes.noArchivedWishes")),1),m("div",null,g(e.$t("wishes.noArchivedWishesDesc")),1)])):(o(),u("div",os,[(o(!0),u(I,null,K(h.value,i=>(o(),u("div",{key:i.id,class:"masonry-item"},[a(Z,{wish:i,"current-user-id":R(t).user?.id,onToggleReceived:j},null,8,["wish","current-user-id"])]))),128))]))]),_:1})]),_:1},8,["modelValue"])],64)),a(Pe,{modelValue:q.value,"onUpdate:modelValue":s[10]||(s[10]=i=>q.value=i),onHide:ie},{default:W(()=>[a(De,{style:{width:"100%","max-width":"500px"}},{default:W(()=>[a(re,null,{default:W(()=>[m("div",ms,g(E.value?e.$t("wishes.editWish"):e.$t("wishes.addWish")),1)]),_:1}),a(re,null,{default:W(()=>[a(je,{onSubmit:$e,class:"q-gutter-md"},{default:W(()=>[a(X,{modelValue:r.name,"onUpdate:modelValue":s[3]||(s[3]=i=>r.name=i),label:e.$t("wishes.form.name"),outlined:"",rules:[i=>!!i||e.$t("wishes.form.nameRequired")]},null,8,["modelValue","label","rules"]),a(X,{modelValue:r.description,"onUpdate:modelValue":s[4]||(s[4]=i=>r.description=i),label:e.$t("wishes.form.description"),type:"textarea",outlined:"",rows:"3"},null,8,["modelValue","label"]),a(X,{modelValue:r.url,"onUpdate:modelValue":s[5]||(s[5]=i=>r.url=i),label:e.$t("wishes.form.url"),outlined:"",type:"url"},null,8,["modelValue","label"]),a(Y,{modelValue:r.visibility,"onUpdate:modelValue":s[6]||(s[6]=i=>r.visibility=i),label:e.$t("wishes.form.visibility"),outlined:"",options:Ve.value,"option-value":"value","option-label":"label","emit-value":"","map-options":""},null,8,["modelValue","label","options"]),r.visibility==="friends-groups"?(o(),u("div",fs,[a(le,{class:"q-my-sm"}),m("div",hs,g(e.$t("wishes.form.groupSharing.title")),1),m("div",ps,g(e.$t("wishes.form.groupSharing.hint1"))+" "+g(e.$t("wishes.form.groupSharing.hint2")),1),a(Y,{modelValue:p.value,"onUpdate:modelValue":s[7]||(s[7]=i=>p.value=i),options:We.value,label:e.$t("wishes.form.groupSharing.include"),outlined:"",multiple:"",clearable:"","use-chips":"","emit-value":"","map-options":""},null,8,["modelValue","options","label"]),a(Y,{modelValue:w.value,"onUpdate:modelValue":s[8]||(s[8]=i=>w.value=i),options:_e.value,label:e.$t("wishes.form.groupSharing.exclude"),outlined:"",multiple:"",clearable:"","use-chips":"","emit-value":"","map-options":"",class:"q-mt-sm"},null,8,["modelValue","options","label"])])):Oe("",!0),m("div",gs,[a(L,{label:e.$t("common.cancel"),color:"grey",flat:"",onClick:s[9]||(s[9]=i=>q.value=!1)},null,8,["label"]),a(L,{type:"submit",label:e.$t("common.save"),color:"primary",loading:R(T)},null,8,["label","loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});export{Bs as default};
