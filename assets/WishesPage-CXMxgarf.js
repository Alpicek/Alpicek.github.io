import{a as pe,z as I,r as b,b as ye,n as ge,aC as we,af as be,w as G,p as We,f,o as r,h,c as o,e as t,t as g,k as P,i as _e,l as W,s as z,q as j,au as S,av as L,Q as $e,g as K,j as O,aD as Re}from"./index-BC9OHaAo.js";import{a as X,Q as Ve}from"./QTabs-D4YXjPe5.js";import{a as Y,Q as ke}from"./QTabPanels-B24k5Kt8.js";import{Q as Qe}from"./QSelect-v-pYG3VZ.js";import{Q as Se}from"./QForm-ONgK5Qau.js";import{Q as Ee}from"./QPage-CR9ZqGyQ.js";import{u as qe}from"./useWishes-DnguVspT.js";import{u as Ce}from"./auth-store-GnHU88NU.js";import{u as Fe}from"./use-quasar-B2AUPOIt.js";import{supabase as Z}from"./supabase-NAtW2SFJ.js";import{W as J}from"./WishCard-D3fw3Ig1.js";import{u as Ue}from"./vue-i18n.runtime-QMuF0HHA.js";import"./QResizeObserver-BKF_HjRr.js";import"./rtl-DFPa-2ov.js";import"./touch-BjYP5sR0.js";import"./selection-DiPhUAXX.js";import"./QItem-DwlaYYkU.js";import"./format-CK_T9Xac.js";import"./position-engine-JKk1Ow-u.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Te={class:"row justify-between items-center q-mb-md"},Ae={class:"text-h4"},Be={key:0,class:"flex justify-center"},De={key:1,class:"text-center text-grey-6 q-py-lg"},Ne={class:"text-h6 q-mt-md"},Ie={key:2,class:"masonry"},Pe={key:0,class:"flex justify-center"},ze={key:1,class:"text-center text-grey-6 q-py-lg"},je={class:"text-h6 q-mt-md"},Le={key:2,class:"masonry"},Oe={key:0,class:"flex justify-center"},Je={key:1,class:"text-center text-grey-6 q-py-lg"},He={class:"text-h6 q-mt-md"},xe={key:2,class:"masonry"},Me={class:"text-h6"},Ge={class:"row justify-end q-gutter-sm"},ys=pe({__name:"WishesPage",setup(Ke){const w=Fe(),{t:d}=Ue(),k=we(),i=Ce(),p=I(()=>k.params.userId),u=I(()=>!!p.value),{isLoading:E,createWish:ee,fetchWishes:se,fetchAllWishesForUser:ae,fetchReceivedWishes:ie,refreshWishes:q,refreshAllWishesForUser:C,refreshReceivedWishes:F,updateWish:te,deleteWish:le,toggleBought:re,toggleReceived:oe}=qe(),c=b([]),m=b([]),U=I(()=>u.value?m.value:c.value);let _=null;const T=b("my-wishes"),$=b(!1),R=b(null),v=b([]),V=b(""),l=ye({name:"",description:"",url:"",visibility:"friends"}),ne=[{label:d("wishes.form.visibilityPublic"),value:"public"},{label:d("wishes.form.visibilityFriends"),value:"friends"},{label:d("wishes.form.visibilityPrivate"),value:"private"}],H=()=>{l.name="",l.description="",l.url="",l.visibility="friends",R.value=null},ue=async()=>{if(!i.user)return;const e=u.value?p.value:i.user.id;if(!e)return;const a={name:l.name,...l.description&&{description:l.description},...l.url&&{url:l.url},visibility:l.visibility,created_for_user_id:e,created_by_user_id:i.user.id};let s;if(R.value?s=await te(R.value,a):s=await ee(a),s.error)w.notify({type:"negative",message:d("wishes.saveError")+": "+(s.error instanceof Error?s.error.message:JSON.stringify(s.error))});else if(w.notify({type:"positive",message:R.value?d("wishes.updateSuccess"):d("wishes.createSuccess")}),$.value=!1,H(),u.value){const n=await C(p.value,!0);n?.data&&(m.value=n.data)}else{const n=await q(i.user.id);n?.data&&(c.value=n.data)}},de=e=>{l.name=e.name,l.description=e.description||"",l.url=e.url||"",l.visibility=e.visibility,R.value=e.id,$.value=!0},ce=async e=>{const a=await le(e);a.error?w.notify({type:"negative",message:d("wishes.deleteError")+": "+(a.error instanceof Error?a.error.message:JSON.stringify(a.error))}):w.notify({type:"positive",message:d("wishes.deleteSuccess")})},x=async e=>{if(!i.user)return;const a=await re(e,i.user.id);if(a.error)w.notify({type:"negative",message:d("wishes.toggleBoughtError")+": "+(a.error instanceof Error?a.error.message:JSON.stringify(a.error))});else if(u.value){const s=await C(p.value);s?.data&&(m.value=s.data)}else{const s=await q(i.user.id);s?.data&&(c.value=s.data);const n=await F(i.user.id);n?.data&&(v.value=n.data)}},N=async e=>{if(!i.user)return;const a=await oe(e,i.user.id);if(a.error)w.notify({type:"negative",message:d("wishes.toggleReceivedError")+": "+(typeof a.error=="string"?a.error:JSON.stringify(a.error))});else{if(u.value){const s=await C(p.value);s?.data&&(m.value=s.data)}else{const s=await q(i.user.id);s?.data&&(c.value=s.data);const n=await F(i.user.id);n?.data&&(v.value=n.data)}w.notify({type:"positive",message:d("wishes.toggleReceivedSuccess")})}};let Q=null;const ve=async()=>{!document.hidden&&i.user&&(await A(k.params.userId),B())};ge(async()=>{i.user&&(await A(k.params.userId),B()),Q=()=>{ve().catch(()=>{})},document.addEventListener("visibilitychange",Q)}),be(()=>{Q&&(document.removeEventListener("visibilitychange",Q),Q=null),M()});const me=async()=>{if(!i.user)return;const e=await ie(i.user.id);e?.data&&(v.value=e.data)},fe=async e=>{try{const{data:a,error:s}=await Z.from("profiles").select("name, username").eq("id",e).single();if(s)throw s;V.value=a.name||a.username||"Unknown"}catch{V.value="Unknown"}},A=async e=>{if(i.user)if(e){c.value=[],m.value=[],v.value=[],V.value="",await fe(e);const a=await ae(e,!0);a?.data&&(m.value=a.data)}else{const a=c.value.length>0;c.value=[],m.value=[],v.value=[],V.value="";const s=await se(i.user.id,a,"active");s?.data&&(c.value=s.data),await me()}};G(()=>k.params.userId,async(e,a)=>{e!==a&&(V.value="",await A(e),B())},{immediate:!0}),G(()=>i.user?.id,async e=>{e?(await A(k.params.userId),B()):M()});const B=()=>{i.user&&(_&&_.unsubscribe(),_=Z.channel("wishes_changes").on("postgres_changes",{event:"*",schema:"public",table:"wishes"},e=>{he(e)}).subscribe())},he=async e=>{if(!i.user)return;const{eventType:a,new:s,old:n}=e;if(a==="INSERT"&&s)u.value&&s.created_for_user_id===p.value?await D():!u.value&&s.created_for_user_id===i.user.id&&await D();else if(a==="UPDATE"&&s)if(!u.value&&s.created_for_user_id===i.user.id){await D();const y=await F(i.user.id);y?.data&&(v.value=y.data)}else u.value&&s.created_for_user_id===p.value&&await D();else a==="DELETE"&&n&&(u.value?m.value=m.value.filter(y=>y.id!==n.id):(c.value=c.value.filter(y=>y.id!==n.id),v.value=v.value.filter(y=>y.id!==n.id)))},D=async()=>{if(i.user)if(u.value){const e=await C(p.value,!0);e?.data&&(m.value=e.data)}else{const e=await q(i.user.id);e?.data&&(c.value=e.data);const a=await F(i.user.id);a?.data&&(v.value=a.data)}},M=()=>{_&&(_.unsubscribe(),_=null)};return(e,a)=>(r(),We(Ee,{class:"q-pa-md"},{default:f(()=>[h("div",Te,[h("div",Ae,g(u.value?`${V.value}'s ${e.$t("wishes.wishes")}`:e.$t("wishes.title")),1),t(P,{color:"primary",icon:"add",label:u.value?e.$t("wishes.addForFriend"):e.$t("wishes.add"),onClick:a[0]||(a[0]=s=>$.value=!0)},null,8,["label"])]),u.value?(r(),o(S,{key:1},[W(E)?(r(),o("div",Oe,[t(z,{size:"lg"})])):U.value.length===0?(r(),o("div",Je,[t(j,{name:"card_giftcard",size:"4rem"}),h("div",He,g(e.$t("wishes.noWishes")),1),h("div",null,g(e.$t("wishes.friendHasNoWishes")),1)])):(r(),o("div",xe,[(r(!0),o(S,null,L(U.value,s=>(r(),o("div",{key:s.id,class:"masonry-item"},[t(J,{wish:s,"current-user-id":W(i).user?.id,onToggleBought:x,onToggleReceived:N},null,8,["wish","current-user-id"])]))),128))]))],64)):(r(),o(S,{key:0},[t(Ve,{modelValue:T.value,"onUpdate:modelValue":a[1]||(a[1]=s=>T.value=s),class:"text-primary q-mb-md"},{default:f(()=>[t(X,{name:"my-wishes",label:e.$t("wishes.myWishes")},null,8,["label"]),t(X,{name:"archive",label:e.$t("wishes.archive")},null,8,["label"])]),_:1},8,["modelValue"]),t(_e),t(ke,{modelValue:T.value,"onUpdate:modelValue":a[2]||(a[2]=s=>T.value=s),animated:""},{default:f(()=>[t(Y,{name:"my-wishes"},{default:f(()=>[W(E)?(r(),o("div",Be,[t(z,{size:"lg"})])):U.value.length===0?(r(),o("div",De,[t(j,{name:"card_giftcard",size:"4rem"}),h("div",Ne,g(e.$t("wishes.noWishes")),1),h("div",null,g(e.$t("wishes.addFirstWish")),1)])):(r(),o("div",Ie,[(r(!0),o(S,null,L(U.value,s=>(r(),o("div",{key:s.id,class:"masonry-item"},[t(J,{wish:s,"current-user-id":W(i).user?.id,onEdit:de,onDelete:ce,onToggleBought:x,onToggleReceived:N},null,8,["wish","current-user-id"])]))),128))]))]),_:1}),t(Y,{name:"archive"},{default:f(()=>[W(E)?(r(),o("div",Pe,[t(z,{size:"lg"})])):v.value.length===0?(r(),o("div",ze,[t(j,{name:"archive",size:"4rem"}),h("div",je,g(e.$t("wishes.noArchivedWishes")),1),h("div",null,g(e.$t("wishes.noArchivedWishesDesc")),1)])):(r(),o("div",Le,[(r(!0),o(S,null,L(v.value,s=>(r(),o("div",{key:s.id,class:"masonry-item"},[t(J,{wish:s,"current-user-id":W(i).user?.id,onToggleReceived:N},null,8,["wish","current-user-id"])]))),128))]))]),_:1})]),_:1},8,["modelValue"])],64)),t(Re,{modelValue:$.value,"onUpdate:modelValue":a[8]||(a[8]=s=>$.value=s),onHide:H},{default:f(()=>[t($e,{style:{width:"100%","max-width":"500px"}},{default:f(()=>[t(K,null,{default:f(()=>[h("div",Me,g(R.value?e.$t("wishes.editWish"):e.$t("wishes.addWish")),1)]),_:1}),t(K,null,{default:f(()=>[t(Se,{onSubmit:ue,class:"q-gutter-md"},{default:f(()=>[t(O,{modelValue:l.name,"onUpdate:modelValue":a[3]||(a[3]=s=>l.name=s),label:e.$t("wishes.form.name"),outlined:"",rules:[s=>!!s||e.$t("wishes.form.nameRequired")]},null,8,["modelValue","label","rules"]),t(O,{modelValue:l.description,"onUpdate:modelValue":a[4]||(a[4]=s=>l.description=s),label:e.$t("wishes.form.description"),type:"textarea",outlined:"",rows:"3"},null,8,["modelValue","label"]),t(O,{modelValue:l.url,"onUpdate:modelValue":a[5]||(a[5]=s=>l.url=s),label:e.$t("wishes.form.url"),outlined:"",type:"url"},null,8,["modelValue","label"]),t(Qe,{modelValue:l.visibility,"onUpdate:modelValue":a[6]||(a[6]=s=>l.visibility=s),label:e.$t("wishes.form.visibility"),outlined:"",options:ne,"option-value":"value","option-label":"label","emit-value":"","map-options":""},null,8,["modelValue","label"]),h("div",Ge,[t(P,{label:e.$t("common.cancel"),color:"grey",flat:"",onClick:a[7]||(a[7]=s=>$.value=!1)},null,8,["label"]),t(P,{type:"submit",label:e.$t("common.save"),color:"primary",loading:W(E)},null,8,["label","loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});export{ys as default};
