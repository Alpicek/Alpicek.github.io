import{a as J,s as y,o as r,Q as M,g as o,e as n,i as T,f as u,au as K,c as l,t as c,at as C,u as xe,z,p as O,v as G,av as he,F as w,l as h,r as q,w as N,q as ue,O as Pe,aB as Ee,j as Ne,m as D,x as ce,A as V,aC as me,a7 as Oe,aD as Ge,k as Te,aE as Be,aA as Le}from"./index-DVxg6bki.js";import{a as fe,Q as Ue}from"./QTabs-D4GgAfr5.js";import{Q as je}from"./QSlideTransition-Be_hDsgh.js";import{a as ve,Q as ze}from"./QTabPanels-3d4LrFWD.js";import{Q as Je,a as j,b as pe}from"./QItem-DY0UlQtF.js";import{Q as Me}from"./QList-CRrwJVbJ.js";import{Q as Ke}from"./QPage-CumIRxSU.js";import{u as He}from"./use-quasar-CkVI-nkJ.js";import{u as Ye}from"./auth-store-B2tf6G-o.js";import{u as Ze}from"./useFriends-EdgvCd0R.js";import{Q as Xe}from"./QBadge-THsguSLK.js";import{_ as _e}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{u as We}from"./useGroups-Ba6bv9j6.js";import{u as et}from"./vue-i18n.runtime-B8ut2y-E.js";import"./QResizeObserver-CETaZbW6.js";import"./rtl-DFPa-2ov.js";import"./touch-BjYP5sR0.js";import"./selection-Bdn4QBjC.js";import"./supabase-DHOxICEL.js";const tt={class:"row items-center q-gutter-md"},st=["src"],at={key:1},nt={class:"friend-info flex-1"},rt={class:"row items-center q-gutter-sm"},it={class:"text-h6 friend-name"},ot={key:0,class:"text-subtitle2 text-grey-6"},lt=J({__name:"FriendCard",props:{friend:{},friendshipId:{}},setup(P){const f=P,m=xe(),d=()=>{m.push(`/app/friend/${f.friend.id}`)},k=s=>s.name&&s.surname?`${s.name} ${s.surname}`:s.username||s.email,A=s=>s.name&&s.surname?`${s.name.charAt(0)}${s.surname.charAt(0)}`:s.username?s.username.charAt(0).toUpperCase():s.email.charAt(0).toUpperCase();return(s,p)=>(r(),y(M,{class:"friend-card",onClick:d},{default:o(()=>[n(T,{class:"friend-card-content"},{default:o(()=>[u("div",tt,[n(K,{size:"50px",color:"primary","text-color":"white"},{default:o(()=>[s.friend.avatar_url?(r(),l("img",{key:0,src:s.friend.avatar_url},null,8,st)):(r(),l("span",at,c(A(s.friend)),1))]),_:1}),u("div",nt,[u("div",rt,[u("div",it,c(k(s.friend)),1),s.friend.is_dummy?(r(),y(Xe,{key:0,color:"orange",label:s.$t("dummyProfiles.dummy"),rounded:""},null,8,["label"])):C("",!0)]),s.friend.username?(r(),l("div",ot," @"+c(s.friend.username),1)):C("",!0)])])]),_:1})]),_:1}))}}),ge=_e(lt,[["__scopeId","data-v-6bd1fc51"]]),dt=["src"],ut={key:1},ct={class:"text-h6 q-mt-md"},mt={key:0,class:"text-subtitle2 text-grey-6"},ft={class:"text-body2 text-grey-7 q-mt-sm"},vt={class:"text-caption text-grey-6 q-mt-xs"},pt=J({__name:"PendingRequestCard",props:{request:{}},emits:["accept","decline","cancel"],setup(P){const f=P,m=z(()=>f.request.type==="incoming"?f.request.user:f.request.friend),d=s=>s.name&&s.surname?`${s.name} ${s.surname}`:s.username||s.email,k=s=>s.name&&s.surname?`${s.name.charAt(0)}${s.surname.charAt(0)}`:s.username?s.username.charAt(0).toUpperCase():s.email.charAt(0).toUpperCase(),A=s=>{const p=new Date(s),B=Math.abs(new Date().getTime()-p.getTime()),b=Math.ceil(B/(1e3*60*60*24));return b===1?"Dnes":b===2?"Včera":b<7?`Před ${b} dny`:p.toLocaleDateString("cs-CZ")};return(s,p)=>(r(),y(M,{class:"pending-card",style:{width:"100%","max-width":"300px"}},{default:o(()=>[n(T,{class:"text-center"},{default:o(()=>[n(K,{size:"60px",color:"primary","text-color":"white"},{default:o(()=>[m.value.avatar_url?(r(),l("img",{key:0,src:m.value.avatar_url},null,8,dt)):(r(),l("span",ut,c(k(m.value)),1))]),_:1}),u("div",ct,c(d(m.value)),1),m.value.username?(r(),l("div",mt," @"+c(m.value.username),1)):C("",!0),u("div",ft,[n(G,{name:"schedule",size:"16px",class:"q-mr-xs"}),O(" "+c(s.request.created_at?A(s.request.created_at):"N/A"),1)]),u("div",vt,c(s.request.type==="incoming"?"Požadavek od uživatele":"Odeslaný požadavek"),1)]),_:1}),n(he,{align:"center"},{default:o(()=>[s.request.type==="incoming"?(r(),l(w,{key:0},[n(h,{color:"positive",flat:"",icon:"check",label:"Přijmout",onClick:p[0]||(p[0]=g=>s.$emit("accept",s.request.id))}),n(h,{color:"negative",flat:"",icon:"close",label:"Odmítnout",onClick:p[1]||(p[1]=g=>s.$emit("decline",s.request.id))})],64)):(r(),l(w,{key:1},[n(h,{color:"grey",flat:"",icon:"schedule",label:"Čeká na odpověď",disabled:""}),n(h,{color:"negative",flat:"",icon:"close",label:"Zrušit",onClick:p[2]||(p[2]=g=>s.$emit("cancel",s.request.id))})],64))]),_:1})]),_:1}))}}),gt=_e(pt,[["__scopeId","data-v-dba6884f"]]),yt={class:"row justify-between items-center q-mb-md"},ht={class:"text-h4"},_t={class:"row items-center q-gutter-sm"},bt={key:0,class:"flex justify-center"},$t={key:1,class:"text-center text-grey-6 q-py-lg"},kt={class:"text-h6 q-mt-md"},qt={key:2},wt=["onClick"],Ct={class:"text-subtitle1"},Qt={class:"row q-gutter-md"},St={key:1,class:"row q-gutter-md"},At={key:0,class:"flex justify-center"},Ft={key:1,class:"text-center text-grey-6 q-py-lg"},Rt={class:"text-h6 q-mt-md"},It={key:2,class:"row q-gutter-md"},Dt={class:"text-h6"},Vt={key:0,class:"q-mt-md"},xt={class:"text-subtitle2 q-mb-sm"},ye="friends.groupByGroups",x="friends.expandedGroups",es=J({__name:"FriendsPage",setup(P){const f=He(),{t:m}=et(),d=Ye(),{groups:k,fetchGroups:A,fetchGroupMembers:s,membersByGroup:p}=We(),{friends:g,friendships:B,isLoading:b,sendFriendRequest:be,acceptFriendRequest:$e,declineFriendRequest:H,fetchFriends:Y,fetchPendingRequests:ke,searchUsers:qe,resetLoadingState:L,subscribeToFriendships:Z,subscribeToPendingRequests:X,unsubscribeFromFriendships:W}=Ze(),E=q("friends"),F=q(!1),Q=q(""),R=q([]),S=q([]),$=q(localStorage.getItem(ye)==="1");N(()=>$.value,e=>localStorage.setItem(ye,e?"1":"0"));const ee=z(()=>{if(!$.value)return[];const e={};for(const _ of k.value){const I=p.value[_.id]||[],de=g.value.filter(De=>I.some(Ve=>Ve.user_id===De.id));de.length>0&&(e[_.id]={id:_.id,name:_.name,items:de})}const t=new Set(Object.values(e).flatMap(_=>_.items.map(I=>I.id))),a=g.value.filter(_=>!t.has(_.id)),le=[...Object.values(e).sort((_,I)=>_.name.localeCompare(I.name,void 0,{sensitivity:"base"}))];return a.length>0&&le.push({id:null,name:m("friends.other"),items:a}),le}),we=z(()=>k.value.length>0),v=q((()=>{try{const e=localStorage.getItem(x);return e?JSON.parse(e):{}}catch{return{}}})());N(()=>ee.value,e=>{if(!$.value)return;const t={...v.value};for(const a of e){const i=a.id||"ungrouped";i in t||(t[i]=!0)}v.value=t},{immediate:!0});const te=e=>{const t=e||"ungrouped";v.value[t]=!v.value[t],localStorage.setItem(x,JSON.stringify(v.value))},Ce=()=>{for(const e of Object.keys(v.value))v.value[e]=!1;localStorage.setItem(x,JSON.stringify(v.value))},Qe=()=>{for(const e of Object.keys(v.value))v.value[e]=!0;localStorage.setItem(x,JSON.stringify(v.value))};N(()=>v.value,e=>{try{localStorage.setItem(x,JSON.stringify(e))}catch{}},{deep:!0});const Se=e=>e.name&&e.surname?`${e.name} ${e.surname}`:e.username||e.email,Ae=e=>e.name&&e.surname?`${e.name.charAt(0)}${e.surname.charAt(0)}`:e.username?e.username.charAt(0).toUpperCase():e.email.charAt(0).toUpperCase(),se=()=>{Q.value="",R.value=[]},ae=e=>d.user&&B.value.find(a=>a.user_id===d.user.id&&a.friend_id===e||a.friend_id===d.user.id&&a.user_id===e)?.id||"",U=async()=>{if(Q.value.trim().length<2){R.value=[];return}const e=await qe(Q.value);if(e.data){const t=g.value.map(i=>i.id),a=e.data.map(i=>({avatar_url:i.avatar_url??null,birth_year_visible:i.birth_year_visible??null,created_at:i.created_at??null,date_of_birth:i.date_of_birth??null,email:i.email,id:i.id,is_admin:i.is_admin??null,is_dummy:i.is_dummy??null,name:i.name??null,surname:i.surname??null,updated_at:i.updated_at??null,username:i.username??null}));R.value=a.filter(i=>i.id!==d.user?.id&&!t.includes(i.id))}},ne=async e=>{if(!d.user)return;const t=await be(e,d.user.id);t.error?f.notify({type:"negative",message:m("friends.sendRequestError")+": "+(t.error instanceof Error?t.error.message:JSON.stringify(t.error))}):(f.notify({type:"positive",message:m("friends.sendRequestSuccess")}),F.value=!1,se())},Fe=async e=>{if(!d.user)return;const t=await $e(e,d.user.id);t.error?f.notify({type:"negative",message:m("friends.acceptRequestError")+": "+(t.error instanceof Error?t.error.message:JSON.stringify(t.error))}):f.notify({type:"positive",message:m("friends.acceptRequestSuccess")})},Re=async e=>{const t=await H(e);t.error?f.notify({type:"negative",message:m("friends.declineRequestError")+": "+(t.error instanceof Error?t.error.message:JSON.stringify(t.error))}):f.notify({type:"positive",message:m("friends.declineRequestSuccess")})},Ie=async e=>{const t=await H(e);t.error?f.notify({type:"negative",message:"Chyba při rušení požadavku: "+(t.error instanceof Error?t.error.message:JSON.stringify(t.error))}):f.notify({type:"positive",message:"Požadavek byl zrušen."})},re=async()=>{if(d.user)try{const e=await ke(d.user.id);e?.data&&(S.value=e.data)}catch(e){console.error("Error loading pending requests:",e),S.value=[]}},ie=async e=>{if(e){console.log("Loading user data for:",e.id);try{const t=g.value.length>0;console.log("Has existing data:",t),await Promise.all([Y(e.id,t),re()]),console.log("Data loaded successfully"),Z(e.id),X(e.id,a=>{S.value=a})}catch(t){console.error("Error loading user data:",t),L()}}};ue(async()=>{d.user&&g.value.length===0&&await ie(d.user),await A();for(const e of k.value)await s(e.id);setTimeout(()=>{b.value&&(console.warn("Loading timeout reached, forcing reset"),L())},1e4)}),N(()=>d.user,async(e,t)=>{e&&!t?await ie(e):e&&t&&e.id!==t.id&&(W(),await Y(e.id,!0),await re(),Z(e.id),X(e.id,a=>{S.value=a}))});const oe=()=>{!document.hidden&&d.user&&b.value&&L(d.user.id)};return ue(()=>{document.addEventListener("visibilitychange",oe)}),Pe(()=>{document.removeEventListener("visibilitychange",oe),W()}),(e,t)=>(r(),y(Ke,{class:"q-pa-md"},{default:o(()=>[u("div",yt,[u("div",ht,c(e.$t("friends.title")),1),u("div",_t,[$.value?(r(),y(h,{key:0,dense:"",flat:"",icon:"unfold_less",label:e.$t("common.collapseAll"),onClick:t[0]||(t[0]=a=>Ce())},null,8,["label"])):C("",!0),$.value?(r(),y(h,{key:1,dense:"",flat:"",icon:"unfold_more",label:e.$t("common.expandAll"),onClick:t[1]||(t[1]=a=>Qe())},null,8,["label"])):C("",!0),we.value?(r(),y(Ee,{key:2,modelValue:$.value,"onUpdate:modelValue":t[2]||(t[2]=a=>$.value=a),label:e.$t("friends.groupByGroups")},null,8,["modelValue","label"])):C("",!0),n(h,{color:"primary",icon:"person_add",label:e.$t("friends.addFriend"),onClick:t[3]||(t[3]=a=>F.value=!0)},null,8,["label"])])]),n(Ue,{modelValue:E.value,"onUpdate:modelValue":t[4]||(t[4]=a=>E.value=a),class:"text-primary q-mb-md"},{default:o(()=>[n(fe,{name:"friends",label:e.$t("friends.myFriends")},null,8,["label"]),n(fe,{name:"pending",label:e.$t("friends.requests")},null,8,["label"])]),_:1},8,["modelValue"]),n(Ne),n(ze,{modelValue:E.value,"onUpdate:modelValue":t[5]||(t[5]=a=>E.value=a),animated:""},{default:o(()=>[n(ve,{name:"friends"},{default:o(()=>[D(b)?(r(),l("div",bt,[n(ce,{size:"lg"})])):D(g).length===0?(r(),l("div",$t,[n(G,{name:"people",size:"4rem"}),u("div",kt,c(e.$t("friends.noFriends")),1),u("div",null,c(e.$t("friends.addFirstFriend")),1)])):(r(),l("div",qt,[$.value?(r(!0),l(w,{key:0},V(ee.value,a=>(r(),l("div",{key:a.id||"ungrouped",class:"q-mb-lg"},[u("div",{class:"row items-center justify-between q-mb-sm cursor-pointer",onClick:i=>te(a.id)},[u("div",Ct,c(a.name),1),n(h,{dense:"",flat:"",icon:v.value[a.id||"ungrouped"]?"expand_less":"expand_more",onClick:me(i=>te(a.id),["stop"])},null,8,["icon","onClick"])],8,wt),n(je,null,{default:o(()=>[Oe(u("div",Qt,[(r(!0),l(w,null,V(a.items,i=>(r(),y(ge,{key:i.id,friend:i,"friendship-id":ae(i.id)},null,8,["friend","friendship-id"]))),128))],512),[[Ge,v.value[a.id||"ungrouped"]]])]),_:2},1024)]))),128)):(r(),l("div",St,[(r(!0),l(w,null,V(D(g),a=>(r(),y(ge,{key:a.id,friend:a,"friendship-id":ae(a.id)},null,8,["friend","friendship-id"]))),128))]))]))]),_:1}),n(ve,{name:"pending"},{default:o(()=>[D(b)?(r(),l("div",At,[n(ce,{size:"lg"})])):S.value.length===0?(r(),l("div",Ft,[n(G,{name:"inbox",size:"4rem"}),u("div",Rt,c(e.$t("friends.noRequests")),1),u("div",null,c(e.$t("friends.noRequestsDescription")),1)])):(r(),l("div",It,[(r(!0),l(w,null,V(S.value,a=>(r(),y(gt,{key:a.id,request:a,onAccept:Fe,onDecline:Re,onCancel:Ie},null,8,["request"]))),128))]))]),_:1})]),_:1},8,["modelValue"]),n(Le,{modelValue:F.value,"onUpdate:modelValue":t[8]||(t[8]=a=>F.value=a),onHide:se},{default:o(()=>[n(M,{style:{width:"100%","max-width":"500px"}},{default:o(()=>[n(T,null,{default:o(()=>[u("div",Dt,c(e.$t("friends.addFriend")),1)]),_:1}),n(T,null,{default:o(()=>[n(Te,{modelValue:Q.value,"onUpdate:modelValue":t[6]||(t[6]=a=>Q.value=a),label:e.$t("friends.searchUsers"),outlined:"",placeholder:e.$t("friends.searchPlaceholder"),onInput:U,onKeyup:Be(U,["enter"])},{prepend:o(()=>[n(G,{name:"search"})]),append:o(()=>[n(h,{flat:"",round:"",icon:"search",onClick:U,disabled:Q.value.length<2},null,8,["disabled"])]),_:1},8,["modelValue","label","placeholder"]),R.value.length>0?(r(),l("div",Vt,[u("div",xt,c(e.$t("friends.searchResults"))+":",1),n(Me,null,{default:o(()=>[(r(!0),l(w,null,V(R.value,a=>(r(),y(Je,{key:a.id,clickable:"",onClick:i=>ne(a.id)},{default:o(()=>[n(j,{avatar:""},{default:o(()=>[n(K,{color:"primary","text-color":"white"},{default:o(()=>[O(c(Ae(a)),1)]),_:2},1024)]),_:2},1024),n(j,null,{default:o(()=>[n(pe,null,{default:o(()=>[O(c(Se(a)),1)]),_:2},1024),n(pe,{caption:""},{default:o(()=>[O(c(a.username||(a.id===D(d).profile?.id?a.email:"")),1)]),_:2},1024)]),_:2},1024),n(j,{side:""},{default:o(()=>[n(h,{color:"primary",flat:"",round:"",icon:"person_add",onClick:me(i=>ne(a.id),["stop"])},null,8,["onClick"])]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})])):C("",!0)]),_:1}),n(he,{align:"right"},{default:o(()=>[n(h,{label:e.$t("common.cancel"),color:"grey",flat:"",onClick:t[7]||(t[7]=a=>F.value=!1)},null,8,["label"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});export{es as default};
