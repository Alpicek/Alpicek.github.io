import{a as _,r as v,b as q,n as D,w as c,o as N,g as u,e as i,c as R,an as A,f as m,t as d,k as P,h as w,j as b,i as f,ak as V,p as $,Q as F}from"./index-CQR_bE8v.js";import{Q as S}from"./QForm-DDztM9C3.js";import{Q as W}from"./QPage-hsiTuEin.js";import{u as I}from"./use-quasar-n8xqa7S3.js";import{u as L}from"./usePushNotifications-D85g29Na.js";import{u as O}from"./auth-store-Brg5fDdc.js";import{supabase as K}from"./supabase-CU5Rm_jF.js";import{N as j}from"./NotificationSettings-xAgADWZk.js";import{u as J}from"./vue-i18n.runtime-Cy39-0Yi.js";import"./QChip-B0JdZxMX.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const z={class:"q-pa-md",style:{"max-width":"600px",width:"100%"}},G={class:"text-h4 text-center q-mb-md"},H={class:"text-body1 text-center text-grey-6 q-mb-lg"},M={key:0},X={class:"text-h6 q-mb-md"},Y={class:"q-gutter-md"},Z={class:"text-h6 q-mb-md"},tt={class:"text-h6 q-mb-md text-warning"},it={class:"bg-warning text-dark q-pa-md rounded-borders"},bt=_({__name:"NotificationsPage",setup(ot){const g=I(),{t:e}=J(),a=L(),C=O(),s=v(!1),y=v(!1),l=q({title:"",body:"",url:""}),r=q({title:"",body:"",url:""}),k=async()=>{if(a.isSubscribed.value){s.value=!0;try{const t=await a.getCurrentSubscription();if(!t)throw new Error("No subscription found");await a.sendNotification(t,{title:l.title,body:l.body,icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"custom-notification",data:{type:"custom",url:l.url||"/",timestamp:Date.now()}}),l.title="",l.body="",l.url=""}catch(t){console.error("Error sending custom notification:",t)}finally{s.value=!1}}},B=async()=>{if(a.isSubscribed.value){s.value=!0;try{const t=await a.getCurrentSubscription();if(!t)throw new Error("No subscription found");await a.sendNotification(t,{title:e("notifications.wishNotificationTitle"),body:e("notifications.wishNotificationBody"),icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"new-wish",data:{type:"wish",url:"/wishes",timestamp:Date.now()},actions:[{action:"view",title:e("notifications.viewWishes")},{action:"dismiss",title:e("common.close")}]})}catch(t){console.error("Error sending wish notification:",t)}finally{s.value=!1}}},E=async()=>{if(a.isSubscribed.value){s.value=!0;try{const t=await a.getCurrentSubscription();if(!t)throw new Error("No subscription found");await a.sendNotification(t,{title:e("notifications.friendRequestTitle"),body:e("notifications.friendRequestBody"),icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"friend-request",data:{type:"friend-request",url:"/friends",timestamp:Date.now()},actions:[{action:"view",title:e("notifications.viewFriends")},{action:"dismiss",title:e("common.close")}]})}catch(t){console.error("Error sending friend request notification:",t)}finally{s.value=!1}}},Q=async()=>{s.value=!0;try{const t=await a.getCurrentSubscription();if(!t)throw new Error("No subscription found");await a.sendNotification(t,{title:e("notifications.birthdayTitle"),body:e("notifications.birthdayBody"),icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"birthday",data:{type:"birthday",url:"/friends",timestamp:Date.now()},actions:[{action:"view",title:e("notifications.viewProfile")},{action:"dismiss",title:e("common.close")}]})}catch(t){console.error("Error sending birthday notification:",t)}finally{s.value=!1}},x=async()=>{y.value=!0;try{const{data:t,error:n}=await K.from("push_subscriptions").select("subscription_data").eq("is_active",!0);if(n)throw n;if(!t||t.length===0){g.notify({type:"warning",message:e("notifications.noSubscriptions"),timeout:3e3});return}let o=0,h=0;for(const U of t)try{const p=U.subscription_data,T={endpoint:p.endpoint,expirationTime:null,options:{applicationServerKey:null,userVisibleOnly:!0},getKey:()=>null,unsubscribe:()=>Promise.resolve(!0),toJSON:()=>p};await a.sendNotification(T,{title:r.title,body:r.body,icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",tag:"admin-broadcast",data:{type:"admin-broadcast",url:r.url||"/",timestamp:Date.now()}}),o++}catch(p){console.error("Error sending to subscription:",p),h++}g.notify({type:o>0?"positive":"negative",message:e("notifications.broadcastResult",{success:o,errors:h}),timeout:5e3}),o>0&&(r.title="",r.body="",r.url="")}catch(t){console.error("Error sending admin notification:",t),g.notify({type:"negative",message:e("notifications.broadcastError"),timeout:5e3})}finally{y.value=!1}};return(t,n)=>(N(),D(W,{class:"flex flex-center"},{default:c(()=>[u("div",z,[i(F,null,{default:c(()=>[i(m,null,{default:c(()=>[u("div",G,d(t.$t("notifications.title")),1),u("div",H,d(t.$t("notifications.pageDescription")),1)]),_:1}),i(m,null,{default:c(()=>[i(j)]),_:1}),P(C).user?.email==="pichalek@gmail.com"?(N(),R("div",M,[i(m,null,{default:c(()=>[i(w,{class:"q-mb-md"}),u("div",X,d(t.$t("notifications.quickActions")),1),u("div",Y,[i(b,{color:"primary",icon:"card_giftcard",label:t.$t("notifications.notifyNewWish"),onClick:B,loading:s.value,class:"full-width"},null,8,["label","loading"]),i(b,{color:"secondary",icon:"group",label:t.$t("notifications.notifyFriendRequest"),onClick:E,loading:s.value,class:"full-width"},null,8,["label","loading"]),i(b,{color:"accent",icon:"celebration",label:t.$t("notifications.notifyBirthday"),onClick:Q,loading:s.value,class:"full-width"},null,8,["label","loading"])])]),_:1}),i(m,null,{default:c(()=>[i(w,{class:"q-mb-md"}),u("div",Z,d(t.$t("notifications.customNotification")),1),i(S,{onSubmit:k,class:"q-gutter-md"},{default:c(()=>[i(f,{modelValue:l.title,"onUpdate:modelValue":n[0]||(n[0]=o=>l.title=o),label:t.$t("notifications.notificationTitle"),outlined:"",rules:[o=>!!o||t.$t("common.required")]},null,8,["modelValue","label","rules"]),i(f,{modelValue:l.body,"onUpdate:modelValue":n[1]||(n[1]=o=>l.body=o),label:t.$t("notifications.notificationBody"),outlined:"",type:"textarea",rows:"3",rules:[o=>!!o||t.$t("common.required")]},null,8,["modelValue","label","rules"]),i(f,{modelValue:l.url,"onUpdate:modelValue":n[2]||(n[2]=o=>l.url=o),label:t.$t("notifications.targetUrl"),outlined:"",placeholder:"/wishes",hint:"Optional URL to open when notification is clicked"},null,8,["modelValue","label"]),i(b,{type:"submit",color:"primary",icon:"send",label:t.$t("notifications.sendCustom"),loading:s.value,class:"full-width"},null,8,["label","loading"])]),_:1})]),_:1}),i(m,null,{default:c(()=>[i(w,{class:"q-mb-md"}),u("div",tt,[i($,{name:"admin_panel_settings",class:"q-mr-sm"}),V(" "+d(t.$t("notifications.adminSection")),1)]),i(S,{onSubmit:x,class:"q-gutter-md"},{default:c(()=>[i(f,{modelValue:r.title,"onUpdate:modelValue":n[3]||(n[3]=o=>r.title=o),label:t.$t("notifications.notificationTitle"),outlined:"",rules:[o=>!!o||t.$t("common.required")]},null,8,["modelValue","label","rules"]),i(f,{modelValue:r.body,"onUpdate:modelValue":n[4]||(n[4]=o=>r.body=o),label:t.$t("notifications.notificationBody"),outlined:"",type:"textarea",rows:"3",rules:[o=>!!o||t.$t("common.required")]},null,8,["modelValue","label","rules"]),i(f,{modelValue:r.url,"onUpdate:modelValue":n[5]||(n[5]=o=>r.url=o),label:t.$t("notifications.targetUrl"),outlined:"",placeholder:"/"},null,8,["modelValue","label"]),u("div",it,[i($,{name:"warning",class:"q-mr-sm"}),V(" "+d(t.$t("notifications.adminWarning")),1)]),i(b,{type:"submit",color:"warning",icon:"campaign",label:t.$t("notifications.sendToAll"),loading:y.value,class:"full-width"},null,8,["label","loading"])]),_:1})]),_:1})])):A("",!0)]),_:1})])]),_:1}))}});export{bt as default};
