import{a as Fe,z as q,r as b,b as Ae,q as Ce,az as Ue,ai as Te,w as x,s as Ne,g as W,o,f as m,c as u,e as a,t as g,l as J,j as te,m as $,x as L,v as H,F as C,A as M,Q as Be,i as le,at as Ie,k as K,aA as De}from"./index-CzEHk4FJ.js";import{a as re,Q as Oe}from"./QTabs-hMbSUOU_.js";import{a as oe,Q as ze}from"./QTabPanels-Cehjd_OV.js";import{Q as X}from"./QSelect-DxzLhrlU.js";import{Q as Pe}from"./QForm-6rZQtFi0.js";import{Q as je}from"./QPage-GP0CvhFB.js";import{u as xe}from"./useWishes-uJat6tJ9.js";import{u as Ge}from"./auth-store-B9ZbRhc6.js";import{u as Je}from"./use-quasar-jdesDfeO.js";import{supabase as ue}from"./supabase-RdUxExGH.js";import{W as Y}from"./WishCard-DbdUhVUn.js";import{u as Le}from"./useGroups-C__TII0R.js";import{u as He}from"./vue-i18n.runtime-zO4z2J8f.js";import"./QResizeObserver-BXHMh2fz.js";import"./rtl-DFPa-2ov.js";import"./touch-BjYP5sR0.js";import"./selection-DmknuNDx.js";import"./QItem-atIWw8xQ.js";import"./format-CoDFvEdh.js";import"./position-engine-BZGJ-mmQ.js";import"./QSlideTransition-CuHHXKmI.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Me={class:"row justify-between items-center q-mb-md"},Ke={class:"text-h4"},Xe={key:0,class:"flex justify-center"},Ye={key:1,class:"text-center text-grey-6 q-py-lg"},Ze={class:"text-h6 q-mt-md"},es={key:2,class:"masonry"},ss={key:0,class:"flex justify-center"},is={key:1,class:"text-center text-grey-6 q-py-lg"},as={class:"text-h6 q-mt-md"},ts={key:2,class:"masonry"},ls={key:0,class:"flex justify-center"},rs={key:1,class:"text-center text-grey-6 q-py-lg"},os={class:"text-h6 q-mt-md"},us={key:2,class:"masonry"},ns={class:"text-h6"},ds={key:0},vs={class:"text-subtitle2"},cs={class:"text-caption text-grey-7 q-mb-sm"},ms={class:"row justify-end q-gutter-sm"},Bs=Fe({__name:"WishesPage",setup(fs){const _=Je(),{t:n}=He(),F=Ue(),t=Ge(),V=q(()=>F.params.userId),v=q(()=>!!V.value),{isLoading:U,createWish:ne,fetchWishes:de,fetchAllWishesForUser:ve,fetchReceivedWishes:ce,refreshWishes:T,refreshAllWishesForUser:N,refreshReceivedWishes:B,updateWish:me,deleteWish:fe,toggleBought:he,toggleReceived:pe}=xe(),f=b([]),y=b([]),I=q(()=>v.value?y.value:f.value);let R=null;const D=b("my-wishes"),S=b(!1),k=b(null),h=b([]),Q=b(""),E=b({}),r=Ae({name:"",description:"",url:"",visibility:"friends"}),{groups:Z,fetchGroups:ge,setWishRules:ee,fetchWishRules:ye}=Le(),p=b([]),w=b([]),we=q(()=>(Z.value||[]).filter(e=>!w.value.includes(e.id)).map(e=>({label:e.name,value:e.id}))),be=q(()=>(Z.value||[]).filter(e=>!p.value.includes(e.id)).map(e=>({label:e.name,value:e.id}))),We=q(()=>[{label:n("wishes.form.visibilityPublic"),value:"public"},{label:n("wishes.form.visibilityFriends"),value:"friends"},{label:n("wishes.form.visibilityFriendsGroups"),value:"friends-groups"},{label:n("wishes.form.visibilityPrivate"),value:"private"}]),se=()=>{r.name="",r.description="",r.url="",r.visibility="friends",p.value=[],w.value=[],k.value=null},_e=async()=>{if(!t.user)return;const e=v.value?V.value:t.user.id;if(!e)return;const s=r.visibility==="friends-groups"?"friends":r.visibility,i={name:r.name,...r.description&&{description:r.description},...r.url&&{url:r.url},visibility:s,created_for_user_id:e,created_by_user_id:t.user.id};let l;if(k.value?l=await me(k.value,i):l=await ne(i),l.error)_.notify({type:"negative",message:n("wishes.saveError")+": "+(l.error instanceof Error?l.error.message:JSON.stringify(l.error))});else{const d=l&&"data"in l&&l.data?.id||void 0;if(d){if(r.visibility==="friends-groups"){const c=Array.from(new Set(p.value)),Ee=Array.from(new Set(w.value)).filter(qe=>!c.includes(qe)),j=await ee(d,c,Ee);if(j.error){_.notify({type:"negative",message:n("wishes.saveError")+": "+(j.error instanceof Error?j.error.message:JSON.stringify(j.error))});return}E.value[d]=(E.value[d]||0)+1}else if(s==="friends"){const c=await ee(d,[],[]);if(c.error){_.notify({type:"negative",message:n("wishes.saveError")+": "+(c.error instanceof Error?c.error.message:JSON.stringify(c.error))});return}E.value[d]=(E.value[d]||0)+1}}if(_.notify({type:"positive",message:k.value?n("wishes.updateSuccess"):n("wishes.createSuccess")}),S.value=!1,se(),v.value){const c=await N(V.value,!0);c?.data&&(y.value=c.data)}else{const c=await T(t.user.id);c?.data&&(f.value=c.data)}}},Ve=e=>{r.name=e.name,r.description=e.description||"",r.url=e.url||"",r.visibility=e.visibility,k.value=e.id,(async()=>{const s=await ye(e.id);if(!s.error&&s.data){p.value=s.data.filter(l=>l.rule_type==="include").map(l=>l.group_id);const i=s.data.filter(l=>l.rule_type==="exclude").map(l=>l.group_id);w.value=i.filter(l=>!p.value.includes(l)),e.visibility==="friends"&&(p.value.length||w.value.length)&&(r.visibility="friends-groups")}S.value=!0})()},$e=async e=>{const s=await fe(e);s.error?_.notify({type:"negative",message:n("wishes.deleteError")+": "+(s.error instanceof Error?s.error.message:JSON.stringify(s.error))}):_.notify({type:"positive",message:n("wishes.deleteSuccess")})},ie=async e=>{if(!t.user)return;const s=await he(e,t.user.id);if(s.error)_.notify({type:"negative",message:n("wishes.toggleBoughtError")+": "+(s.error instanceof Error?s.error.message:JSON.stringify(s.error))});else if(v.value){const i=await N(V.value);i?.data&&(y.value=i.data)}else{const i=await T(t.user.id);i?.data&&(f.value=i.data);const l=await B(t.user.id);l?.data&&(h.value=l.data)}},G=async e=>{if(!t.user)return;const s=await pe(e,t.user.id);if(s.error)_.notify({type:"negative",message:n("wishes.toggleReceivedError")+": "+(typeof s.error=="string"?s.error:JSON.stringify(s.error))});else{if(v.value){const i=await N(V.value);i?.data&&(y.value=i.data)}else{const i=await T(t.user.id);i?.data&&(f.value=i.data);const l=await B(t.user.id);l?.data&&(h.value=l.data)}_.notify({type:"positive",message:n("wishes.toggleReceivedSuccess")})}};let A=null;const Re=async()=>{!document.hidden&&t.user&&(await O(F.params.userId),z())};Ce(async()=>{t.user&&(await O(F.params.userId),z()),await ge(),A=()=>{Re().catch(()=>{})},document.addEventListener("visibilitychange",A)}),Te(()=>{A&&(document.removeEventListener("visibilitychange",A),A=null),ae()});const Se=async()=>{if(!t.user)return;const e=await ce(t.user.id);e?.data&&(h.value=e.data)},ke=async e=>{try{const{data:s,error:i}=await ue.from("profiles_public").select("name, username").eq("id",e).single();if(i)throw i;Q.value=(s?.name||s?.username)??n("common.unknown")}catch{Q.value=n("common.unknown")}},O=async e=>{if(t.user)if(e){f.value=[],y.value=[],h.value=[],Q.value="",await ke(e);const s=await ve(e,!0);s?.data&&(y.value=s.data)}else{const s=f.value.length>0;f.value=[],y.value=[],h.value=[],Q.value="";const i=await de(t.user.id,s,"active");i?.data&&(f.value=i.data),await Se()}};x(p,e=>{e?.length&&(w.value=w.value.filter(s=>!e.includes(s)))}),x(w,e=>{e?.length&&(p.value=p.value.filter(s=>!e.includes(s)))}),x(()=>F.params.userId,async(e,s)=>{e!==s&&(Q.value="",await O(e),z())},{immediate:!0}),x(()=>t.user?.id,async e=>{e?(await O(F.params.userId),z()):ae()});const z=()=>{t.user&&(R&&R.unsubscribe(),R=ue.channel("wishes_changes").on("postgres_changes",{event:"*",schema:"public",table:"wishes"},e=>{Qe(e)}).subscribe())},Qe=async e=>{if(!t.user)return;const{eventType:s,new:i,old:l}=e;if(s==="INSERT"&&i)v.value&&i.created_for_user_id===V.value?await P():!v.value&&i.created_for_user_id===t.user.id&&await P();else if(s==="UPDATE"&&i)if(!v.value&&i.created_for_user_id===t.user.id){await P();const d=await B(t.user.id);d?.data&&(h.value=d.data)}else v.value&&i.created_for_user_id===V.value&&await P();else s==="DELETE"&&l&&(v.value?y.value=y.value.filter(d=>d.id!==l.id):(f.value=f.value.filter(d=>d.id!==l.id),h.value=h.value.filter(d=>d.id!==l.id)))},P=async()=>{if(t.user)if(v.value){const e=await N(V.value,!0);e?.data&&(y.value=e.data)}else{const e=await T(t.user.id);e?.data&&(f.value=e.data);const s=await B(t.user.id);s?.data&&(h.value=s.data)}},ae=()=>{R&&(R.unsubscribe(),R=null)};return(e,s)=>(o(),Ne(je,{class:"q-pa-md"},{default:W(()=>[m("div",Me,[m("div",Ke,g(v.value?`${Q.value}'s ${e.$t("wishes.wishes")}`:e.$t("wishes.title")),1),a(J,{color:"primary",icon:"add",label:v.value?e.$t("wishes.addForFriend"):e.$t("wishes.add"),onClick:s[0]||(s[0]=i=>S.value=!0)},null,8,["label"])]),v.value?(o(),u(C,{key:1},[$(U)?(o(),u("div",ls,[a(L,{size:"lg"})])):I.value.length===0?(o(),u("div",rs,[a(H,{name:"card_giftcard",size:"4rem"}),m("div",os,g(e.$t("wishes.noWishes")),1),m("div",null,g(e.$t("wishes.friendHasNoWishes")),1)])):(o(),u("div",us,[(o(!0),u(C,null,M(I.value,i=>(o(),u("div",{key:i.id,class:"masonry-item"},[a(Y,{wish:i,"current-user-id":$(t).user?.id,"refresh-key":E.value[i.id]||0,onToggleBought:ie,onToggleReceived:G},null,8,["wish","current-user-id","refresh-key"])]))),128))]))],64)):(o(),u(C,{key:0},[a(Oe,{modelValue:D.value,"onUpdate:modelValue":s[1]||(s[1]=i=>D.value=i),class:"text-primary q-mb-md"},{default:W(()=>[a(re,{name:"my-wishes",label:e.$t("wishes.myWishes")},null,8,["label"]),a(re,{name:"archive",label:e.$t("wishes.archive")},null,8,["label"])]),_:1},8,["modelValue"]),a(te),a(ze,{modelValue:D.value,"onUpdate:modelValue":s[2]||(s[2]=i=>D.value=i),animated:""},{default:W(()=>[a(oe,{name:"my-wishes"},{default:W(()=>[$(U)?(o(),u("div",Xe,[a(L,{size:"lg"})])):I.value.length===0?(o(),u("div",Ye,[a(H,{name:"card_giftcard",size:"4rem"}),m("div",Ze,g(e.$t("wishes.noWishes")),1),m("div",null,g(e.$t("wishes.addFirstWish")),1)])):(o(),u("div",es,[(o(!0),u(C,null,M(I.value,i=>(o(),u("div",{key:i.id,class:"masonry-item"},[a(Y,{wish:i,"current-user-id":$(t).user?.id,"refresh-key":E.value[i.id]||0,onEdit:Ve,onDelete:$e,onToggleBought:ie,onToggleReceived:G},null,8,["wish","current-user-id","refresh-key"])]))),128))]))]),_:1}),a(oe,{name:"archive"},{default:W(()=>[$(U)?(o(),u("div",ss,[a(L,{size:"lg"})])):h.value.length===0?(o(),u("div",is,[a(H,{name:"archive",size:"4rem"}),m("div",as,g(e.$t("wishes.noArchivedWishes")),1),m("div",null,g(e.$t("wishes.noArchivedWishesDesc")),1)])):(o(),u("div",ts,[(o(!0),u(C,null,M(h.value,i=>(o(),u("div",{key:i.id,class:"masonry-item"},[a(Y,{wish:i,"current-user-id":$(t).user?.id,onToggleReceived:G},null,8,["wish","current-user-id"])]))),128))]))]),_:1})]),_:1},8,["modelValue"])],64)),a(De,{modelValue:S.value,"onUpdate:modelValue":s[10]||(s[10]=i=>S.value=i),onHide:se},{default:W(()=>[a(Be,{style:{width:"100%","max-width":"500px"}},{default:W(()=>[a(le,null,{default:W(()=>[m("div",ns,g(k.value?e.$t("wishes.editWish"):e.$t("wishes.addWish")),1)]),_:1}),a(le,null,{default:W(()=>[a(Pe,{onSubmit:_e,class:"q-gutter-md"},{default:W(()=>[a(K,{modelValue:r.name,"onUpdate:modelValue":s[3]||(s[3]=i=>r.name=i),label:e.$t("wishes.form.name"),outlined:"",rules:[i=>!!i||e.$t("wishes.form.nameRequired")]},null,8,["modelValue","label","rules"]),a(K,{modelValue:r.description,"onUpdate:modelValue":s[4]||(s[4]=i=>r.description=i),label:e.$t("wishes.form.description"),type:"textarea",outlined:"",rows:"3"},null,8,["modelValue","label"]),a(K,{modelValue:r.url,"onUpdate:modelValue":s[5]||(s[5]=i=>r.url=i),label:e.$t("wishes.form.url"),outlined:"",type:"url"},null,8,["modelValue","label"]),a(X,{modelValue:r.visibility,"onUpdate:modelValue":s[6]||(s[6]=i=>r.visibility=i),label:e.$t("wishes.form.visibility"),outlined:"",options:We.value,"option-value":"value","option-label":"label","emit-value":"","map-options":""},null,8,["modelValue","label","options"]),r.visibility==="friends-groups"?(o(),u("div",ds,[a(te,{class:"q-my-sm"}),m("div",vs,g(e.$t("wishes.form.groupSharing.title")),1),m("div",cs,g(e.$t("wishes.form.groupSharing.hint1"))+" "+g(e.$t("wishes.form.groupSharing.hint2")),1),a(X,{modelValue:p.value,"onUpdate:modelValue":s[7]||(s[7]=i=>p.value=i),options:we.value,label:e.$t("wishes.form.groupSharing.include"),outlined:"",multiple:"",clearable:"","use-chips":"","emit-value":"","map-options":""},null,8,["modelValue","options","label"]),a(X,{modelValue:w.value,"onUpdate:modelValue":s[8]||(s[8]=i=>w.value=i),options:be.value,label:e.$t("wishes.form.groupSharing.exclude"),outlined:"",multiple:"",clearable:"","use-chips":"","emit-value":"","map-options":"",class:"q-mt-sm"},null,8,["modelValue","options","label"])])):Ie("",!0),m("div",ms,[a(J,{label:e.$t("common.cancel"),color:"grey",flat:"",onClick:s[9]||(s[9]=i=>S.value=!1)},null,8,["label"]),a(J,{type:"submit",label:e.$t("common.save"),color:"primary",loading:$(U)},null,8,["label","loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});export{Bs as default};
