import{supabase as n}from"./supabase-CzT8qtRc.js";import{i as u,r as c}from"./index-fFjDkX5r.js";const y=c([]),d=c([]),a=c(!1),L=()=>{const f=u(()=>a.value),h=u(()=>d.value),p=async(t,r)=>{a.value=!0;try{const{data:e,error:s}=await n.from("friendships").insert([{user_id:r,friend_id:t,status:"pending"}]).select().single();if(s)throw s;return{data:e,error:null}}catch(e){return console.error("Error sending friend request:",e),{data:null,error:e}}finally{a.value=!1}},m=async t=>{a.value=!0;try{const{data:r,error:e}=await n.from("friendships").update({status:"accepted"}).eq("id",t).select().single();if(e)throw e;return await l(),{data:r,error:null}}catch(r){return console.error("Error accepting friend request:",r),{data:null,error:r}}finally{a.value=!1}},w=async t=>{a.value=!0;try{const{data:r,error:e}=await n.from("friendships").update({status:"declined"}).eq("id",t).select().single();if(e)throw e;return{data:r,error:null}}catch(r){return console.error("Error declining friend request:",r),{data:null,error:r}}finally{a.value=!1}},l=async t=>{if(t){a.value=!0;try{const{data:r,error:e}=await n.from("friendships").select(`
          *,
          friend:profiles!friendships_friend_id_fkey(*),
          user:profiles!friendships_user_id_fkey(*)
        `).or(`user_id.eq.${t},friend_id.eq.${t}`).eq("status","accepted");if(e)throw e;const s=r?.map(i=>i.user_id===t?i.friend:i.user)||[];return d.value=s,y.value=r||[],{data:s,error:null}}catch(r){return console.error("Error fetching friends:",r),{data:null,error:r}}finally{a.value=!1}}};return{friends:h,isLoading:f,sendFriendRequest:p,acceptFriendRequest:m,declineFriendRequest:w,fetchFriends:l,fetchPendingRequests:async t=>{if(t){a.value=!0;try{const{data:r,error:e}=await n.from("friendships").select(`
          *,
          user:profiles!friendships_user_id_fkey(*)
        `).eq("friend_id",t).eq("status","pending");if(e)throw e;return{data:r,error:null}}catch(r){return console.error("Error fetching pending requests:",r),{data:null,error:r}}finally{a.value=!1}}},searchUsers:async t=>{a.value=!0;try{const{data:r,error:e}=await n.rpc("search_users",{search_query:t,limit_count:10});if(e)throw e;return{data:r,error:null}}catch(r){console.error("Error searching users:",r);try{const{data:e,error:s}=await n.from("profiles").select("*").eq("is_dummy",!1).limit(10);if(s)throw s;return{data:e?.filter(o=>o.email.toLowerCase().includes(t.toLowerCase())||o.name&&o.name.toLowerCase().includes(t.toLowerCase())||o.surname&&o.surname.toLowerCase().includes(t.toLowerCase())||o.username&&o.username.toLowerCase().includes(t.toLowerCase()))||[],error:null}}catch(e){return console.error("Fallback search also failed:",e),{data:null,error:e}}}finally{a.value=!1}},removeFriend:async t=>{a.value=!0;try{const{error:r}=await n.from("friendships").delete().eq("id",t);if(r)throw r;return await l(),{error:null}}catch(r){return console.error("Error removing friend:",r),{error:r}}finally{a.value=!1}}}};export{L as u};
