import{supabase as s}from"./supabase-bByfhSrO.js";import{a as S}from"./auth-store-CFwI7z_J.js";import{r as p,z as _}from"./index-DywPtqBD.js";const D=()=>{const c=p([]),l=p({}),i=p({}),f=p(0),{shouldShowLoading:m,markDataLoaded:v}=S(),y=_(()=>f.value>0),o=async(e,r=!0,a="groups")=>{const t=r&&m(a);t&&f.value++;try{const n=await e();return r&&v(a),n}finally{t&&(f.value=Math.max(0,f.value-1))}},g=async()=>o(async()=>{const{data:e,error:r}=await s.from("groups").select("*").order("created_at",{ascending:!1});return r?{data:[],error:r}:(c.value=e||[],{data:c.value,error:null})}),h=async(e,r)=>o(async()=>{const{data:a,error:t}=await s.from("groups").insert([{name:e.name,description:e.description||null,creator_id:r}]).select("*").single();return t?{data:null,error:t}:(c.value.unshift(a),{data:a,error:null})}),w=async(e,r)=>o(async()=>{const{data:a,error:t}=await s.from("groups").update(r).eq("id",e).select("*").single();if(t)return{data:null,error:t};const n=c.value.findIndex(u=>u.id===e);return n!==-1&&(c.value[n]=a),{data:a,error:null}}),q=async e=>o(async()=>{const{error:r}=await s.from("groups").delete().eq("id",e);return r?{error:r}:(c.value=c.value.filter(a=>a.id!==e),delete l.value[e],{error:null})}),G=async e=>o(async()=>{const{data:r,error:a}=await s.from("group_members").select("*").eq("group_id",e).order("created_at",{ascending:!0});return a?{data:[],error:a}:(l.value[e]=r||[],{data:l.value[e],error:null})}),b=async(e,r)=>o(async()=>{const{data:a,error:t}=await s.from("group_members").insert([{group_id:e,user_id:r}]).select("*").single();return t?{data:null,error:t}:(l.value[e]||(l.value[e]=[]),l.value[e].push(a),{data:a,error:null})}),x=async(e,r)=>o(async()=>{const{error:a}=await s.from("group_members").delete().eq("group_id",e).eq("user_id",r);return a?{error:a}:(l.value[e]=(l.value[e]||[]).filter(t=>t.user_id!==r),{error:null})}),W=async e=>o(async()=>{const{data:r,error:a}=await s.from("wish_group_rules").select("*").eq("wish_id",e);return a?{data:[],error:a}:(i.value[e]=r||[],{data:i.value[e],error:null})},!1),B=async(e,r,a)=>o(async()=>{await s.from("wish_group_rules").delete().eq("wish_id",e).eq("group_id",r);const{data:t,error:n}=await s.from("wish_group_rules").insert([{wish_id:e,group_id:r,rule_type:a}]).select("*").single();if(n)return{data:null,error:n};const u=i.value[e]||[],d=u.findIndex(R=>R.group_id===r);return d!==-1?u[d]=t:u.push(t),i.value[e]=u,{data:t,error:null}},!1),L=async(e,r)=>o(async()=>{const{error:a}=await s.from("wish_group_rules").delete().eq("wish_id",e).eq("group_id",r);return a?{error:a}:(i.value[e]=(i.value[e]||[]).filter(t=>t.group_id!==r),{error:null})},!1),M=async(e,r,a)=>o(async()=>{const t=await s.from("wish_group_rules").delete().eq("wish_id",e);if(t.error)return{error:t.error};const n=[];for(const u of r)n.push({wish_id:e,group_id:u,rule_type:"include"});for(const u of a)n.push({wish_id:e,group_id:u,rule_type:"exclude"});if(n.length>0){const{data:u,error:d}=await s.from("wish_group_rules").insert(n).select("*");if(d)return{error:d};i.value[e]=u||[]}else i.value[e]=[];return{error:null}},!1);return{groups:_(()=>c.value),membersByGroup:_(()=>l.value),rulesByWish:_(()=>i.value),isLoading:y,fetchGroups:g,createGroup:h,updateGroup:w,deleteGroup:q,fetchGroupMembers:G,addMemberToGroup:b,removeMemberFromGroup:x,fetchWishRules:W,upsertWishRule:B,removeWishRule:L,setWishRules:M}};export{D as u};
