import{a as P}from"./QSelect-Dj3w_WVr.js";import{B as de,E as ce,a0 as me,a2 as he,H as pe,aJ as ve,z as u,C as F,aF as fe,x as we,r as z,a as ie,q as J,w as K,c as _,o as a,aC as m,at as S,f as y,e as p,g as L,p as H,t as T,m as A,F as Y,A as X,ak as oe,k as ge,aE as be,l as V,y as ye,s as x,Q as _e,i as te,a7 as ke,aD as Ce,av as $e,j as Ie,az as Se}from"./index-C8cpulqW.js";import{Q as qe}from"./QSlideTransition-B8Oej5nE.js";import{u as Te}from"./use-quasar-29mMv4UO.js";import{u as Ee}from"./useGroups-BiMcd6Iy.js";import{supabase as W}from"./supabase-BQifrLNN.js";import{Q as Z}from"./QBadge-DZF8D1VH.js";import{Q as Be,a as se}from"./QTabs-BLaw2S9P.js";import{u as Qe}from"./auth-store-DcQcOhW1.js";import{u as re}from"./vue-i18n.runtime-14acve9v.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";function Re(l){if(!l)return null;let t=l.trim();/^https?:\/\//i.test(t)||(t="https://"+t);try{const C=new URL(t).hostname.toLowerCase().replace(/^www\./,""),$=C.split(".");return $.length>=2?$.slice(-2).join("."):C}catch{return null}}function xe(){async function l(t,s="_blank"){if(!t)return;const C=W.rpc("track_link_click",{target_url:t});try{s==="_blank"?window.open(t,"_blank","noopener"):window.location.href=t}catch{}try{await C}catch{}}return{trackClickAndOpen:l,extractBaseDomain:Re}}const Le=de({name:"QInnerLoading",props:{...me,...ce,showing:Boolean,color:String,size:{type:[String,Number],default:"42px"},label:String,labelClass:String,labelStyle:[String,Array,Object]},setup(l,{slots:t}){const s=pe(),C=he(l,s.proxy.$q),{transitionProps:$,transitionStyle:v}=ve(l),N=u(()=>"q-inner-loading q--avoid-card-border absolute-full column flex-center"+(C.value===!0?" q-inner-loading--dark":"")),D=u(()=>"q-inner-loading__label"+(l.labelClass!==void 0?` ${l.labelClass}`:""));function M(){const c=[F(we,{size:l.size,color:l.color})];return l.label!==void 0&&c.push(F("div",{class:D.value,style:l.labelStyle},[l.label])),c}function k(){return l.showing===!0?F("div",{class:N.value,style:v.value},t.default!==void 0?t.default():M()):null}return()=>F(fe,$.value,k)}});function Ne(){const l=Qe(),t=z([]),s=z(!1),C=new Set,$=new Map,v=new Map,N=r=>t.value.filter(o=>o.wish_id===r),D=r=>N(r).filter(o=>o.thread_type==="recipient"),M=r=>N(r).filter(o=>o.thread_type==="secret"),k=r=>l.user?.id===r.created_for_user_id,c=async r=>{s.value=!0;try{const{data:o,error:I}=await W.from("wish_comments").select("*").eq("wish_id",r).order("created_at",{ascending:!0});if(I)throw I;if(!o)return{data:[],error:null};const f=Array.from(new Set(o.map(n=>n.author_id))),{data:d,error:w}=await W.from("profiles_public").select("*").in("id",f);if(w)throw w;const g=new Map((d||[]).map(n=>[n.id,n]));g.forEach((n,G)=>v.set(G,n));const h=new Set(t.value.map(n=>n.id)),i=o.filter(n=>!h.has(n.id)).map(n=>({...n,author:g.get(n.author_id)||null}));return t.value=t.value.concat(i),C.add(r),{data:i,error:null}}catch(o){return{data:[],error:o instanceof Error?o:new Error(String(o))}}finally{s.value=!1}},E=async(r,o,I)=>{const f=l.user?.id;if(!f)return{error:new Error("Not authenticated")};if(!o.trim())return{error:new Error("Empty comment")};try{const{data:d,error:w}=await W.from("wish_comments").insert([{wish_id:r,body:o.trim(),thread_type:I,author_id:f}]).select("*").single();if(w)throw w;const g={...d,author:l.profile};return v.set(g.author_id,g.author||null),t.value.push(g),{data:d,error:null}}catch(d){const w=d;return w&&w.code==="23514"&&typeof w.message=="string"&&/notifications_type_check/i.test(w.message)?{error:new Error("Notification type constraint blocked comment – apply latest migration.")}:{error:d instanceof Error?d:new Error(String(d))}}},B=r=>{if($.has(r))return;const o=W.channel(`wish_comments:wish_id=${r}`);o.on("postgres_changes",{event:"INSERT",schema:"public",table:"wish_comments",filter:`wish_id=eq.${r}`},I=>{const f=I.new;if(!t.value.find(d=>d.id===f.id)){const d=v.get(f.author_id)??null,w={...f,author:d};t.value.push(w),d||W.from("profiles_public").select("*").eq("id",f.author_id).single().then(({data:g})=>{if(g){v.set(f.author_id,g);const h=t.value.findIndex(i=>i.id===f.id);h!==-1&&t.value[h]&&(t.value[h].author=g)}})}}),o.on("postgres_changes",{event:"DELETE",schema:"public",table:"wish_comments",filter:`wish_id=eq.${r}`},I=>{const f=I.old.id;t.value=t.value.filter(d=>d.id!==f)}),o.subscribe(),$.set(r,o)},Q=r=>{const o=$.get(r);o&&(W.removeChannel(o),$.delete(r))},U=r=>{t.value=t.value.filter(o=>o.wish_id!==r),C.delete(r)};return{comments:u(()=>t.value),loading:u(()=>s.value),fetchComments:c,addComment:E,ensureSubscribed:B,unsubscribe:Q,resetWish:U,getRecipientComments:D,getSecretComments:M,isRecipient:k}}const De={key:0,class:"row items-center q-mb-sm"},Ae={key:2,class:"q-mb-sm"},ze={key:3,class:"q-mb-sm"},Me={key:0,class:"text-caption text-grey-6 q-pa-sm"},Ve=["data-comment-id"],We={class:"text-caption text-grey-6"},Ue={class:"author"},Ge={class:"time"},Pe={class:"text-body2"},Fe=ie({__name:"WishComments",props:{wishId:{},wish:{},focusThread:{},focusCommentId:{}},setup(l){const t=l,{t:s}=re(),{fetchComments:C,ensureSubscribed:$,getRecipientComments:v,getSecretComments:N,addComment:D,isRecipient:M}=Ne(),k=z("recipient"),c=z(""),E=z(!1),B=u(()=>t.wish.created_by_user_id!==t.wish.created_for_user_id),Q=u(()=>M(t.wish));J(()=>{t.focusThread?k.value=t.focusThread:B.value?k.value="secret":Q.value?k.value="recipient":k.value="secret"});const U=u(()=>v(t.wishId)),r=u(()=>N(t.wishId)),o=u(()=>k.value==="recipient"?U.value:r.value),I=u(()=>!B.value),f=u(()=>!Q.value||!I.value),d=u(()=>!!c.value.trim()),w=async()=>{if(!d.value)return;const h=k.value;await D(t.wishId,c.value,h),c.value=""},g=async()=>{if(E.value=!0,await C(t.wishId),$(t.wishId),t.focusCommentId){await ye();const h=document.querySelector(`[data-comment-id="${t.focusCommentId}"]`);h&&(h.classList.add("flash"),h.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>h.classList.remove("flash"),2e3))}E.value=!1};return K(()=>t.wishId,()=>{g()},{immediate:!0}),(h,i)=>(a(),_("div",{class:"wish-comments",onClick:i[12]||(i[12]=m(()=>{},["stop"])),onMousedown:i[13]||(i[13]=m(()=>{},["stop"]))},[!B.value&&!Q.value?(a(),_("div",De,[p(Z,{color:"grey-7",outline:""},{default:L(()=>[H(T(A(s)("wishes.comments.infoHelping")),1)]),_:1})])):S("",!0),!B.value&&!Q.value?(a(),_("div",{key:1,class:"q-mb-sm",onClick:i[1]||(i[1]=m(()=>{},["stop"])),onMousedown:i[2]||(i[2]=m(()=>{},["stop"]))},[p(Be,{modelValue:k.value,"onUpdate:modelValue":i[0]||(i[0]=n=>k.value=n),dense:"",class:"text-grey-7","active-color":"primary","indicator-color":"primary"},{default:L(()=>[p(se,{name:"recipient",label:A(s)("wishes.comments.tabRecipient"),disable:!I.value,count:U.value.length},null,8,["label","disable","count"]),p(se,{name:"secret",label:A(s)("wishes.comments.tabSecret"),disable:!f.value,count:r.value.length},null,8,["label","disable","count"])]),_:1},8,["modelValue"])],32)):Q.value?(a(),_("div",Ae,[p(Z,{color:"primary",outline:""},{default:L(()=>[H(T(A(s)("wishes.comments.visibleToYou")),1)]),_:1})])):(a(),_("div",ze,[p(Z,{color:"purple",outline:""},{default:L(()=>[H(T(A(s)("wishes.comments.secretThread")),1)]),_:1})])),y("div",{class:"comments-list q-mb-sm",onClick:i[3]||(i[3]=m(()=>{},["stop"])),onMousedown:i[4]||(i[4]=m(()=>{},["stop"])),onTouchstart:i[5]||(i[5]=m(()=>{},["stop"]))},[p(Le,{showing:E.value},null,8,["showing"]),o.value.length===0&&!E.value?(a(),_("div",Me,T(A(s)("wishes.comments.empty")),1)):S("",!0),(a(!0),_(Y,null,X(o.value,n=>(a(),_("div",{key:n.id,class:oe(["comment-item q-pa-xs",{highlight:n.id===h.focusCommentId}]),"data-comment-id":n.id},[y("div",We,[y("span",Ue,T(n.author?.username||n.author_id.substring(0,6)),1),y("span",Ge," • "+T(new Date(n.created_at||"").toLocaleString("cs-CZ")),1)]),y("div",Pe,T(n.body),1)],10,Ve))),128))],32),y("div",{class:"row items-end q-gutter-sm",onClick:i[9]||(i[9]=m(()=>{},["stop"])),onMousedown:i[10]||(i[10]=m(()=>{},["stop"])),onTouchstart:i[11]||(i[11]=m(()=>{},["stop"]))},[p(ge,{modelValue:c.value,"onUpdate:modelValue":i[6]||(i[6]=n=>c.value=n),dense:"",autogrow:"",filled:"",class:"col",placeholder:A(s)("wishes.comments.placeholder"),onKeyup:be(m(w,["exact","prevent"]),["enter"]),onClick:i[7]||(i[7]=m(()=>{},["stop"])),onMousedown:i[8]||(i[8]=m(()=>{},["stop"]))},null,8,["modelValue","placeholder","onKeyup"]),p(V,{color:"primary",disable:!d.value,icon:"send",round:"",dense:"",onClick:m(w,["stop"])},null,8,["disable"])],32)],32))}}),Ke=ne(Fe,[["__scopeId","data-v-d0364f48"]]),je={class:"row items-center justify-between"},Oe={class:"text-h6 wish-title"},He={class:"row items-center q-gutter-xs"},Ze={key:0,class:"text-body2 text-grey-7 q-mt-xs preview-text"},Je={key:0,class:"row q-gutter-xs q-mb-md items-center"},Ye={key:1,class:"wish-description q-mb-md"},Xe={class:"text-body2 text-grey-7"},et={key:2,class:"wish-url q-mb-md"},tt={class:"wish-meta"},st={class:"text-caption text-grey-6"},it={key:0},ot={class:"q-px-md q-pb-md"},rt=ie({__name:"WishCard",props:{wish:{},currentUserId:{},expanded:{type:Boolean},highlight:{type:Boolean},refreshKey:{}},emits:["edit","delete","toggleBought","toggleReceived"],setup(l,{emit:t}){const s=l,C=t,$=Te(),{t:v}=re(),{trackClickAndOpen:N}=xe(),D=Se(),M=u(()=>D.query.thread),k=u(()=>D.query.comment),c=z(!1),E=()=>{typeof s.expanded=="boolean"&&(c.value=s.expanded)};J(E),K(()=>s.expanded,()=>E());const B=()=>{c.value=!c.value},Q=u(()=>{switch(s.wish.visibility){case"public":return"green";case"friends":return"blue";case"private":return"grey";default:return"grey"}}),U=u(()=>{switch(s.wish.visibility){case"public":return v("wishes.visibilityPublic");case"friends":return ae.value?v("wishes.form.visibilityFriendsGroups"):v("wishes.visibilityFriends");case"private":return v("wishes.visibilityPrivate");default:return v("common.unknown")}}),r=u(()=>s.wish.created_by_user_id!==s.wish.created_for_user_id&&s.currentUserId!==s.wish.created_for_user_id),o=()=>{const e=s.wish.created_by_user;return e.name&&e.surname?`${e.name} ${e.surname}`:e.name?e.name:e.username?e.username:v("common.unknown")},I=u(()=>s.currentUserId===s.wish.created_by_user_id),f=u(()=>s.currentUserId===s.wish.created_by_user_id),d=u(()=>s.currentUserId!==s.wish.created_for_user_id&&s.currentUserId!==void 0),w=u(()=>s.currentUserId===s.wish.created_for_user_id&&s.currentUserId!==void 0),g=u(()=>s.currentUserId===s.wish.created_by_user_id),{groups:h,fetchGroups:i,fetchWishRules:n}=Ee(),G=z([]),j=z([]),ae=u(()=>G.value.length>0||j.value.length>0),ee=e=>{const q=h.value||[];return e.map(b=>q.find(R=>R.id===b)?.name).filter(b=>!!b)},O=async()=>{if(!g.value||s.wish.visibility!=="friends")return;(!h.value||h.value.length===0)&&await i();const e=await n(s.wish.id);if(!e.error&&e.data){const q=e.data.filter(R=>R.rule_type==="include").map(R=>R.group_id),b=e.data.filter(R=>R.rule_type==="exclude").map(R=>R.group_id);G.value=ee(q),j.value=ee(b)}};K(()=>c.value,e=>{e&&O()}),K(()=>s.refreshKey,()=>{c.value&&O()}),J(()=>{c.value&&O()});const le=e=>new Date(e).toLocaleDateString("cs-CZ"),ue=()=>{$.dialog({title:v("wishes.deleteWish"),message:v("wishes.deleteConfirm"),cancel:!0,persistent:!0}).onOk(()=>{C("delete",s.wish.id)})};return(e,q)=>(a(),x(_e,{class:oe(["wish-card self-start",{"wish-highlight":e.highlight}])},{default:L(()=>[p(te,{class:"wish-card-header",onClick:B},{default:L(()=>[y("div",je,[y("div",Oe,T(e.wish.name),1),y("div",He,[e.wish.is_bought?(a(),x(P,{key:0,color:"green","text-color":"white",label:e.$t("wishes.bought"),size:"sm"},null,8,["label"])):S("",!0),e.wish.is_received?(a(),x(P,{key:1,color:"purple","text-color":"white",label:e.$t("wishes.received"),size:"sm"},null,8,["label"])):S("",!0),p(V,{flat:"",round:"",dense:"",icon:c.value?"expand_less":"expand_more",onClick:m(B,["stop"])},null,8,["icon"])])]),!c.value&&e.wish.description?(a(),_("div",Ze,T(e.wish.description),1)):S("",!0)]),_:1}),p(qe,null,{default:L(()=>[ke(y("div",null,[p(te,{class:"wish-card-details"},{default:L(()=>[g.value?(a(),_("div",Je,[p(P,{color:Q.value,"text-color":"white",label:U.value,size:"sm"},null,8,["color","label"]),(a(!0),_(Y,null,X(G.value,b=>(a(),x(P,{key:`inc-${b}`,color:"green","text-color":"white",label:b,size:"sm"},null,8,["label"]))),128)),(a(!0),_(Y,null,X(j.value,b=>(a(),x(P,{key:`exc-${b}`,color:"red","text-color":"white",label:b,size:"sm"},null,8,["label"]))),128))])):S("",!0),e.wish.description?(a(),_("div",Ye,[y("div",Xe,T(e.wish.description),1)])):S("",!0),e.wish.url?(a(),_("div",et,[p(V,{flat:"",color:"primary",icon:"open_in_new",label:e.$t("wishes.openLink"),size:"sm",onClick:q[0]||(q[0]=m(b=>A(N)(e.wish.url),["stop"]))},null,8,["label"])])):S("",!0),y("div",tt,[y("div",st,[r.value?(a(),_("div",it,T(e.$t("wishes.createdBy",{name:o()})),1)):S("",!0),y("div",null,T(e.wish.created_at?le(e.wish.created_at):"N/A"),1)])])]),_:1}),p($e,{align:"right"},{default:L(()=>[d.value?(a(),x(V,{key:0,color:e.wish.is_bought?"grey":"green",icon:e.wish.is_bought?"shopping_cart":"add_shopping_cart",label:e.wish.is_bought?e.$t("wishes.markAsNotBought"):e.$t("wishes.markAsBought"),flat:"",onClick:q[1]||(q[1]=m(b=>e.$emit("toggleBought",e.wish.id),["stop"]))},null,8,["color","icon","label"])):S("",!0),w.value?(a(),x(V,{key:1,color:e.wish.is_received?"orange":"purple",icon:e.wish.is_received?"undo":"check_circle",label:e.wish.is_received?e.$t("wishes.markAsNotReceived"):e.$t("wishes.markAsReceived"),flat:"",onClick:q[2]||(q[2]=m(b=>e.$emit("toggleReceived",e.wish.id),["stop"]))},null,8,["color","icon","label"])):S("",!0),I.value?(a(),x(V,{key:2,color:"primary",icon:"edit",flat:"",onClick:q[3]||(q[3]=m(b=>e.$emit("edit",e.wish),["stop"]))})):S("",!0),f.value?(a(),x(V,{key:3,color:"negative",icon:"delete",flat:"",onClick:m(ue,["stop"])})):S("",!0)]),_:1}),p(Ie,{class:"q-mx-md q-mt-sm"}),y("div",ot,[p(Ke,{"wish-id":e.wish.id,wish:{id:e.wish.id,created_for_user_id:e.wish.created_for_user_id,created_by_user_id:e.wish.created_by_user_id},"focus-thread":M.value,"focus-comment-id":k.value},null,8,["wish-id","wish","focus-thread","focus-comment-id"])])],512),[[Ce,c.value]])]),_:1})]),_:1},8,["class"]))}}),wt=ne(rt,[["__scopeId","data-v-3d3f695b"]]);export{wt as W};
